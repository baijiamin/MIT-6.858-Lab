# ç‰¹æƒåˆ†ç¦»å’ŒæœåŠ¡å™¨ç«¯æ²™ç®±

æœ¬å®éªŒå°†å‘ä½ ä»‹ç»ç‰¹æƒåˆ†ç¦»å’ŒæœåŠ¡å™¨ç«¯æ²™ç®±æŠ€æœ¯ï¼ŒèƒŒæ™¯æ˜¯åœ¨ä¸€ä¸ªåä¸º zoobar çš„ç®€å• Python Web åº”ç”¨ç¨‹åºä¸­ï¼Œè¯¥åº”ç”¨ç¨‹åºå…è®¸ç”¨æˆ·ä¹‹é—´è½¬ç§»â€œzoobarsâ€ï¼ˆç§¯åˆ†ï¼‰ã€‚ç‰¹æƒåˆ†ç¦»çš„ä¸»è¦ç›®æ ‡æ˜¯ç¡®ä¿å¦‚æœæ”»å‡»è€…æ”»ç ´äº†åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¸ä¼šå—åˆ°å½±å“ã€‚ä¸ºäº†å¸®åŠ©ä½ å¯¹è¯¥åº”ç”¨ç¨‹åºè¿›è¡Œç‰¹æƒåˆ†ç¦»ï¼Œä¸Šä¸€ä¸ªå®éªŒä¸­ä½¿ç”¨çš„ zookws Web æœåŠ¡å™¨æ˜¯è®²åº§ä¸­è®¨è®ºçš„ OKWS Web æœåŠ¡å™¨çš„å…‹éš†ã€‚**åœ¨æœ¬å®éªŒä¸­ï¼Œä½ å°†è®¾ç½®ä¸€ä¸ªç‰¹æƒåˆ†ç¦»çš„ Web æœåŠ¡å™¨ï¼Œæ£€æŸ¥å¯èƒ½å­˜åœ¨çš„æ¼æ´ï¼Œå¹¶å°†åº”ç”¨ç¨‹åºä»£ç æ‹†åˆ†ä¸ºæƒé™è¾ƒä½çš„ç»„ä»¶ï¼Œä»¥å°½é‡å‡å°‘å•ä¸€æ¼æ´çš„å½±å“ã€‚**

æ‚¨è¿˜å°†æ‰©å±• Zoobar ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œä»¥æ”¯æŒå¯æ‰§è¡Œçš„ä¸ªäººèµ„æ–™ï¼Œè¿™å…è®¸ç”¨æˆ·å°† Python ä»£ç ä½œä¸ºä»–ä»¬çš„ä¸ªäººèµ„æ–™ã€‚è¦åˆ›å»ºä¸ªäººèµ„æ–™ï¼Œç”¨æˆ·å°†ä¸€ä¸ª Python ç¨‹åºä¿å­˜åœ¨ä»–ä»¬çš„ Zoobar ä¸»é¡µä¸Šçš„ä¸ªäººèµ„æ–™ä¸­ã€‚ï¼ˆä¸ºäº†è¡¨æ˜è¯¥ä¸ªäººèµ„æ–™åŒ…å« Python ä»£ç ï¼Œç¬¬ä¸€è¡Œå¿…é¡»æ˜¯ #!pythonã€‚ï¼‰æ¯å½“å…¶ä»–ç”¨æˆ·æŸ¥çœ‹è¯¥ç”¨æˆ·çš„ Python ä¸ªäººèµ„æ–™æ—¶ï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œè¯¥ç”¨æˆ·ä¸ªäººèµ„æ–™ä¸­çš„ Python ä»£ç ï¼Œä»¥ç”Ÿæˆç›¸åº”çš„ä¸ªäººèµ„æ–™è¾“å‡ºã€‚è¿™å°†å…è®¸ç”¨æˆ·åœ¨ä¸ªäººèµ„æ–™ä¸­å®ç°å„ç§åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

- ä¸€ä¸ªå¯ä»¥ç”¨è®¿å®¢çš„ç”¨æˆ·åæ‰“æ‹›å‘¼çš„ä¸ªäººèµ„æ–™ã€‚
- ä¸€ä¸ªå¯ä»¥è·Ÿè¸ªæœ€è¿‘å‡ ä¸ªè®¿é—®è¯¥ä¸ªäººèµ„æ–™çš„è®¿å®¢çš„ä¸ªäººèµ„æ–™ã€‚
- ä¸€ä¸ªå¯ä»¥ç»™æ¯ä½è®¿å®¢å‘æ”¾ä¸€ä¸ª zoobarï¼ˆæ¯åˆ†é’Ÿé™ 1 ä¸ªï¼‰çš„ä¸ªäººèµ„æ–™ã€‚

å®‰å…¨åœ°æ”¯æŒè¿™ä¸€åŠŸèƒ½éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå¯¹é…ç½®æ–‡ä»¶ä»£ç è¿›è¡Œæ²™ç®±å¤„ç†ï¼Œä»¥ç¡®ä¿å®ƒä¸èƒ½æ‰§è¡Œä»»æ„æ“ä½œæˆ–è®¿é—®ä»»æ„æ–‡ä»¶ã€‚å¦ä¸€æ–¹é¢ï¼Œè¯¥ä»£ç å¯èƒ½éœ€è¦åœ¨æŸäº›æ–‡ä»¶ä¸­è·Ÿè¸ªæŒä¹…åŒ–æ•°æ®ï¼Œæˆ–è€…è®¿é—®ç°æœ‰çš„ zoobar æ•°æ®åº“ï¼Œä»¥æ­£å¸¸è¿è¡Œã€‚ä½ å°†ä½¿ç”¨ RPC åº“ä»¥åŠæˆ‘ä»¬æä¾›çš„ä¸€äº›é€‚é…ä»£ç æ¥å®‰å…¨åœ°å¯¹å¯æ‰§è¡Œé…ç½®æ–‡ä»¶è¿›è¡Œæ²™ç®±å¤„ç†



# Lab2å‡†å¤‡

## æ£€æŸ¥æ˜¯å¦æœ‰éšè—çš„ .git æ–‡ä»¶å¤¹

bash

```
# æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬éšè—çš„
ls -la | grep "git"
```

è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ Git ä»“åº“çš„æ ¸å¿ƒï¼š

- **`.git`**ï¼šGit ä»“åº“çš„æ‰€æœ‰å…ƒæ•°æ®å’Œå¯¹è±¡å­˜å‚¨åœ¨è¿™é‡Œ
- **`.gitignore`**ï¼šæŒ‡å®šå“ªäº›æ–‡ä»¶ä¸åº”è¯¥è¢« Git è·Ÿè¸ª

## 2. **æ‰€æœ‰æƒé—®é¢˜å¾ˆæ˜æ˜¾**

æ³¨æ„ä¸¤ä¸ªæ–‡ä»¶çš„æ‰€æœ‰è€…éƒ½æ˜¯ **root**ï¼Œè€Œä¸æ˜¯ä½ çš„å½“å‰ç”¨æˆ· **student**ï¼š

- `.git`ï¼šroot:root
- `.gitignore`ï¼šroot:root

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Git ä¼šæŠ¥æ‰€æœ‰æƒé”™è¯¯ï¼Git çš„å®‰å…¨æœºåˆ¶æ£€æµ‹åˆ°ä»“åº“ç›®å½•çš„æ‰€æœ‰æƒä¸å½“å‰ç”¨æˆ·ä¸åŒ¹é…ã€‚

### æ–¹æ¡ˆAï¼šä¿®å¤æ‰€æœ‰æƒï¼ˆæ¨èï¼‰

bash

```
# ä¿®å¤ .git ç›®å½•çš„æ‰€æœ‰æƒ
sudo chown -R student:student .git

# å¦‚æœéœ€è¦ï¼Œä¹Ÿä¿®å¤ .gitignore
sudo chown student:student .gitignore
```

æ–¹æ¡ˆAå¤±è´¥

ä¿®æ”¹äº†æ‰€æœ‰æƒåä»ç„¶æŠ¥é”™ï¼Œæ˜¯å› ä¸º Git çš„å®‰å…¨æ£€æŸ¥æ˜¯åŸºäº**æ•´ä¸ªä»“åº“ç›®å½•**çš„ï¼Œè€Œä¸ä»…ä»…æ˜¯ `.git` æ–‡ä»¶å¤¹ã€‚å³ä½¿ä½ ä¿®æ”¹äº† `.git` çš„æ‰€æœ‰æƒï¼Œä½†ä»“åº“çš„å…¶ä»–æ–‡ä»¶æˆ–çˆ¶ç›®å½•å¯èƒ½ä»ç„¶å±äº rootã€‚

## é—®é¢˜åŸå› åˆ†æï¼š

1. **Git æ£€æŸ¥æ•´ä¸ªå·¥ä½œæ ‘**ï¼šGit çš„å®‰å…¨æ£€æŸ¥ä¸ä»…æ£€æŸ¥ `.git` ç›®å½•ï¼Œè¿˜æ£€æŸ¥æ•´ä¸ªå·¥ä½œç›®å½•æ ‘çš„æ‰€æœ‰æƒä¸€è‡´æ€§ã€‚
2. **ç¼“å­˜é—®é¢˜**ï¼šGit å¯èƒ½ç¼“å­˜äº†ä¹‹å‰çš„æ‰€æœ‰æƒä¿¡æ¯ã€‚
3. **çˆ¶ç›®å½•æƒé™**ï¼š`/home/student/6858` è¿™ä¸ªç›®å½•æœ¬èº«å¯èƒ½è¿˜å±äº rootã€‚

## å®Œæ•´è§£å†³æ–¹æ¡ˆï¼š

### æ­¥éª¤1ï¼šæ·»åŠ å®‰å…¨ç›®å½•åˆ° Git é…ç½®

bash

```
git config --global --add safe.directory /home/student/6858
```



### æ­¥éª¤2ï¼šéªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

bash

```
# æŸ¥çœ‹æ˜¯å¦æ·»åŠ æˆåŠŸ
git config --global --get-all safe.directory | grep 6858
```

è¾“å‡ºï¼š/home/student/6858

**æ·»åŠ æˆåŠŸäº†**ã€‚

## è§£é‡Šè¿™ä¸ªè¾“å‡ºï¼š

### å‘½ä»¤1ï¼š

bash

```
git config --global --add safe.directory /home/student/6858
```



- æˆåŠŸå°† `/home/student/6858` æ·»åŠ åˆ° Git çš„**å®‰å…¨ç›®å½•åˆ—è¡¨**ä¸­ã€‚
- Git ç°åœ¨ä¼š**ä¿¡ä»»**è¿™ä¸ªç›®å½•ï¼Œå³ä½¿æ‰€æœ‰æƒæ£€æŸ¥å¤±è´¥ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚

### å‘½ä»¤2ï¼š

bash

```
git config --global --get-all safe.directory | grep 6858
```



- `git config --global --get-all safe.directory`ï¼šè·å–æ‰€æœ‰å·²é…ç½®çš„å®‰å…¨ç›®å½•
- `| grep 6858`ï¼šåªæ˜¾ç¤ºåŒ…å« "6858" çš„è¡Œ
- è¾“å‡º `/home/student/6858`ï¼šç¡®è®¤ä½ çš„ç›®å½•å·²åœ¨åˆ—è¡¨ä¸­

## è¿™æ„å‘³ç€ï¼š

1. **é…ç½®å·²ç”Ÿæ•ˆ**ï¼šGit å·²ç»å°†ä½ çš„ç›®å½•æ ‡è®°ä¸ºå®‰å…¨
2. **åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ Git äº†**ï¼šç°åœ¨å¯ä»¥å°è¯•æ‰§è¡Œ Git å‘½ä»¤

## æ¥ä¸‹æ¥æµ‹è¯•ï¼š

bash

```
# æµ‹è¯•æ˜¯å¦è¿˜åœ¨ Git ä»“åº“å†…
git rev-parse --is-inside-work-tree

# æŸ¥çœ‹ Git çŠ¶æ€
git status

# æŸ¥çœ‹åˆ†æ”¯ä¿¡æ¯
git branch -a
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\1.png)

å®Œç¾ï¼ç°åœ¨ Git å·²ç»å®Œå…¨æ­£å¸¸å·¥ä½œäº†ã€‚è®©æˆ‘è§£é‡Šä¸€ä¸‹è¿™äº›è¾“å‡ºçš„å«ä¹‰ï¼š

## 1. **Git ä»“åº“çŠ¶æ€ç¡®è®¤**

text

```
git rev-parse --is-inside-work-tree
true
```



- âœ… ç¡®è®¤ä½ ç°åœ¨åœ¨ä¸€ä¸ª Git ä»“åº“ä¸­

## 2. **å½“å‰å·¥ä½œçŠ¶æ€åˆ†æ**

text

```
On branch lab1
Your branch is up to date with 'origin/lab1'.
```



- **å½“å‰åˆ†æ”¯**ï¼š`lab1`ï¼ˆè¿™æ˜¯ Lab1 çš„å®éªŒåˆ†æ”¯ï¼‰
- **ä¸è¿œç¨‹åŒæ­¥**ï¼šä½ çš„æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹ `origin/lab1` ä¿æŒåŒæ­¥ï¼ˆæ²¡æœ‰è½åæˆ–è¶…å‰ï¼‰

## 3. **æ›´æ”¹çŠ¶æ€è¯¦ç»†è¯´æ˜**

### **å·²ä¿®æ”¹ä½†æœªæš‚å­˜çš„æ–‡ä»¶**ï¼š

text

```
Changes not staged for commit:
    modified:   shellcode.s
```



- `shellcode.s` æ–‡ä»¶å·²è¢«ä¿®æ”¹ï¼Œä½†è¿˜æ²¡æœ‰ `git add` æ·»åŠ åˆ°æš‚å­˜åŒº

### **æœªè·Ÿè¸ªçš„æ–°æ–‡ä»¶**ï¼š

text

```
Untracked files:
    .gdb_history
    bin/
    exploit-2.py
    exploit-4.py
    exploit-5.py
    grades.txt
    shellcode.s.original
    test_crash.py
```



- è¿™äº›æ˜¯**æ–°åˆ›å»ºçš„æ–‡ä»¶/æ–‡ä»¶å¤¹**ï¼ŒGit ä¹‹å‰ä»æœªè·Ÿè¸ªè¿‡
- ç‰¹åˆ«æ˜¯ `exploit-*.py` çœ‹èµ·æ¥åƒæ˜¯ä½ çš„æ¼æ´åˆ©ç”¨è„šæœ¬

## 4. **åˆ†æ”¯ä¿¡æ¯**

text

```
* lab1
  remotes/origin/HEAD -> origin/lab1
  remotes/origin/lab1
```



- `* lab1`ï¼šå½“å‰åœ¨ `lab1` åˆ†æ”¯ï¼ˆæ˜Ÿå·è¡¨ç¤ºå½“å‰åˆ†æ”¯ï¼‰
- `remotes/origin/lab1`ï¼šè¿œç¨‹ä»“åº“çš„ `lab1` åˆ†æ”¯
- `remotes/origin/HEAD`ï¼šè¿œç¨‹ä»“åº“çš„é»˜è®¤åˆ†æ”¯æŒ‡å‘ `origin/lab1`

## å¼€å§‹ Lab2 çš„æ­¥éª¤

### æ­¥éª¤1ï¼šæäº¤ Lab1 çš„å·¥ä½œ

é¦–å…ˆï¼Œå»ºè®®ä½ æäº¤å½“å‰ Lab1 çš„æ›´æ”¹ï¼Œä»¥ä¾¿åç»­åˆå¹¶ï¼š

bash

```
# æ·»åŠ ä½ æƒ³è¦æäº¤çš„æ–‡ä»¶ï¼ˆæ ¹æ®ä½ çš„éœ€è¦é€‰æ‹©ï¼‰âˆš
git add exploit-2.py exploit-4.py exploit-5.py shellcode.S

# æˆ–è€…æ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆæ³¨æ„ä¼šåŒ…æ‹¬ .gdb_history ç­‰å¯èƒ½ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
# git add .

# æäº¤æ›´æ”¹
git commit -m "Lab1 è§£å†³æ–¹æ¡ˆï¼šå®Œæˆæ¼æ´åˆ©ç”¨å¼€å‘"
# æ‰§è¡Œè¿™ä¸€è¡ŒåæŠ¥é”™2ï¼Œä¸èƒ½commit
# è¿™æ˜¯ Git çš„å¸¸è§é—®é¢˜ï¼Œå› ä¸ºä½ è¿˜æ²¡æœ‰é…ç½®ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆå§“åå’Œé‚®ç®±ï¼‰ã€‚Git # è¦æ±‚æ¯æ¬¡æäº¤æ—¶è®°å½•æäº¤è€…çš„èº«ä»½ã€‚
# è§£å†³æ–¹æ³•1ï¼šè®¾ç½®å…¨å±€ Git é…ç½®ï¼ˆæ¨èï¼‰
git config --global user.email "student@6858.mit.edu"
git config --global user.name "Student 6858"
# ç»“æœ->3

```

2:

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\2.png)

3:

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\3.png)

**æäº¤æˆåŠŸäº†**ï¼ğŸ‰

#### æäº¤æˆåŠŸä¿¡æ¯è§£è¯»ï¼š

##### 1. **æäº¤ä¿¡æ¯**

text

```
[Lab1 89d974c] Lab1 è§£å†³æ–¹æ¡ˆï¼šå®Œæˆæ¼æ´åˆ©ç”¨å¼€å‘
```



- **åˆ†æ”¯**ï¼š`Lab1` åˆ†æ”¯
- **æäº¤å“ˆå¸Œ**ï¼š`89d974c`ï¼ˆGit çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
- **æäº¤ä¿¡æ¯**ï¼šä½ å†™çš„ "Lab1 è§£å†³æ–¹æ¡ˆï¼šå®Œæˆæ¼æ´åˆ©ç”¨å¼€å‘"

##### 2. **æ›´æ”¹ç»Ÿè®¡**

text

```
4 files changed, 257 insertions(+), 3 deletions(-)
```



- 4ä¸ªæ–‡ä»¶è¢«æ›´æ”¹
- å¢åŠ äº†257è¡Œä»£ç 
- åˆ é™¤äº†3è¡Œä»£ç 

##### 3. **åˆ›å»ºçš„æ–‡ä»¶**

text

```
create mode 100755 exploit-2.py
create mode 100755 exploit-4.py
create mode 100755 exploit-5.py
```



- åˆ›å»ºäº†3ä¸ªæ–°æ–‡ä»¶ï¼Œæƒé™ä¸º `100755`ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
- æ³¨æ„ï¼š`shellcode.S` æ²¡æœ‰è¢«æäº¤ï¼Œå› ä¸ºä½ ä¹‹å‰è¾“å…¥çš„æ˜¯ `shellcode.5`ï¼ˆå¯èƒ½æ˜¯æ‹¼å†™é”™è¯¯ï¼‰

## æ£€æŸ¥å½“å‰çŠ¶æ€ï¼š

```
# æŸ¥çœ‹æäº¤å†å²
git log --oneline -3

# æŸ¥çœ‹å½“å‰çŠ¶æ€
git status

# æŸ¥çœ‹å“ªäº›æ–‡ä»¶è¢«æäº¤äº†
git show --name-only HEAD
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\4.png)

### å½“å‰çŠ¶æ€è¯¦ç»†è§£é‡Šï¼š

#### 1. **æäº¤å†å²**

text

```
89d974c (HEAD -> lab1) Lab1 è§£å†³æ–¹æ¡ˆï¼šå®Œæˆæ¼æ´åˆ©ç”¨å¼€å‘
d5e1ce9 (origin/lab1, origin/HEAD) Initial code for lab 1
```



- **ç¬¬ä¸€è¡Œ**ï¼šä½ çš„æœ€æ–°æäº¤ï¼ˆ`89d974c`ï¼‰ï¼Œåœ¨ `lab1` åˆ†æ”¯
- **ç¬¬äºŒè¡Œ**ï¼šè¿œç¨‹ä»“åº“çš„åˆå§‹ä»£ç æäº¤ï¼Œè¿™æ˜¯ Lab1 çš„èµ·ç‚¹
- ä½ çš„æœ¬åœ° `lab1` åˆ†æ”¯æ¯”è¿œç¨‹è¶…å‰ 1 ä¸ªæäº¤

#### 2. **Git çŠ¶æ€**

text

```
On branch lab1
Your branch is ahead of 'origin/lab1' by 1 commit.
(use "git push" to publish your local commits)
```



- ä½ åœ¨ `lab1` åˆ†æ”¯
- ä½ çš„æœ¬åœ°åˆ†æ”¯é¢†å…ˆè¿œç¨‹åˆ†æ”¯ 1 ä¸ªæäº¤
- æç¤ºä½ å¯ä»¥ `git push` æ¨é€åˆ°è¿œç¨‹ï¼ˆä½†è¿™ä¸æ˜¯å¿…é¡»çš„ï¼‰

text

```
Untracked files:
  .gdb_history
  bin/
  grades.txt
  shellcode.S.original
  test_crash.py
```



- è¿™äº›æ˜¯**æœªè·Ÿè¸ªçš„æ–‡ä»¶**ï¼ˆGit è¿˜æ²¡æœ‰ç®¡ç†å®ƒä»¬ï¼‰
- å¤§å¤šæ˜¯æµ‹è¯•æ–‡ä»¶ã€ç¼–è¯‘äº§ç‰©ç­‰ï¼Œå¯èƒ½ä¸éœ€è¦æäº¤

#### 3. **æœ€æ–°æäº¤è¯¦æƒ…**

text

```
commit 89d974cddca0c84af9d475355a7d9322a2aac9d4 (HEAD -> lab1)
Author: Student 6858 <student@6858.mit.edu>
Date:   Tue Dec 9 06:23:52 2025 -0500

Lab1 è§£å†³æ–¹æ¡ˆï¼šå®Œæˆæ¼æ´åˆ©ç”¨å¼€å‘

exploit-2.py
exploit-4.py
exploit-5.py
shellcode.S
```



- æ˜¾ç¤ºäº†å®Œæ•´çš„æäº¤ä¿¡æ¯
- **é‡è¦å‘ç°**ï¼š`shellcode.S` å®é™…ä¸Šå·²ç»è¢«æäº¤äº†ï¼Git è‡ªåŠ¨ä¿®æ­£äº†ä½ çš„æ‹¼å†™é”™è¯¯ï¼ˆ`shellcode.5` â†’ `shellcode.S`ï¼‰

# æ­£å¼å¼€å§‹Lab2

## æ­¥éª¤1ï¼šåˆ‡æ¢åˆ° Lab2 åˆ†æ”¯

bash

```
# æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆç¡®ä¿æœ‰ lab2 åˆ†æ”¯ï¼‰
git pull

# åˆ‡æ¢åˆ° lab2 åˆ†æ”¯ï¼ˆä»è¿œç¨‹åˆ›å»ºï¼‰
git checkout -b lab2 origin/lab2
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\5.png)

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\6.png)

## æ­¥éª¤2ï¼šåˆå¹¶ Lab1 çš„å·¥ä½œ

bash

```
# å°† lab1 çš„æ›´æ”¹åˆå¹¶åˆ° lab2
git merge lab1
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\7.png)

è¿™æ˜¯ **Git çš„åˆå¹¶æäº¤ç¼–è¾‘å™¨**ã€‚ä½ æ‰§è¡Œäº† `git merge lab1` åï¼ŒGit éœ€è¦ä½ ä¸ºè¿™æ¬¡åˆå¹¶æ“ä½œæä¾›ä¸€ä¸ªæäº¤ä¿¡æ¯ã€‚è¿™æ˜¯å®Œå…¨æ­£å¸¸çš„ã€‚

### å½“å‰æƒ…å†µè¯´æ˜ï¼š

- ä½ æ­£åœ¨ä½¿ç”¨ **nano æ–‡æœ¬ç¼–è¾‘å™¨** ç¼–è¾‘åˆå¹¶æäº¤ä¿¡æ¯
- é»˜è®¤ä¿¡æ¯æ˜¯ï¼š`Merge branch 'lab1' into lab2`
- ä½ å¯ä»¥ä¿®æ”¹è¿™ä¸ªä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨é»˜è®¤çš„

#### å¦‚ä½•æ“ä½œ nano ç¼–è¾‘å™¨ï¼š

##### **ä¿å­˜å¹¶é€€å‡ºï¼ˆå®Œæˆåˆå¹¶ï¼‰**ï¼š

1. æŒ‰ **`Ctrl + O`**ï¼ˆæŒ‰ä½ Ctrl é”®ï¼Œå†æŒ‰ Oï¼‰
2. æŒ‰ **`Enter`**ï¼ˆå›è½¦é”®ï¼‰ç¡®è®¤ä¿å­˜
3. æŒ‰ **`Ctrl + X`** é€€å‡ºç¼–è¾‘å™¨

##### **æŸ¥çœ‹å¯ç”¨çš„å¿«æ·é”®**ï¼š

- ç¼–è¾‘å™¨åº•éƒ¨æ˜¾ç¤ºäº†ä¸€äº›å¿«æ·é”®ï¼š
  - `^O` è¡¨ç¤º `Ctrl+O`ï¼ˆå†™æ–‡ä»¶/ä¿å­˜ï¼‰
  - `^X` è¡¨ç¤º `Ctrl+X`ï¼ˆé€€å‡ºï¼‰

##### **å…¶ä»–å¸¸ç”¨ nano å‘½ä»¤**ï¼š

- `Ctrl+G`ï¼šæ˜¾ç¤ºå¸®åŠ©
- `Ctrl+K`ï¼šå‰ªåˆ‡å½“å‰è¡Œ
- `Ctrl+U`ï¼šç²˜è´´
- `Ctrl+W`ï¼šæŸ¥æ‰¾
- `Ctrl+C`ï¼šå–æ¶ˆæ“ä½œï¼ˆå›åˆ°ç»ˆç«¯ï¼‰

#### å»ºè®®æ“ä½œï¼š

ç”±äºè¿™æ˜¯æ ‡å‡†çš„åˆå¹¶æ“ä½œï¼Œæˆ‘å»ºè®®ä½ ï¼š

1. **ç›´æ¥ä½¿ç”¨é»˜è®¤æäº¤ä¿¡æ¯**ï¼ˆå·²ç»å¡«å¥½çš„ `Merge branch 'lab1' into lab2`ï¼‰
2. **ä¿å­˜å¹¶é€€å‡º**ï¼š
   - æŒ‰ **`Ctrl+O`**ï¼Œç„¶åæŒ‰ **`Enter`**
   - å†æŒ‰ **`Ctrl+X`**

#### æ“ä½œæ­¥éª¤ï¼š

text

```
1. æŒ‰ Ctrl + O  (ä¿å­˜)
2. æŒ‰ Enter     (ç¡®è®¤æ–‡ä»¶å)
3. æŒ‰ Ctrl + X  (é€€å‡º)
```



##### å¦‚æœæƒ³å–æ¶ˆåˆå¹¶ï¼ˆä¸æ¨èï¼Œä½†å¯ä»¥ï¼‰ï¼š

1. æŒ‰ `Ctrl+C` é€€å‡ºç¼–è¾‘å™¨
2. ç„¶åæ‰§è¡Œï¼š`git merge --abort`

#### âˆš ç°åœ¨è¯·æ‰§è¡Œï¼š

ç›´æ¥æŒ‰ï¼š

text

```
Ctrl + O
Enter
Ctrl + X
```



ç„¶åå‘Šè¯‰æˆ‘ç»“æœã€‚åˆå¹¶å®Œæˆåï¼Œä½ å°±å¯ä»¥ç»§ç»­ Lab2 çš„å®éªŒäº†ã€‚

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\8.png)

å¾ˆå¥½ï¼**åˆå¹¶æˆåŠŸäº†**ï¼è™½ç„¶ç»ˆç«¯æ˜¾ç¤ºæœ‰äº›ä¹±ç ï¼Œä½†å…³é”®ä¿¡æ¯æ˜¯ï¼š`Merge made by the â€˜recursiveâ€™ strategy.`ï¼ˆåˆå¹¶å·²ä½¿ç”¨é€’å½’ç­–ç•¥å®Œæˆï¼‰ã€‚

### åˆå¹¶ç»“æœè§£é‡Šï¼š

1. **åˆå¹¶æˆåŠŸ**ï¼š`lab1` åˆ†æ”¯çš„æ›´æ”¹å·²ç»åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ï¼ˆ`lab2`ï¼‰
2. **åˆå¹¶äº†4ä¸ªæ–‡ä»¶**ï¼š`exploit-2.py`ã€`exploit-4.py`ã€`exploit-5.py`ã€`shellcode.S`
3. **ç»Ÿè®¡ä¿¡æ¯**ï¼š257å¤„æ›´æ”¹ï¼Œ3å¤„åˆ é™¤
4. **åˆ›å»ºäº†3ä¸ªæ–°æ–‡ä»¶**ï¼šæ¨¡å¼ä¸ºå¯æ‰§è¡Œï¼ˆ`100755`ï¼‰

## æ­¥éª¤3ï¼šè¿›è¡Œ Lab2 çš„ç¯å¢ƒè®¾ç½®ï¼š

### ç›´æ¥å°è¯•ç¼–è¯‘ï¼ˆè·³è¿‡è¡¥ä¸ï¼‰

bash

```
# ç›´æ¥ç¼–è¯‘ï¼Œçœ‹çœ‹æ˜¯å¦æ­£å¸¸å·¥ä½œ
make

# å¦‚æœç¼–è¯‘æˆåŠŸï¼Œç»§ç»­è®¾ç½®
sudo make setup
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\9.png)





### æ­¥éª¤2ï¼šä¿®æ”¹è„šæœ¬ä»¥ä½¿ç”¨ Python 3.9

#### æ–¹æ¡ˆ1ï¼šç²¾ç¡®ä¿®æ”¹ï¼ˆæ¨èï¼‰

bash

```
# å¤‡ä»½åŸå§‹è„šæœ¬
cp chroot-setup.sh chroot-setup.sh.backup

# 1. ä¿®æ”¹ /usr/bin/python2 -> /usr/bin/python3
sed -i 's|/usr/bin/python2|/usr/bin/python3|g' chroot-setup.sh

# 2. ä¿®æ”¹ /usr/lib/python2.7 -> /usr/lib/python3.9
sed -i 's|/usr/lib/python2.7|/usr/lib/python3.9|g' chroot-setup.sh

# 3. ä¿®æ”¹ /usr/local/lib/python2.7 -> /usr/local/lib/python3.9
sed -i 's|/usr/local/lib/python2.7|/usr/local/lib/python3.9|g' chroot-setup.sh

# 4. æŸ¥çœ‹ä¿®æ”¹ç»“æœ
grep -n "python" chroot-setup.sh

# 5. ä¿®å¤å¯èƒ½çš„å…¶ä»–é—®é¢˜ï¼ˆresolvconfï¼‰
# æ£€æŸ¥æ˜¯å¦æœ‰è¿™è¡Œï¼Œå¦‚æœæœ‰åˆ™æ³¨é‡Šæ‰
sed -i 's|cp -r /lib/resolvconf /jail/lib|# &|g' chroot-setup.sh
```

### **Lab2 ç¯å¢ƒè®¾ç½®é”™è¯¯æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ**

#### **é˜¶æ®µä¸€ï¼šåˆå§‹é”™è¯¯**

**å‘½ä»¤**: `sudo make setup`
**é”™è¯¯ä¿¡æ¯**:

text

```
Error: /usr/bin/python2 not executable
```



**æ ¹æœ¬åŸå› **: 2022 ç‰ˆå®éªŒç¯å¢ƒå·²è¿ç§»åˆ° Python 3ï¼Œä½†è„šæœ¬ä»å¼•ç”¨ Python 2 è·¯å¾„

#### **é˜¶æ®µäºŒï¼šä¾èµ–é—®é¢˜**

**é”™è¯¯ä¿¡æ¯**:

text

```
cp: cannot stat '/lib/resolvconf': No such file or directory
cp: cannot stat '/usr/local/lib/python2.7': No such file or directory
```



**åŸå› **: æ–°ç‰ˆæœ¬ç³»ç»Ÿä¸­æŸäº›æ–‡ä»¶è·¯å¾„å·²æ”¹å˜æˆ–ä¸å­˜åœ¨

#### **é˜¶æ®µä¸‰ï¼šPython å‘½ä»¤ç¼ºå¤±**

**é”™è¯¯ä¿¡æ¯**:

text

```
./chroot-setup.sh: 70: python: not found
```



**åŸå› **: ç³»ç»Ÿä¸­åªæœ‰ `python3` å‘½ä»¤ï¼Œæ²¡æœ‰ `python` å‘½ä»¤

------

#### ğŸ”§ **è¯¦ç»†è§£å†³æ–¹æ¡ˆ**

##### **æ­¥éª¤1ï¼šç¡®è®¤ Python ç¯å¢ƒ**

bash

```
# æ£€æŸ¥ Python ç‰ˆæœ¬
python3 --version  # è¾“å‡º: Python 3.9.7

# æ£€æŸ¥å…³é”®è·¯å¾„
ls -d /usr/lib/python3.9 /usr/local/lib/python3.9
```



##### **æ­¥éª¤2ï¼šä¿®æ”¹ chroot-setup.sh è„šæœ¬**

bash

```
# å¤‡ä»½åŸå§‹è„šæœ¬
cp chroot-setup.sh chroot-setup.sh.backup

# ä¿®æ”¹æ‰€æœ‰ Python 2 å¼•ç”¨ä¸º Python 3
sed -i 's|/usr/bin/python2|/usr/bin/python3|g' chroot-setup.sh
sed -i 's|/usr/lib/python2.7|/usr/lib/python3.9|g' chroot-setup.sh
sed -i 's|/usr/local/lib/python2.7|/usr/local/lib/python3.9|g' chroot-setup.sh

# ä¿®æ­£æ‹¼å†™é”™è¯¯
sed -i 's|/jail/zobbar/|/jail/zoobar/|g' chroot-setup.sh

# æ³¨é‡Šæ‰ä¸å­˜åœ¨çš„è·¯å¾„
sed -i 's|cp -r /lib/resolvconf /jail/lib|# &|g' chroot-setup.sh

# å°† python å‘½ä»¤æ”¹ä¸ºå®Œæ•´è·¯å¾„
sed -i '70,71s|python|/usr/bin/python3|g' chroot-setup.sh
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\10.png)

è¿˜æ²¡æœ‰æ”¹ï¼š

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\11.png)

ä¿®æ”¹äº†36ã€42ã€49

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\12.png)

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\13.png)

ä¿®æ”¹70ã€71

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\14.png)

##### **æ­¥éª¤3ï¼šéªŒè¯ä¿®æ”¹ç»“æœ**

bash

```
# æŸ¥çœ‹ä¿®æ”¹åçš„è„šæœ¬
grep -n -E "python|zoobar|resolvconf" chroot-setup.sh
```



**æœŸæœ›è¾“å‡º**:

text

```
36:./chroot-copy.sh /usr/bin/python3 /jail
42:cp -r /usr/lib/python3.9 /jail/usr/lib
46:# cp -r /lib/resolvconf /jail/lib
49:cp -r /usr/local/lib/python3.9 /jail/usr/local/lib
67:cp -r zoobar /jail/
68:rm -rf /jail/zoobar/db
70:/usr/bin/python3 /jail/zoobar/zoodb.py init-person
71:/usr/bin/python3 /jail/zoobar/zoodb.py init-transfer
```



##### **æ­¥éª¤4ï¼šé‡æ–°è¿è¡Œè®¾ç½®**

bash

```
sudo make setup
```



zookconf

```
#!/usr/bin/env python3

import os
from pathlib import Path
import re
import subprocess
import sys
import readconf
import ipaddress
import collections
import time
import lxc

#
# Make and start containers
#

HOME = "/home/student/"
BASE = "base"

def init_dns():
    os.unlink('/etc/resolv.conf')
    with open("/etc/resolv.conf", "w") as fd:
        fd.write("nameserver 8.8.8.8\n")

def save_hostname(name):
    def f():
        with open("/etc/hostname", "w") as fd:
            fd.write("%s\n" % name)
    return f

def link_to_hostaddr(link):
    return '10.1.%s.4' % link

def link_to_subnet(link):
    return '10.1.%s.0/24' % link

def info(c):
    r = ""
    if c.running:
        ps = subprocess.Popen(["lxc-attach", "-n", c.name, "--", "ps", "-v"],
                              stdout=subprocess.PIPE).communicate()[0]
        ps = ps.decode('utf-8')
        ps = ps.split('\n')
        pat = re.compile(r'ps -v|/sbin/agetty')
        for p in ps:
            if pat.search(p):
                continue
            if p == '':
                continue
            r += "\n" + p
    ipv4 = "unknown"
    try:
        ipv4 = c.get_config_item('lxc.net.0.ipv4.address')
    except KeyError:
        pass
    return "%s: %s, IP %s%s\n" % (c.name, c.state, ipv4, r)

class Container():
    def __init__(self, conf, name, svcs, globalconf):
        self.c = lxc.Container(name)
        self.conf = conf
        self.name = name
        self.svcs = svcs
        self.globalconf = globalconf

        if name == "base" or name == "~base":
            return

        if not self.c.defined:
            self.make_container()

        if not self.c.start():
            self.errormsg("Failed to start the container")
            sys.exit(1)

        self.configure_fw()

        self.infomsg("Copying files")
        self.dup_dir(".", excludes=["./zoobar/db"])

    def errormsg(self, msg):
        print("%s: ERROR: %s" % (self.name, msg))

    def infomsg(self, msg):
        print("%s: %s" % (self.name, msg))

    def configure_fw(self):
        rules = self.conf.lookup('fwrule')
        if rules is None:
            return
        if not isinstance(rules, list):
            rules = [rules]
        for r in rules:
            self.configure_fw_rule(r)

    def configure_fw_rule(self, r_orig):
        r = r_orig.split(' ')
        for index, item in enumerate(r):
            if self.globalconf.isservice(item):
                r[index] = link_to_subnet(self.globalconf.lookup(item, 'lxcbr'))
            if ',' in item:
                i = item.split(',')
                for index1, item1 in enumerate(i):
                    if self.globalconf.isservice(item1):
                        i[index1] = link_to_subnet(self.globalconf.lookup(item1, 'lxcbr'))
                i = ",".join(i)
                r[index] = i
        res = self.run_cmd(["/sbin/iptables", "-A", "INPUT"] + r)
        if res != 0:
            self.errormsg("Failed to configure firewall rule %s" % r_orig)

    def make_base(self):
        os.makedirs('%s/.local/share/lxc' % HOME, exist_ok=True)
        self.infomsg("Creating container")
        if not self.c.create("local", 0,
                        { "fstree":   "/usr/local/6858/lxcbase/rootfs.tar.xz",
                          "metadata": "/usr/local/6858/lxcbase/meta.tar.xz" }):
            self.errormsg("Could not download initial container image")
            sys.exit(1)

        ## Base container gets a special network setup
        self.configure_network('0')

        self.infomsg("Configuring")
        self.configure_base()

    def configure_base(self):
        if not self.c.start():
            self.errormsg("Failed to start")
            sys.exit(1)

        # wait for systemd to boot up
        while True:
            r = self.run_cmd(["bash", "-c", "systemctl is-system-running 2>/dev/null | egrep -q '(degraded|running)'"])
            if r == 0:
                break
            time.sleep(1)

        # LXC brings up the container's network interface on its own
        for svc in ['systemd-resolved', 'networkd-dispatcher', 'systemd-networkd']:
            for op in ['disable', 'mask', 'stop']:
                self.run_cmd(["systemctl", op, svc])

        self.attach_wait(init_dns)

        # shut down and re-start the container to get the networking up
        if not self.c.stop():
            self.errormsg("Failed to stop")
            sys.exit(1)
        if not self.c.start():
            self.errormsg("Failed to start")
            sys.exit(1)

        pkgs = ["python3", "python3-lxc",
                "python3-flask-sqlalchemy", "python3-cryptography",
                "psmisc", "iputils-ping", "iptables",
                ]

        # update path to include sbin so that apt install will work
        path = "/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/snap/bin:/usr/local/sbin:/sbin:/usr/sbin"
        ev = ["PATH=%s" % path]
        # æ–°å¢ï¼šæ›¿æ¢APTæºä¸ºUbuntuæ—§ç‰ˆæœ¬å½’æ¡£æºï¼ˆè§£å†³impishæºå¤±æ•ˆé—®é¢˜ï¼‰
        self.infomsg("Replacing outdated APT sources with old-releases.ubuntu.com")
        # 1. å¤‡ä»½åŸsources.listï¼ˆå¯é€‰ä½†æ¨èï¼‰
        self.run_cmd(["cp", "/etc/apt/sources.list", "/etc/apt/sources.list.bak"], extra_env_vars=ev)
# 2. æ›¿æ¢æ‰€æœ‰æºä¸ºold-releasesï¼ˆsedå‘½ä»¤åœ¨å®¹å™¨å†…æ‰§è¡Œï¼‰
        replace_cmd = [
    "sed", "-i", 
    "s/archive.ubuntu.com/old-releases.ubuntu.com/g; s/security.ubuntu.com/old-releases.ubuntu.com/g", 
    "/etc/apt/sources.list"
        ]
        r = self.run_cmd(replace_cmd, extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed to replace APT sources")
            sys.exit(1)
        # install packages for zoobar
        # terminate early if anything goes wrong here
        r = self.run_cmd(["apt-get", "update"], extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed updating apt package info")
            sys.exit(1)
        r = self.run_cmd(["apt-get", "install", "-y"] + pkgs, extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed installing packages")
            sys.exit(1)

        # directory for zook
        self.run_cmd(["mkdir", HOME])

        if not self.c.stop():
            self.errormsg("Failed to stop")

    def configure_network(self, link):
        ipv4 = link_to_hostaddr(link)
        addr = ipaddress.ip_address(ipv4)
        self.c.set_config_item('lxc.net.0.type', 'veth')
        self.c.set_config_item('lxc.net.0.link', 'lxcbr%s' % link)
        self.c.set_config_item('lxc.net.0.flags', 'up')
        self.c.set_config_item('lxc.net.0.hwaddr', '68:58:%02x:%02x:%02x:%02x' % tuple(addr.packed))
        self.c.set_config_item('lxc.net.0.ipv4.address', '%s/24' % ipv4)
        self.c.set_config_item('lxc.net.0.ipv4.gateway', 'auto')
        self.c.save_config()

    def make_container(self):
        b = lxc.Container(BASE)
        if not b.defined:
            bc = Container(None, "~base", None, self.globalconf)

            # If this container is defined it's probably partially configured,
            # so we destroy and recreate it
            if bc.c.defined:
                if not destroy_container(bc.c):
                    self.errormsg("Failed to shut down container. Try rebooting your VM.")
                    sys.exit(1)

                bc = Container(None, "~base", None, self.globalconf)

            bc.make_base()

            b = bc.c.rename(BASE)
            if not b:
                self.errormsg("Rename failed")
                sys.exit(1)

        self.infomsg("Creating container")
        c = b.clone(self.name, bdevtype="overlayfs", flags=lxc.LXC_CLONE_SNAPSHOT)
        if not c:
            self.errormsg("Clone failed")
            sys.exit(1)

        self.c = c
        self.configure_network(self.conf.lookup('lxcbr'))

        self.c.start()
        self.attach_wait(save_hostname(self.name))
        if not self.c.stop():
            self.errormsg("Failed to stop")

    def zooksvc(self, k):
        self.infomsg("Running zooksvc.py")
        self.run_cmd(["%s/zooksvc.py" % HOME, k])

    def attach_wait(self, *args, **kwargs):
        filter = subprocess.Popen(["sed", "-e", "s,^,%s: ," % self.name], stdin=subprocess.PIPE, stdout=sys.stderr)
        return self.c.attach_wait(*args, stdout=filter.stdin, stderr=filter.stdin, **kwargs)

    def run_cmd(self, cmd, extra_env_vars=[]):
        with open('/dev/null') as f:
            return self.attach_wait(lxc.attach_run_command, cmd, stdin=f, extra_env_vars=extra_env_vars)

    def copy_file(self, d, name):
        p1 = subprocess.Popen(["tar", "-c", "-C", d, name], stdout=subprocess.PIPE)
        p2 = subprocess.Popen(['lxc-attach', '-n', self.name, '--', 'tar', 'xf', '-', "-C", HOME], stdin=p1.stdout)
        p2.wait()

    def dup_dir(self, host_dir, excludes=[]):
        exclude_args = []
        for e in excludes:
            exclude_args.append('--exclude=%s' % e)
        p1 = subprocess.Popen(["tar"] + exclude_args + ["-c", host_dir], stdout=subprocess.PIPE)
        p2 = subprocess.Popen(['lxc-attach', '-n', self.name, '--', 'tar', 'xf', '-', "-C", HOME], stdin=p1.stdout)
        p2.wait()

def destroy_container(c, timeout=10):
    c.shutdown(timeout=0)

    # sometimes shutdown takes a bit, and the container needs to be stopped for
    # destroy to work, so wait
    start = time.time()
    while c.running:
        # if the container's in a broken state it can remain running even after
        # a supposedly successful shutdown call, so return False after a bit
        if time.time() - start > timeout:
            return False
        time.sleep(0.1)

    c.destroy()
    return True

def boot(k=None):
    ct = readconf.read_conf()
    # check for link dups
    svcs_on_link = collections.defaultdict(list)
    for s in ct.svcs():
        link = ct.lookup(s, 'lxcbr')
        if link is None:
            raise Exception("Missing lxcbr link for container %s" % s)
        if link not in [str(i) for i in range(0, 10)]:
            raise Exception("Unknown lxcbr link %s for container %s" % (link, s))
        svcs_on_link[link].append(s)
    for link in svcs_on_link:
        if len(svcs_on_link[link]) > 1:
            raise Exception("More than one container on lxcbr%s: %s" % (link, svcs_on_link[link]))
    if k == None:
        for k in ct.svcs():
            c = Container(ct.conf(k), k, ct.svcs(), ct)
            c.zooksvc(k)
    else:
        c = Container(ct.conf(k), k, ct.svcs(), ct)
        c.zooksvc(k)

def shutdown(k=None):
    ct = readconf.read_conf()
    if k == None:
        for k in ct.svcs():
            c = lxc.Container(k)
            c.stop()
    else:
        c = lxc.Container(k)
        c.stop()

def clean(k=None):
    shutdown(k)
    ct = readconf.read_conf()
    if k == None:
        for k in ct.svcs():
            c = lxc.Container(k)
            destroy_container(c)
        for k in lxc.list_containers():
            c = lxc.Container(k)
            destroy_container(c)
        c = lxc.Container(BASE)
        destroy_container(c)
    else:
        c = lxc.Container(k)
        c.destroy()

def ps(k=None):
    ct = readconf.read_conf()
    if k == None:
        for k in sorted(ct.svcs()):
            c = lxc.Container(k)
            print(info(c))
    else:
        c = lxc.Container(k)
        print(info(c))

def restart_with_cgroups():
    ## This gunk is needed to deal with cgroup2; systemd by default gives each
    ## session scope a leaf cgroups node.
    ## See also https://linuxcontainers.org/lxc/getting-started/
    envkey = 'SYSTEMD_DELEGATE_RESTART'
    if envkey in os.environ:
        return
    os.environ[envkey] = 'yes'
    os.execv('/usr/bin/systemd-run',
            ['systemd-run', '--user', '--scope', '--quiet', '--property', 'Delegate=yes', '--'] +
            sys.argv)

```

zook.conf

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = zookfs

[zookfs]
    cmd = zookfs
    url = .*
    dir = /home/student/
    lxcbr = 1
    port = 8081
    ## Filter rules are inserted in the order they appear in this file.
    ## Thus, in the below example (commented out initially) the first
    ## filters applied are the ACCEPT ones, and then the REJECT one.
    ## Use `iptables -nvL INPUT' on the appropriate container to see all
    ## the filters that are in effect on that container.
    # fwrule = -s main -j ACCEPT
    # fwrule = -s echo -j ACCEPT
    # fwrule = -j REJECT

[echo]
    cmd = /zoobar/echo-server.py
    dir = /home/student
    lxcbr = 2
    port = 8081

```

zoobarä¸‹é¢æ–°å»ºecho-server.py

```
#!/usr/bin/env python3
import sys
import socket
import threading

def handle_client(client_socket, client_address):
    """å¤„ç†å®¢æˆ·ç«¯è¿æ¥"""
    try:
        while True:
            data = client_socket.recv(1024)
            if not data:
                break
            client_socket.send(data)
    finally:
        client_socket.close()

def main():
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 8081
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind(('0.0.0.0', port))
    server.listen(5)
    print(f"Echo server listening on port {port}", file=sys.stderr)
    
    try:
        while True:
            client_socket, client_address = server.accept()
            client_thread = threading.Thread(
                target=handle_client,
                args=(client_socket, client_address)
            )
            client_thread.daemon = True
            client_thread.start()
    except KeyboardInterrupt:
        pass
    finally:
        server.close()

if __name__ == '__main__':
    main()

```

### 6.858 å®éªŒç¯å¢ƒæ­å»ºé—®é¢˜æ€»ç»“

#### 1. åˆå§‹ç¯å¢ƒé…ç½®é—®é¢˜âŒæ²¡è®°å½•è¿™ä¸ªï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯AIæç¤ºæ‰§è¡Œçš„ï¼ŒæŒ‡å¯¼ä¹¦ä¸Šé¢æ²¡æœ‰ï¼ŒæŒ‡å¯¼ä¹¦ç›´æ¥æ‰§è¡Œ./zookld.py

##### **é”™è¯¯ç°è±¡**ï¼š

æ‰§è¡Œ `sudo make setup` æ—¶å¤±è´¥ï¼ˆå…·ä½“é”™è¯¯ä¿¡æ¯æœªè®°å½•ï¼Œä½†å¯èƒ½æ˜¯ä¾èµ–åŒ…å®‰è£…é—®é¢˜ï¼‰



##### **è§£å†³æ–¹æ¡ˆ**ï¼š

ç”±äºå®éªŒè™šæ‹Ÿæœºå·²ç»é¢„é…ç½®äº†å¤§éƒ¨åˆ†ç¯å¢ƒï¼Œç›´æ¥è·³è¿‡ `sudo make setup`ï¼Œå°è¯•ç›´æ¥å¯åŠ¨æœåŠ¡ã€‚

#### 2. å®¹å™¨ç½‘ç»œå†²çªé”™è¯¯

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\15.png)

##### **é”™è¯¯ä¿¡æ¯**ï¼š

text

```
Traceback (most recent call last):
  File "/home/student/6858/./zookld.py", line 19, in <module>
    main()
  File "/home/student/6858/./zookld.py", line 11, in main
    zookconf.boot()
  File "/home/student/6858/zookconf.py", line 294, in boot
    raise Exception("More than one container on lxcbr%s: %s" % (link, svcs_on_link[link]))
Exception: More than one container on lxcbr0: ['main', 'zookfs', 'echo']
```



##### **é—®é¢˜åˆ†æ**ï¼š

åœ¨ `zook.conf` é…ç½®æ–‡ä»¶ä¸­ï¼Œä¸‰ä¸ªå®¹å™¨ï¼ˆmain, zookfs, echoï¼‰éƒ½è¢«é…ç½®åœ¨åŒä¸€ä¸ªç½‘ç»œæ¥å£ `lxcbr0` ä¸Šï¼Œä½†ä»£ç è¦æ±‚æ¯ä¸ªç½‘ç»œæ¥å£åªèƒ½æœ‰ä¸€ä¸ªå®¹å™¨ã€‚

##### **æ ¹æœ¬åŸå› **ï¼š

åŸå§‹ `zook.conf` æ–‡ä»¶ï¼š

ini

```
[main]
    lxcbr = 0
[zookfs]
    lxcbr = 0  # å†²çªï¼
[echo]
    lxcbr = 0  # å†²çªï¼
```



##### **è§£å†³æ–¹æ¡ˆ**ï¼š

ä¿®æ”¹ `zook.conf`ï¼Œä¸ºæ¯ä¸ªå®¹å™¨åˆ†é…ä¸åŒçš„ç½‘ç»œæ¥å£ï¼š

ini

```
[main]
    lxcbr = 0  # å¯¹åº” 10.1.0.0/24
[zookfs]
    lxcbr = 1  # å¯¹åº” 10.1.1.0/24
[echo]
    lxcbr = 2  # å¯¹åº” 10.1.2.0/24
```

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = zookfs

[zookfs]
    cmd = zookfs
    url = .*
    dir = /home/student/
    lxcbr = 1
    port = 8081
    ## Filter rules are inserted in the order they appear in this file.
    ## Thus, in the below example (commented out initially) the first
    ## filters applied are the ACCEPT ones, and then the REJECT one.
    ## Use `iptables -nvL INPUT' on the appropriate container to see all
    ## the filters that are in effect on that container.
    # fwrule = -s main -j ACCEPT
    # fwrule = -s echo -j ACCEPT
    # fwrule = -j REJECT

[echo]
    cmd = /zoobar/echo-server.py
    dir = /home/student
    lxcbr = 2
    port = 8081

```



#### 3. ç¼ºå¤± `echo-server.py` æ–‡ä»¶

##### **é”™è¯¯ä¿¡æ¯**ï¼š

text

```
echo: Traceback (most recent call last):
echo:   File "/home/student//zooksvc.py", line 85, in <module>
echo:     main()
echo:   File "/home/student//zooksvc.py", line 82, in main
echo:     start(sys.argv[1])
echo:   File "/home/student//zooksvc.py", line 30, in start
echo:     p = clone(ct.conf(k))
echo:   File "/home/student//zooksvc.py", line 54, in clone
echo:     p = subprocess.Popen(args, cwd=d, close_fds=False)
echo:   File "/usr/lib/python3.9/subprocess.py", line 951, in __init__
echo:     self._execute_child(args, executable, preexec_fn, close_fds,
echo:   File "/usr/lib/python3.9/subprocess.py", line 1821, in _execute_child
echo:     raise child_exception_type(errno_num, err_msg, err_filename)
echo: FileNotFoundError: [Errno 2] No such file or directory: './/zoobar/echo-server.py'
```

![16](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\16.png)

![17](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\17.png)

![18](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\18.png)

![19](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\19.png)

![20](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\20.png)

![21](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\21.png)

![22](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\22.png)

![23](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\23.png)



##### **é—®é¢˜åˆ†æ**ï¼š

`/home/student/zoobar/echo-server.py` æ–‡ä»¶ä¸å­˜åœ¨ã€‚

##### **éªŒè¯**ï¼š

bash

```
ls -la /home/student/zoobar/echo-server.py
# è¾“å‡ºï¼šNo such file or directory
```



##### **è§£å†³æ–¹æ¡ˆ**ï¼š

åˆ›å»º `echo-server.py` æ–‡ä»¶ï¼š

bash

```
# åˆ›å»ºæ–‡ä»¶
sudo touch /home/student/6858/zoobar/echo-server.py

# å†™å…¥å†…å®¹ï¼ˆå›æ˜¾æœåŠ¡å™¨ä»£ç ï¼‰
sudo cat > /home/student/6858/zoobar/echo-server.py << 'EOF'
#!/usr/bin/env python3
import sys
import socket
import threading

def handle_client(client_socket, client_address):
    try:
        while True:
            data = client_socket.recv(1024)
            if not data:
                break
            client_socket.send(data)
    finally:
        client_socket.close()

def main():
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 8081
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind(('0.0.0.0', port))
    server.listen(5)
    print(f"Echo server listening on port {port}", file=sys.stderr)
    
    try:
        while True:
            client_socket, client_address = server.accept()
            client_thread = threading.Thread(
                target=handle_client,
                args=(client_socket, client_address)
            )
            client_thread.daemon = True
            client_thread.start()
    except KeyboardInterrupt:
        pass
    finally:
        server.close()

if __name__ == '__main__':
    main()
EOF

# è®¾ç½®æƒé™
sudo chown student:student /home/student/6858/zoobar/echo-server.py
sudo chmod +x /home/student/6858/zoobar/echo-server.py
```



#### 4. VS Code æƒé™é”™è¯¯ï¼šecho-server.pyæ— æ³•å†™å…¥ä¿å­˜

##### **é”™è¯¯ä¿¡æ¯**ï¼š

text

```
æ— æ³•å†™å…¥æ–‡ä»¶"vscode-remote://ssh-remote+6.858-lab-vm/home/student/6858/zoobar/echo-server.py"(NoPermissions (FileSystemError): Error: EACCES: permission denied, open '/home/student/6858/zoobar/echo-server.py')
```

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\24.png)

![](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\25.png)



##### **é—®é¢˜åˆ†æ**ï¼š

`zoobar` ç›®å½•å¯èƒ½å±äº root ç”¨æˆ·ï¼Œstudent ç”¨æˆ·æ²¡æœ‰å†™å…¥æƒé™ã€‚

##### **è§£å†³æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨ç»ˆç«¯å‘½ä»¤åˆ›å»ºæ–‡ä»¶ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ï¼Œæˆ–ä¿®å¤ç›®å½•æƒé™ï¼š

bash

```
sudo chown -R student:student /home/student/6858/zoobar/
```



![26](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\26.png)



![27](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\27.png)

![28](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\28.png)

![29](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\29.png)



#### 5. æ— æ³•é€šè¿‡ localhost:8080 è®¿é—®

![30](D:\Users\DELL\Documents\è¯¾ç¨‹\ç ”ä¸€ä¸Š\ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨\å®éªŒ\å®éªŒ2\å®éªŒè¿‡ç¨‹æˆªå›¾\30.png)

##### **é”™è¯¯ç°è±¡**ï¼š

bash

```
curl http://localhost:8080/
# è¾“å‡ºï¼šcurl: (7) Failed to connect to localhost port 8080: Connection refused
```

```
http://192.168.153.131:8888/zoobar/index.cgi/
```



##### **é—®é¢˜åˆ†æ**ï¼š

- æœåŠ¡è¿è¡Œåœ¨å®¹å™¨å†…éƒ¨ï¼ˆIP: `10.1.0.4:8080`ï¼‰
- ä¸»æœº localhost ä¸Šæ²¡æœ‰æœåŠ¡ç›‘å¬ 8080 ç«¯å£
- éœ€è¦ç«¯å£è½¬å‘æˆ–ç›´æ¥ä½¿ç”¨å®¹å™¨ IP è®¿é—®

##### **éªŒè¯æœåŠ¡çŠ¶æ€**ï¼š

bash

```
./zookps.py
# è¾“å‡ºæ˜¾ç¤ºä¸‰ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œï¼š
# echo: RUNNING, IP 10.1.2.4/24
# main: RUNNING, IP 10.1.0.4/24  
# zookfs: RUNNING, IP 10.1.1.4/24
```



##### **è§£å†³æ–¹æ¡ˆ**ï¼š

###### **æ–¹æ³• 1ï¼šç›´æ¥ä½¿ç”¨å®¹å™¨ IP**ï¼ˆåœ¨è™šæ‹Ÿæœºå†…ï¼‰

bash

```
curl http://10.1.0.4:8080/
# æˆ–è®¿é—® http://10.1.0.4:8080/ åœ¨æµè§ˆå™¨ä¸­
```



###### **æ–¹æ³• 2ï¼šè®¾ç½®ç«¯å£è½¬å‘**

bash

```
# ä½¿ç”¨ socat ç®€å•è½¬å‘
sudo socat TCP-LISTEN:8080,fork TCP:10.1.0.4:8080 &

# æˆ–ä½¿ç”¨ iptables
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 10.1.0.4:8080
```



###### **å®é™…è§£å†³æ–¹æ¡ˆ**ï¼š

é€šè¿‡è™šæ‹Ÿæœºç½‘ç»œé…ç½®ï¼ˆVirtualBoxç«¯å£è½¬å‘ï¼‰ï¼š

- å®¿ä¸»æœºç«¯å£ï¼š8888 â†’ è™šæ‹Ÿæœºç«¯å£ï¼š8080
- è®¿é—®åœ°å€ï¼š`http://<è™šæ‹ŸæœºIP>:8888/zoobar/index.cgi/`
- æˆåŠŸæ˜¾ç¤º Zoobar ç™»å½•é¡µé¢

#### 6. æœ€ç»ˆæˆåŠŸçŠ¶æ€

##### **éªŒè¯å‘½ä»¤**ï¼š

bash

```
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
./zookps.py
# è¾“å‡ºï¼šä¸‰ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡ŒçŠ¶æ€

# 2. æµ‹è¯• echo æœåŠ¡
echo "test" | nc 10.1.2.4 8081
# è¾“å‡ºï¼štestï¼ˆå›æ˜¾æˆåŠŸï¼‰

# 3. è®¿é—® Web æœåŠ¡
curl http://192.168.153.131:8888/zoobar/index.cgi/
# è¾“å‡ºï¼šZoobar ç™»å½•é¡µé¢ HTML
```



##### **æˆåŠŸæ ‡å¿—**ï¼š

1. âœ… ä¸‰ä¸ªå®¹å™¨å…¨éƒ¨æ­£å¸¸è¿è¡Œ
2. âœ… ç½‘ç»œéš”ç¦»é…ç½®æ­£ç¡®ï¼ˆæ¯ä¸ªå®¹å™¨åœ¨ä¸åŒç½‘æ®µï¼‰
3. âœ… æœåŠ¡é—´é€šä¿¡æ­£å¸¸ï¼ˆmain â†” zookfsï¼‰
4. âœ… Web æœåŠ¡å¯è®¿é—®ï¼ˆæ˜¾ç¤ºç™»å½•é¡µé¢ï¼‰
5. âœ… Echo æœåŠ¡æ­£å¸¸å·¥ä½œ

#### 7. å…³é”®é…ç½®æ€»ç»“

##### **ä¿®æ”¹çš„æ–‡ä»¶**ï¼š

1. **`zook.conf`** - ç½‘ç»œæ¥å£åˆ†é…

   ini

   ```
   main:    lxcbr = 0
   zookfs:  lxcbr = 1
   echo:    lxcbr = 2
   ```

   

2. **`echo-server.py`** - æ–°å»ºçš„å›æ˜¾æœåŠ¡å™¨

   bash

   ```
   /home/student/6858/zoobar/echo-server.py
   ```

   

3. **VirtualBox ç½‘ç»œè®¾ç½®**ï¼ˆå¯é€‰ï¼‰

   - ç«¯å£è½¬å‘ï¼šå®¿ä¸»æœº 8888 â†’ è™šæ‹Ÿæœº 8080

##### **æ¸…ç†å’Œé‡å¯å‘½ä»¤**ï¼š

bash

```
# æ¸…ç†ç¯å¢ƒ
sudo ./zookclean.py

# å¯åŠ¨æœåŠ¡
./zookld.py

# æŸ¥çœ‹çŠ¶æ€
./zookps.py
```

ç°åœ¨ç¯å¢ƒå·²å®Œå…¨é…ç½®å¥½ï¼Œå¯ä»¥è¿›è¡Œåç»­çš„ 6.858 å®‰å…¨å®éªŒäº†ã€‚



# ç»ƒä¹ ä¸€æŒ‡å¯¼ï¼šæ¢ç´¢ Zoobar åº”ç”¨

## ç»ƒä¹ ä¸€ä»»åŠ¡æ¦‚è¿°

åœ¨ç»ƒä¹ ä¸€ä¸­ï¼Œä½ çš„ä¸»è¦ä»»åŠ¡æ˜¯ï¼š

1. **ç†Ÿæ‚‰ Zoobar åº”ç”¨çš„åŸºæœ¬åŠŸèƒ½**
2. **ç†è§£åº”ç”¨ç¨‹åºæ¶æ„**
3. **è¯†åˆ«æ½œåœ¨çš„å®‰å…¨é—®é¢˜**
4. **è¿è¡Œç®€å•çš„æµ‹è¯•æ”»å‡»**

è¿™ä¸ªç»ƒä¹ æ˜¯åç»­å®éªŒçš„åŸºç¡€ï¼Œå¸®åŠ©ä½ ç†è§£åº”ç”¨ç¨‹åºçš„å·¥ä½œåŸç†å’Œå®‰å…¨æ¼æ´çš„èƒŒæ™¯ã€‚

## å…·ä½“ä»»åŠ¡åˆ†è§£

### ä»»åŠ¡ 1ï¼šæ¢ç´¢ Zoobar åº”ç”¨åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. è®¿é—® Zoobar åº”ç”¨ï¼š`http://192.168.153.131:8888/zoobar/index.cgi/`

2. æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼š`alice`ï¼Œå¯†ç  `alice`ï¼‰

   `bob`,`bob`

3. ç™»å½•å¹¶æ¢ç´¢åŠŸèƒ½ï¼š

   - æŸ¥çœ‹ä¸ªäººèµ„æ–™é¡µé¢
   - å°è¯•è½¬è´¦åŠŸèƒ½ï¼ˆè½¬åˆ°å¦ä¸€ä¸ªç”¨æˆ·ï¼‰
   - æŸ¥çœ‹ zoobar ä½™é¢
   - æŸ¥çœ‹äº¤æ˜“å†å²

**è®°å½•è§‚å¯Ÿ**ï¼š

- åº”ç”¨ç¨‹åºæœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ
- æ•°æ®å¦‚ä½•æµåŠ¨ï¼Ÿ
- ç”¨æˆ·ç•Œé¢å¦‚ä½•å·¥ä½œï¼Ÿ

### ä»»åŠ¡ 2ï¼šç†è§£åº”ç”¨ç¨‹åºæ¶æ„

**æ­¥éª¤**ï¼š

1. æŸ¥çœ‹æºä»£ç ç»“æ„ï¼š

   bash

   ```
   cd /home/student/6858/zoobar
   ls -la
   ```

   

2. æŸ¥çœ‹ä¸»è¦æ–‡ä»¶ï¼š

   - `index.cgi` - ä¸»å…¥å£ç‚¹
   - `index.py` - Python ä»£ç 
   - `bank.py` - é“¶è¡Œ/è½¬è´¦é€»è¾‘
   - `auth.py` - è®¤è¯é€»è¾‘
   - `zoodb.py` - æ•°æ®åº“æ¥å£
   - `users.py` - ç”¨æˆ·ç®¡ç†

**è®°å½•è§‚å¯Ÿ**ï¼š

- åº”ç”¨ç¨‹åºå¦‚ä½•ç»„ç»‡ï¼Ÿ
- å„ä¸ªæ¨¡å—çš„èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ
- æ•°æ®å¦‚ä½•å­˜å‚¨å’Œæ£€ç´¢ï¼Ÿ

### ä»»åŠ¡ 3ï¼šåˆ†ææ•°æ®åº“ç»“æ„

**æ­¥éª¤**ï¼š

1. æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶ï¼š

   bash

   ```
   ls -la /home/student/6858/zoobar/db/
   ```

   

2. æŸ¥çœ‹æ•°æ®åº“æ¨¡å¼ï¼ˆschemaï¼‰ï¼š

   bash

   ```
   # è¿›å…¥ main å®¹å™¨
   sudo lxc-attach -n main
   # åœ¨å®¹å™¨å†…æŸ¥çœ‹æ•°æ®åº“
   cd /home/student/zoobar
   python3 -c "import zoodb; import pprint; db = zoodb.ZooDatabase(); pprint.pprint(db._tables)"
   exit
   ```

   

**è®°å½•è§‚å¯Ÿ**ï¼š

- æœ‰å“ªäº›æ•°æ®è¡¨ï¼Ÿ
- è¡¨ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ
- å¦‚ä½•å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ï¼Ÿ

### ä»»åŠ¡ 4ï¼šè¯†åˆ«æ½œåœ¨å®‰å…¨é—®é¢˜

**æ­¥éª¤**ï¼š

1. æŸ¥çœ‹å…³é”®ä»£ç ä¸­çš„æ½œåœ¨é—®é¢˜ï¼š

   bash

   ```
   # æŸ¥çœ‹è®¤è¯ä»£ç 
   cat /home/student/6858/zoobar/auth.py
   
   # æŸ¥çœ‹è½¬è´¦ä»£ç 
   cat /home/student/6858/zoobar/bank.py
   
   # æŸ¥çœ‹ç”¨æˆ·è¾“å…¥å¤„ç†
   grep -n "input\|request\|form" /home/student/6858/zoobar/*.py
   ```

   

2. å°è¯•ç®€å•çš„æµ‹è¯•ï¼š

   - è¾“å…¥ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `<script>`, `' OR 1=1 --`ï¼‰
   - å°è¯•è´Ÿæ•°è½¬è´¦
   - å°è¯•è½¬è´¦ç»™ä¸å­˜åœ¨çš„ç”¨æˆ·

**è®°å½•è§‚å¯Ÿ**ï¼š

- åº”ç”¨ç¨‹åºå¦‚ä½•éªŒè¯è¾“å…¥ï¼Ÿ
- é”™è¯¯å¤„ç†æ˜¯å¦å……åˆ†ï¼Ÿ
- æ˜¯å¦æœ‰æ˜æ˜¾çš„æ³¨å…¥æ¼æ´ï¼Ÿ

### ä»»åŠ¡ 5ï¼šè¿è¡Œæä¾›çš„æµ‹è¯•è„šæœ¬

**æ­¥éª¤**ï¼š

1. æŸ¥çœ‹ç»ƒä¹ ä¸€çš„ç›¸å…³è„šæœ¬ï¼š

   bash

   ```
   cd /home/student/6858
   ls -la exercise*.py 2>/dev/null || ls -la ex*.py 2>/dev/null
   ```

   

2. å¦‚æœæœ‰ç»ƒä¹ ä¸€è„šæœ¬ï¼Œè¿è¡Œå®ƒï¼š

   bash

   ```
   # ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ exercise1.py
   python3 exercise1.py
   ```

   

3. æŒ‰ç…§å®éªŒæŒ‡å¯¼ä¸­çš„å…·ä½“è¯´æ˜æ“ä½œã€‚

## å®é™…æ“ä½œæ–¹æ³•

### 1. é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ³¨å†Œä¸¤ä¸ªç”¨æˆ·ï¼š

- ç”¨æˆ· 1ï¼š`alice` (å¯†ç : `password123`)
- ç”¨æˆ· 2ï¼š`bob` (å¯†ç : `password123`)

è¿™æ ·ä½ å¯ä»¥æµ‹è¯•è½¬è´¦åŠŸèƒ½ã€‚

### 2. æ¢ç´¢è½¬è´¦åŠŸèƒ½ï¼š

1. ä»¥ `alice` ç™»å½•
2. ç»™ `bob` è½¬è´¦ 5 zoobar
3. æ£€æŸ¥åŒæ–¹ä½™é¢å˜åŒ–

### 3. æŸ¥çœ‹æºä»£ç ä¸­çš„è½¬è´¦é€»è¾‘ï¼š

bash

```
cd /home/student/6858/zoobar
cat bank.py
```



æ³¨æ„çœ‹ `transfer` å‡½æ•°å¦‚ä½•å¤„ç†è½¬è´¦é€»è¾‘ã€‚

### 4. æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼š

bash

```
# å¯ä»¥å°è¯•åœ¨ç»ˆç«¯ä¸­ç›´æ¥ä¸åº”ç”¨ç¨‹åºäº¤äº’
curl -v "http://192.168.153.131:8888/zoobar/index.cgi/"
```



## è®°å½•ä½ çš„å‘ç°

åˆ›å»ºä¸€ä¸ªå®éªŒè®°å½•æ–‡ä»¶ï¼š

bash

```
cd /home/student/6858
cat > exercise1_notes.txt << 'EOF'
ç»ƒä¹ ä¸€è®°å½•
==========

1. åº”ç”¨åŠŸèƒ½ï¼š
   - ç”¨æˆ·æ³¨å†Œ/ç™»å½•
   - zoobarè½¬è´¦
   - ä¸ªäººèµ„æ–™æŸ¥çœ‹

2. æ¶æ„ç†è§£ï¼š
   - Webå‰ç«¯ï¼šindex.cgi + Python
   - æ•°æ®åº“ï¼šSQLiteï¼ˆzoobar/db/ï¼‰
   - å®¹å™¨æ¶æ„ï¼šmain, zookfs, echo

3. æ½œåœ¨å®‰å…¨é—®é¢˜ï¼š
   - è¾“å…¥éªŒè¯ï¼šTODO
   - ä¼šè¯ç®¡ç†ï¼šTODO
   - æ•°æ®åº“æŸ¥è¯¢ï¼šTODO

4. æµ‹è¯•ç»“æœï¼š
   - ç‰¹æ®Šå­—ç¬¦è¾“å…¥ï¼šTODO
   - è´Ÿæ•°è½¬è´¦ï¼šTODO
   - SQLæ³¨å…¥æµ‹è¯•ï¼šTODO
EOF
```



## å…³é”®é—®é¢˜æ€è€ƒ

åœ¨æ¢ç´¢è¿‡ç¨‹ä¸­ï¼Œæ€è€ƒä»¥ä¸‹é—®é¢˜ï¼š

1. **è®¤è¯æœºåˆ¶**ï¼šç”¨æˆ·å¦‚ä½•è®¤è¯ï¼Ÿä¼šè¯å¦‚ä½•ç®¡ç†ï¼Ÿ
2. **æˆæƒæœºåˆ¶**ï¼šè°å¯ä»¥æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Ÿ
3. **è¾“å…¥éªŒè¯**ï¼šç”¨æˆ·è¾“å…¥å¦‚ä½•éªŒè¯ï¼Ÿ
4. **é”™è¯¯å¤„ç†**ï¼šé”™è¯¯å¦‚ä½•æŠ¥å‘Šç»™ç”¨æˆ·ï¼Ÿ
5. **æ•°æ®å®Œæ•´æ€§**ï¼šå¦‚ä½•ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

## å¼€å§‹è¡ŒåŠ¨

è¯·å…ˆå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼Œç„¶åå‘Šè¯‰æˆ‘ä½ çš„å‘ç°ï¼š

1. **æ³¨å†Œä¸¤ä¸ªç”¨æˆ·**å¹¶æµ‹è¯•è½¬è´¦åŠŸèƒ½
2. **æŸ¥çœ‹è‡³å°‘ä¸¤ä¸ªæºä»£ç æ–‡ä»¶**ï¼ˆå¦‚ `bank.py` å’Œ `auth.py`ï¼‰
3. **å°è¯•ä¸€ä¸ªç®€å•çš„æµ‹è¯•**ï¼ˆå¦‚è¾“å…¥ç‰¹æ®Šå­—ç¬¦ï¼‰

å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥è®¨è®ºä½ çš„å‘ç°ï¼Œç„¶åç»§ç»­æ›´æ·±å…¥çš„æµ‹è¯•ã€‚

**æç¤º**ï¼šç»ƒä¹ ä¸€ä¸»è¦æ˜¯ç†Ÿæ‚‰ç¯å¢ƒï¼Œä¸è¦æ‹…å¿ƒæ‰¾ä¸åˆ°æ‰€æœ‰æ¼æ´ã€‚é‡ç‚¹æ˜¯ç†è§£åº”ç”¨ç¨‹åºçš„å·¥ä½œåŸç†ã€‚



# é€è¡Œåˆ†æ Zoobar æ ¸å¿ƒæºä»£ç 

## 1. `index.cgi` - åº”ç”¨å…¥å£ç‚¹

```python
#!/usr/bin/env python3
# Shebang è¡Œï¼šæŒ‡å®šä½¿ç”¨ Python 3 è§£é‡Šå™¨

from wsgiref.handlers import CGIHandler
# å¯¼å…¥ Python æ ‡å‡†åº“çš„ CGI å¤„ç†å™¨ï¼Œç”¨äºå°† CGI è¯·æ±‚è½¬æ¢ä¸º WSGI åº”ç”¨

from __init__ import *
# ä» __init__.py å¯¼å…¥æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬ Flask åº”ç”¨å®ä¾‹ `app`ï¼‰

if __name__ == "__main__":
    # å¦‚æœæ˜¯ç›´æ¥è¿è¡Œæ­¤è„šæœ¬ï¼ˆè€Œä¸æ˜¯ä½œä¸ºæ¨¡å—å¯¼å…¥ï¼‰
    CGIHandler().run(app)
    # ä½¿ç”¨ CGI å¤„ç†å™¨è¿è¡Œ Flask åº”ç”¨
```

**å…³é”®ç†è§£**ï¼šè¿™æ˜¯ä¸€ä¸ª CGI å…¥å£è„šæœ¬ï¼Œå½“ Web æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ—¶æ‰§è¡Œæ­¤è„šæœ¬ï¼Œç„¶åå°†è¯·æ±‚ä¼ é€’ç»™ Flask åº”ç”¨ã€‚

## 2. `index.py` - ä¸»é¡µæ§åˆ¶å™¨

```python
from flask import g, render_template, request
# ä» Flask å¯¼å…¥ï¼š
# - g: åº”ç”¨ä¸Šä¸‹æ–‡å…¨å±€å˜é‡ï¼Œå­˜å‚¨è¯·æ±‚æœŸé—´çš„æ•°æ®
# - render_template: æ¸²æŸ“ HTML æ¨¡æ¿
# - request: HTTP è¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«è¡¨å•æ•°æ®ã€æŸ¥è¯¢å‚æ•°ç­‰

from login import requirelogin
# å¯¼å…¥è‡ªå®šä¹‰è£…é¥°å™¨ï¼Œè¦æ±‚ç”¨æˆ·ç™»å½•æ‰èƒ½è®¿é—®

from debug import *
# å¯¼å…¥è°ƒè¯•æ¨¡å—ï¼ˆå¯èƒ½åŒ…å«é”™è¯¯å¤„ç†è£…é¥°å™¨ï¼‰

from zoodb import *
# å¯¼å…¥æ•°æ®åº“æ¨¡å—

@catch_err
# è‡ªå®šä¹‰è£…é¥°å™¨ï¼šå¯èƒ½ç”¨äºæ•è·å’Œè®°å½•å¼‚å¸¸

@requirelogin
# è‡ªå®šä¹‰è£…é¥°å™¨ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•åˆ™é‡å®šå‘åˆ°ç™»å½•é¡µ

def index():
    # ä¸»é¡µå¤„ç†å‡½æ•°
    
    if 'profile_update' in request.form:
        # æ£€æŸ¥ HTTP POST è¯·æ±‚ä¸­æ˜¯å¦æœ‰ profile_update å­—æ®µ
        # è¡¨ç¤ºç”¨æˆ·æäº¤äº†ä¸ªäººèµ„æ–™æ›´æ–°è¡¨å•
        
        persondb = person_setup()
        # è·å–æ•°æ®åº“ä¼šè¯ï¼ˆè¿æ¥åˆ° person æ•°æ®åº“ï¼‰
        
        person = persondb.query(Person).get(g.user.person.username)
        # æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ Person è®°å½•
        # g.user æ˜¯ç™»å½•è£…é¥°å™¨è®¾ç½®çš„ï¼ŒåŒ…å«å½“å‰ç”¨æˆ·ä¿¡æ¯
        
        person.profile = request.form['profile_update']
        # æ›´æ–°ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼ˆç›´æ¥ä»è¡¨å•è·å–ï¼Œæ— éªŒè¯ï¼ï¼‰
        
        persondb.commit()
        # æäº¤æ•°æ®åº“æ›´æ”¹

        ## also update the cached version (see login.py)
        g.user.person.profile = person.profile
        # åŒæ—¶æ›´æ–° g å¯¹è±¡ä¸­ç¼“å­˜çš„ä¸ªäººèµ„æ–™
    
    return render_template('index.html')
    # æ¸²æŸ“ index.html æ¨¡æ¿
```

**å®‰å…¨é—®é¢˜**ï¼š
1. **XSS æ¼æ´**ï¼š`person.profile = request.form['profile_update']` ç›´æ¥å­˜å‚¨ç”¨æˆ·è¾“å…¥ï¼Œæ—  HTML è½¬ä¹‰
2. **æ— è¾“å…¥éªŒè¯**ï¼šä¸ªäººèµ„æ–™é•¿åº¦ã€å†…å®¹ç±»å‹æ— ä»»ä½•éªŒè¯

## 3. `bank.py` - é“¶è¡Œ/è½¬è´¦é€»è¾‘

```python
from zoodb import *
from debug import *

import time

def transfer(sender, recipient, zoobars):
    # è½¬è´¦å‡½æ•°
    # å‚æ•°ï¼šsenderï¼ˆå‘é€è€…ç”¨æˆ·åï¼‰ï¼Œrecipientï¼ˆæ¥æ”¶è€…ç”¨æˆ·åï¼‰ï¼Œzoobarsï¼ˆè½¬è´¦é‡‘é¢ï¼‰
    
    persondb = person_setup()
    # è·å– person æ•°æ®åº“ä¼šè¯
    
    senderp = persondb.query(Person).get(sender)
    recipientp = persondb.query(Person).get(recipient)
    # æŸ¥è¯¢å‘é€è€…å’Œæ¥æ”¶è€…çš„ç”¨æˆ·è®°å½•

    sender_balance = senderp.zoobars - zoobars
    recipient_balance = recipientp.zoobars + zoobars
    # è®¡ç®—è½¬è´¦åä½™é¢

    if sender_balance < 0 or recipient_balance < 0:
        raise ValueError()
    # æ£€æŸ¥ä½™é¢æ˜¯å¦å˜ä¸ºè´Ÿæ•°ï¼ˆåªæ£€æŸ¥ç»“æœï¼Œä¸æ£€æŸ¥è¾“å…¥ï¼ï¼‰

    senderp.zoobars = sender_balance
    recipientp.zoobars = recipient_balance
    persondb.commit()
    # æ›´æ–°ä½™é¢å¹¶æäº¤

    transfer = Transfer()
    transfer.sender = sender
    transfer.recipient = recipient
    transfer.amount = zoobars
    transfer.time = time.asctime()
    # åˆ›å»ºè½¬è´¦è®°å½•å¯¹è±¡

    transferdb = transfer_setup()
    transferdb.add(transfer)
    transferdb.commit()
    # å°†è½¬è´¦è®°å½•æ·»åŠ åˆ° transfer æ•°æ®åº“

def balance(username):
    # æŸ¥è¯¢ç”¨æˆ·ä½™é¢
    db = person_setup()
    person = db.query(Person).get(username)
    return person.zoobars

def get_log(username):
    # è·å–ç”¨æˆ·è½¬è´¦è®°å½•
    db = transfer_setup()
    l = db.query(Transfer).filter(or_(Transfer.sender==username,
                                      Transfer.recipient==username))
    # æŸ¥è¯¢ç”¨æˆ·ä½œä¸ºå‘é€è€…æˆ–æ¥æ”¶è€…çš„æ‰€æœ‰è½¬è´¦è®°å½•
    
    r = []
    for t in l:
       r.append({'time': t.time,
                 'sender': t.sender ,
                 'recipient': t.recipient,
                 'amount': t.amount })
    return r
```

**å®‰å…¨é—®é¢˜**ï¼š
1. **è´Ÿæ•°è½¬è´¦å¯èƒ½**ï¼š`transfer` å‡½æ•°åªæ£€æŸ¥è½¬è´¦åä½™é¢æ˜¯å¦ä¸ºè´Ÿï¼Œä½†ä¸æ£€æŸ¥ `zoobars` å‚æ•°æ˜¯å¦ä¸ºè´Ÿæ•°
   - å¦‚æœ `zoobars` ä¸ºè´Ÿæ•°ï¼Œåˆ™å‘é€è€…ä½™é¢å¢åŠ ï¼Œæ¥æ”¶è€…ä½™é¢å‡å°‘
   - è¿™å¯èƒ½å…è®¸ç”¨æˆ·ä»å…¶ä»–è´¦æˆ·"çªƒå–" zoobar
2. **æ— äº‹åŠ¡ä¸€è‡´æ€§**ï¼šä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åº“æ“ä½œï¼ˆæ›´æ–°ä½™é¢å’Œè®°å½•è½¬è´¦ï¼‰æ²¡æœ‰åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
3. **æ— å¹¶å‘æ§åˆ¶**ï¼šå¤šä¸ªå¹¶å‘è½¬è´¦å¯èƒ½å¯¼è‡´ä½™é¢ä¸ä¸€è‡´

## 4. `auth.py` - è®¤è¯é€»è¾‘

```python
from zoodb import *
from debug import *

import hashlib
import random

def newtoken(db, person):
    # ç”Ÿæˆæ–°çš„è®¤è¯ä»¤ç‰Œ
    hashinput = "%s%.10f" % (person.password, random.random())
    # ä½¿ç”¨ç”¨æˆ·å¯†ç  + éšæœºæ•°ç”Ÿæˆä»¤ç‰Œè¾“å…¥
    
    person.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
    # ä½¿ç”¨ MD5 å“ˆå¸Œç”Ÿæˆä»¤ç‰Œï¼ˆMD5 å·²è¢«è¯æ˜ä¸å®‰å…¨ï¼‰
    
    db.commit()
    return person.token

def login(username, password):
    db = person_setup()
    person = db.query(Person).get(username)
    if not person:
        return None
    if person.password == password:
        # æ˜æ–‡æ¯”è¾ƒå¯†ç ï¼
        return newtoken(db, person)
    else:
        return None

def register(username, password):
    db = person_setup()
    person = db.query(Person).get(username)
    if person:
        return None
    newperson = Person()
    newperson.username = username
    newperson.password = password  # æ˜æ–‡å­˜å‚¨å¯†ç ï¼
    db.add(newperson)
    db.commit()
    return newtoken(db, newperson)

def check_token(username, token):
    db = person_setup()
    person = db.query(Person).get(username)
    if person and person.token == token:
        return True
    else:
        return False
```

**å®‰å…¨é—®é¢˜**ï¼š
1. **æ˜æ–‡å¯†ç å­˜å‚¨**ï¼šå¯†ç ä»¥æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
2. **å¼±ä»¤ç‰Œç”Ÿæˆ**ï¼šä½¿ç”¨ MD5ï¼ˆå·²ç ´è§£çš„å“ˆå¸Œç®—æ³•ï¼‰
3. **æ— å¯†ç å¤æ‚åº¦è¦æ±‚**
4. **æ— ç›å€¼å“ˆå¸Œ**ï¼šä»¤ç‰Œç”Ÿæˆä»…ä½¿ç”¨å¯†ç å’Œéšæœºæ•°ï¼Œæ— ç›å€¼

## 5. `zoodb.py` - æ•°æ®åº“å±‚

```python
from sqlalchemy import *
from sqlalchemy.orm import *
from sqlalchemy.ext.declarative import *
import os
from debug import *

PersonBase = declarative_base()
TransferBase = declarative_base()
# åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®åº“åŸºç±»

class Person(PersonBase):
    __tablename__ = "person"
    username = Column(String(128), primary_key=True)
    password = Column(String(128))      # å¯†ç å­—æ®µï¼ˆæ˜æ–‡ï¼ï¼‰
    token = Column(String(128))         # è®¤è¯ä»¤ç‰Œ
    zoobars = Column(Integer, nullable=False, default=10)
    profile = Column(String(5000), nullable=False, default="")
    # ä¸ªäººèµ„æ–™å­—æ®µï¼Œé•¿åº¦å¯è¾¾ 5000 å­—ç¬¦

class Transfer(TransferBase):
    __tablename__ = "transfer"
    id = Column(Integer, primary_key=True)
    sender = Column(String(128))
    recipient = Column(String(128))
    amount = Column(Integer)
    time = Column(String)  # å­˜å‚¨ä¸ºå­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ—¥æœŸæ—¶é—´ç±»å‹

def dbsetup(name, base):
    # æ•°æ®åº“è®¾ç½®å‡½æ•°
    thisdir = os.path.dirname(os.path.abspath(__file__))
    dbdir   = os.path.join(thisdir, "db", name)
    if not os.path.exists(dbdir):
        os.makedirs(dbdir)

    dbfile  = os.path.join(dbdir, "%s.db" % name)
    engine  = create_engine('sqlite:///%s' % dbfile,
                            isolation_level='SERIALIZABLE')
    # ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œéš”ç¦»çº§åˆ«ä¸º SERIALIZABLEï¼ˆæœ€é«˜çº§åˆ«ï¼‰
    
    base.metadata.create_all(engine)
    session = sessionmaker(bind=engine)
    return session()

def person_setup():
    return dbsetup("person", PersonBase)

def transfer_setup():
    return dbsetup("transfer", TransferBase)

# å‘½ä»¤è¡Œåˆå§‹åŒ–è„šæœ¬
import sys
if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: %s [init-person|init-transfer]" % sys.argv[0])
        exit(1)

    cmd = sys.argv[1]
    if cmd == 'init-person':
        person_setup()
    elif cmd == 'init-transfer':
        transfer_setup()
    else:
        raise Exception("unknown command %s" % cmd)
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š
1. **ä¸¤ä¸ªç‹¬ç«‹æ•°æ®åº“**ï¼šperson å’Œ transfer ä½¿ç”¨ä¸åŒçš„ SQLite æ•°æ®åº“æ–‡ä»¶
2. **SERIALIZABLE éš”ç¦»çº§åˆ«**ï¼šç¡®ä¿äº‹åŠ¡å®Œå…¨ä¸²è¡ŒåŒ–
3. **æ— å¯†ç å“ˆå¸Œ**ï¼šå¯†ç å­—æ®µç›´æ¥å­˜å‚¨æ˜æ–‡

## 6. `users.py` - ç”¨æˆ·èµ„æ–™æŸ¥çœ‹

```python
from flask import g, render_template, request, Markup
# å¯¼å…¥ Markupï¼šæ ‡è®°å­—ç¬¦ä¸²ä¸ºå®‰å…¨ HTMLï¼ˆä¸è½¬ä¹‰ï¼‰

from login import requirelogin
from zoodb import *
from debug import *
import bank

@catch_err
@requirelogin
def users():
    args = {}  # ä¼ é€’ç»™æ¨¡æ¿çš„å‚æ•°å­—å…¸
    
    args['req_user'] = Markup(request.args.get('user', ''))
    # è·å–æŸ¥è¯¢å‚æ•°ä¸­çš„ç”¨æˆ·åå­—ï¼Œæ ‡è®°ä¸ºå®‰å…¨ HTML
    # è¿™å¯èƒ½å¯¼è‡´åå°„å‹ XSSï¼
    
    if 'user' in request.values:
        # æ£€æŸ¥æ˜¯å¦æœ‰ user å‚æ•°ï¼ˆGET æˆ– POSTï¼‰
        
        persondb = person_setup()
        user = persondb.query(Person).get(request.values['user'])
        # æŸ¥è¯¢æŒ‡å®šç”¨æˆ·
        
        if user: 
            p = user.profile
            p_markup = Markup("<b>%s</b>" % p)
            # å°†ç”¨æˆ·ä¸ªäººèµ„æ–™åŒ…è£¹åœ¨ <b> æ ‡ç­¾ä¸­ï¼Œæ ‡è®°ä¸ºå®‰å…¨
            # è¿™æ˜¯å­˜å‚¨å‹ XSS çš„å…¥å£ï¼
            
            args['profile'] = p_markup
            args['user'] = user
            args['user_zoobars'] = bank.balance(user.username)
            args['transfers'] = bank.get_log(user.username)
        else:
            args['warning'] = "Cannot find that user."
    
    return render_template('users.html', **args)
```

**ä¸¥é‡å®‰å…¨é—®é¢˜**ï¼š
1. **å­˜å‚¨å‹ XSS**ï¼š`Markup("<b>%s</b>" % p)` ç›´æ¥å°†ç”¨æˆ·æ§åˆ¶çš„ä¸ªäººèµ„æ–™åŒ…è£…åœ¨ HTML æ ‡ç­¾ä¸­å¹¶æ ‡è®°ä¸ºå®‰å…¨
2. **åå°„å‹ XSS**ï¼š`args['req_user'] = Markup(request.args.get('user', ''))` ç›´æ¥å°†æŸ¥è¯¢å‚æ•°æ ‡è®°ä¸ºå®‰å…¨
3. **æ— è¾“å…¥æ¸…ç†**ï¼šç”¨æˆ·è¾“å…¥ç›´æ¥æ’å…¥ HTML

## æ€»ç»“å‘ç°çš„å®‰å…¨æ¼æ´

### 1. **è·¨ç«™è„šæœ¬ (XSS)**
   - å­˜å‚¨å‹ï¼šç”¨æˆ·ä¸ªäººèµ„æ–™æœªè½¬ä¹‰ç›´æ¥æ˜¾ç¤º
   - åå°„å‹ï¼šURL å‚æ•°æœªè½¬ä¹‰ç›´æ¥æ˜¾ç¤º

### 2. **è®¤è¯ä¸ä¼šè¯ç®¡ç†**
   - æ˜æ–‡å¯†ç å­˜å‚¨
   - å¼±ä»¤ç‰Œç”Ÿæˆï¼ˆMD5ï¼‰
   - æ— ç›å€¼å“ˆå¸Œ

### 3. **ä¸šåŠ¡é€»è¾‘æ¼æ´**
   - å¯èƒ½çš„è´Ÿæ•°è½¬è´¦æ”»å‡»
   - æ— å¹¶å‘æ§åˆ¶
   - æ•°æ®åº“äº‹åŠ¡ä¸ä¸€è‡´

### 4. **è¾“å…¥éªŒè¯ç¼ºå¤±**
   - ä¸ªäººèµ„æ–™é•¿åº¦æ— é™åˆ¶ï¼ˆ5000å­—ç¬¦ï¼Œä½†æ— æœåŠ¡å™¨ç«¯éªŒè¯ï¼‰
   - è½¬è´¦é‡‘é¢æ— èŒƒå›´æ£€æŸ¥

## å®éªŒè®°å½•å»ºè®®

åœ¨ä½ çš„ `exercise1_notes.txt` ä¸­æ·»åŠ ï¼š

```
å®‰å…¨æ¼æ´å‘ç°ï¼š

1. XSS æ¼æ´ï¼š
   - ä½ç½®ï¼šusers.py ç¬¬ 18 è¡Œ
   - ä»£ç ï¼šp_markup = Markup("<b>%s</b>" % p)
   - å½±å“ï¼šæ”»å‡»è€…å¯åœ¨ä¸ªäººèµ„æ–™ä¸­æ’å…¥æ¶æ„è„šæœ¬
   - æµ‹è¯•ï¼šåœ¨ä¸ªäººèµ„æ–™ä¸­è¾“å…¥ <script>alert('XSS')</script>

2. æ˜æ–‡å¯†ç å­˜å‚¨ï¼š
   - ä½ç½®ï¼šauth.py ç¬¬ 23ã€31 è¡Œ
   - ä»£ç ï¼šperson.password = password
   - å½±å“ï¼šæ•°æ®åº“æ³„éœ²å¯¼è‡´æ‰€æœ‰ç”¨æˆ·å¯†ç æš´éœ²

3. è½¬è´¦é€»è¾‘æ¼æ´ï¼š
   - ä½ç½®ï¼šbank.py ç¬¬ 5-33 è¡Œ
   - ä»£ç ï¼šæ—  zoobars å‚æ•°æ­£è´Ÿæ£€æŸ¥
   - å½±å“ï¼šå¯èƒ½å…è®¸è´Ÿæ•°è½¬è´¦ï¼Œçªƒå–ä»–äºº zoobar
   - æµ‹è¯•ï¼šå°è¯•è½¬è´¦ -5 zoobar

4. åå°„å‹ XSSï¼š
   - ä½ç½®ï¼šusers.py ç¬¬ 13 è¡Œ
   - ä»£ç ï¼šargs['req_user'] = Markup(request.args.get('user', ''))
   - å½±å“ï¼šURL å‚æ•°æ³¨å…¥æ¶æ„è„šæœ¬
   - æµ‹è¯•ï¼šè®¿é—® /zoobar/index.cgi/users?user=<script>alert('XSS')</script>
```

ç°åœ¨ä½ å·²ç»ç†è§£äº†åº”ç”¨ç¨‹åºçš„æ¶æ„å’Œæ½œåœ¨å®‰å…¨é—®é¢˜ã€‚æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. **å®é™…æµ‹è¯•è¿™äº›æ¼æ´**ï¼ˆæŒ‰ç…§ä¸Šé¢çš„æµ‹è¯•æ–¹æ³•ï¼‰
2. **æŸ¥çœ‹æ¨¡æ¿æ–‡ä»¶**ï¼ˆäº†è§£å¦‚ä½•æ¸²æŸ“è¿™äº›ä¸å®‰å…¨çš„æ•°æ®ï¼‰
3. **å°è¯•åˆ©ç”¨è¿™äº›æ¼æ´**

ä½ æƒ³å…ˆæµ‹è¯•å“ªä¸ªæ¼æ´ï¼Ÿ





# ç»ƒä¹ äºŒï¼šç‰¹æƒåˆ†ç¦»

æ”¹zook.conf

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = dynamic, static

[dynamic]
    cmd = zookfs
    url = /zoobar/.*\.(php|cgi|pl|py).*
    dir = /home/student/
    lxcbr = 1
    port = 8081

    # main âˆš static x echo Ã—
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[static]
    cmd = zookfs
    url = /zoobar/.*\.(html|css|js|png|jpg|gif|ico)
    dir = /home/student/
    lxcbr = 2
    port = 8082

     # main âˆš dynamic x echo x 
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[auth]
    cmd = /home/student/6858/zoobar/auth-server.py
    dir = /home/student/
    lxcbr = 3
    port = 9001

[bank]
    cmd = /home/student/6858/zoobar/bank-server.py
    dir = /home/student/
    lxcbr = 4
    port = 9002
```

æœ‰é—®é¢˜

**auth/bankå®¹å™¨å¯åŠ¨å¤±è´¥**ï¼šé”™è¯¯æ˜¾ç¤º `.//home/student/6858/zoobar/auth-server.py`ï¼ˆè·¯å¾„å‰é¢å¤šäº†ä¸€ä¸ªç‚¹å·å’Œæ–œæ ï¼‰ï¼Œè¯´æ˜ `zook.conf` ä¸­ `cmd` çš„è·¯å¾„é…ç½®æœ‰é—®é¢˜ã€‚

æ”¹ä¸ºï¼š

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = dynamic, static

[dynamic]
    cmd = zookfs
    url = /zoobar/.*\.(php|cgi|pl|py).*
    dir = /home/student/
    lxcbr = 1
    port = 8081

    # main âˆš static x echo Ã—
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[static]
    cmd = zookfs
    url = /zoobar/.*\.(html|css|js|png|jpg|gif|ico)
    dir = /home/student/
    lxcbr = 2
    port = 8082

     # main âˆš dynamic x echo x 
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[auth]
    cmd = ./6858/zoobar/auth-server.py
    dir = /home/student/
    lxcbr = 3
    port = 9001

[bank]
    cmd = ./6858/zoobar/bank-server.py
    dir = /home/student/
    lxcbr = 4
    port = 9002
```



## **åˆ›å»º RPC æœåŠ¡ç«¯æ–‡ä»¶**

åŒæ ·ï¼Œåœ¨ç»ˆç«¯é‡Œåˆ›å»ºæ–‡ä»¶ï¼š

bash

```
# ä½¿ç”¨sudoåˆ›å»ºæ–‡ä»¶
sudo nano /home/student/6858/zoobar/auth-server.py
```



ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆç¡®ä¿å¼•å·æ˜¯è‹±æ–‡çš„ï¼‰ï¼š

python

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from rpc import RPCServer
import auth
from debug import *

class AuthServer(RPCServer):
    def rpc_login(self, username, password):
        debug.log(f"AuthServer: rpc_login called for user '{username}'")
        return auth.login(username, password)

    def rpc_register(self, username, password):
        debug.log(f"AuthServer: rpc_register called for user '{username}'")
        return auth.register(username, password)

    def rpc_check_token(self, username, token):
        debug.log(f"AuthServer: rpc_check_token called for user '{username}'")
        return auth.check_token(username, token)

if __name__ == "__main__":
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 9001
    debug.log(f"Starting AuthServer on port {port}")
    server = AuthServer()
    server.run_server(port=port)
```



ä¿å­˜é€€å‡ºï¼ˆ`Ctrl+O`, `Enter`, `Ctrl+X`ï¼‰ã€‚

**åŒæ ·åˆ›å»º `bank-server.py`**ï¼š

bash

```
sudo nano /home/student/6858/zoobar/bank-server.py
```



ç²˜è´´ï¼š

python

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from rpc import RPCServer
import bank
from debug import *

class BankServer(RPCServer):
    def rpc_transfer(self, sender, recipient, zoobars):
        debug.log(f"BankServer: rpc_transfer from '{sender}' to '{recipient}' amount {zoobars}")
        return bank.transfer(sender, recipient, zoobars)

    def rpc_balance(self, username):
        debug.log(f"BankServer: rpc_balance for user '{username}'")
        return bank.balance(username)

    def rpc_get_log(self, username):
        debug.log(f"BankServer: rpc_get_log for user '{username}'")
        return bank.get_log(username)

if __name__ == "__main__":
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 9002
    debug.log(f"Starting BankServer on port {port}")
    server = BankServer()
    server.run_server(port=port)
```



ä¿å­˜é€€å‡ºã€‚

## âœ… **ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®æ–‡ä»¶æƒé™**

bash

```
# ç»™æ–‡ä»¶æ‰§è¡Œæƒé™
sudo chmod +x /home/student/6858/zoobar/auth-server.py /home/student/6858/zoobar/bank-server.py

# å°†æ–‡ä»¶æ‰€æœ‰è€…æ”¹ä¸ºstudentï¼Œæ–¹ä¾¿ä»¥åç¼–è¾‘
sudo chown student:student /home/student/6858/zoobar/auth-server.py /home/student/6858/zoobar/bank-server.py
```



------

#### **1. ä¿®æ”¹ `zook.conf` é…ç½®æ–‡ä»¶**

ini

```
# æ–°å¢authå®¹å™¨
[auth]
    cmd = /zoobar/auth-server.py
    dir = /home/student/
    lxcbr = 3        # ç‹¬ç«‹è™šæ‹Ÿç½‘ç»œ
    port = 9001

# æ–°å¢bankå®¹å™¨  
[bank]
    cmd = /zoobar/bank-server.py
    dir = /home/student/
    lxcbr = 4        # ç‹¬ç«‹è™šæ‹Ÿç½‘ç»œ
    port = 9002
```



#### **2. åˆ›å»ºRPCæœåŠ¡ç«¯ç¨‹åº**

- **`auth-server.py`**ï¼šæš´éœ²`login()`, `register()`, `check_token()`æ–¹æ³•
- **`bank-server.py`**ï¼šæš´éœ²`transfer()`, `balance()`, `get_log()`æ–¹æ³•
- **`rpclib.py`**ï¼šè‡ªå®šä¹‰RPCæ¡†æ¶ï¼Œå¤„ç†å®¹å™¨é—´é€šä¿¡

#### **3. ä¿®å¤çš„å…³é”®é—®é¢˜**

- **è·¯å¾„é—®é¢˜**ï¼šå®¹å™¨å†…ä½¿ç”¨æ­£ç¡®è·¯å¾„è®¿é—®æ–‡ä»¶
- **æ¨¡å—å¯¼å…¥**ï¼šç¡®ä¿`debug.py`ã€`rpclib.py`ç­‰æ¨¡å—æ­£ç¡®å¯¼å…¥
- **æƒé™è®¾ç½®**ï¼šä¸ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™

#### **4. æœ€ç»ˆå®¹å™¨æ¶æ„**

text

```
+----------------+    +----------------+    +----------------+
|    mainå®¹å™¨    |    |  dynamicå®¹å™¨   |    |   staticå®¹å™¨   |
| (zookd2:8080)  |    | (zookfs:8081)  |    | (zookfs:8082)  |
| åº”ç”¨é€»è¾‘+åˆ†å‘   |    | åŠ¨æ€å†…å®¹æœåŠ¡    |    | é™æ€æ–‡ä»¶æœåŠ¡    |
+--------+-------+    +----------------+    +----------------+
         |
         | HTTPè½¬å‘
         v
+----------------+    +----------------+
|    authå®¹å™¨    |    |   bankå®¹å™¨     |
| (RPC:9001)     |    | (RPC:9002)     |
| è®¤è¯æœåŠ¡        |    | é“¶è¡ŒæœåŠ¡        |
+----------------+    +----------------+
```

# ç»ƒä¹ ä¸‰ï¼šé˜²ç«å¢™è§„åˆ™

#### **1. ç½‘ç»œéš”ç¦»é…ç½®**

- æ¯ä¸ªå®¹å™¨åˆ†é…ç‹¬ç«‹`lxcbr`ç½‘ç»œï¼ˆ0-4ï¼‰
- å®¹å™¨é—´é€šä¿¡å¿…é¡»é€šè¿‡ä¸»æœºè·¯ç”±ï¼Œæ— æ³•ç›´æ¥è®¿é—®

#### **2. `zook.conf` ä¸­çš„é˜²ç«å¢™è§„åˆ™**

ini

```
[dynamic]
    # ä»…å…è®¸mainå®¹å™¨è®¿é—®
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[static]
    # ä»…å…è®¸mainå®¹å™¨è®¿é—®  
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT
```



#### **3. å®‰å…¨æ•ˆæœ**

- `main`å®¹å™¨æ— æ³•ç›´æ¥è®¿é—®`auth`ã€`bank`å®¹å™¨çš„æ•°æ®åº“æ–‡ä»¶
- å³ä½¿`main`å®¹å™¨è¢«æ”»ç ´ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç›´æ¥ä¿®æ”¹ç”¨æˆ·å‡­è¯æˆ–ä½™é¢
- æœåŠ¡é—´é€šä¿¡å¿…é¡»é€šè¿‡å®šä¹‰çš„RPCæ¥å£



# ç»ƒä¹ äº”ï¼šZoobarç™»å½•æœåŠ¡ç‰¹æƒåˆ†ç¦»

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ `zoodb.py`ï¼ˆå®šä¹‰æ–°çš„æ•°æ®åº“ç»“æ„ï¼‰

è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæ–°çš„æ•°æ®è¡¨ï¼Œå¹¶ä¿®æ”¹ç°æœ‰çš„è¡¨ç»“æ„ã€‚

1. **å¤‡ä»½åŸå§‹æ–‡ä»¶**ï¼š

   bash

   ```
   cp ~/6858/zoobar/zoodb.py ~/6858/zoobar/zoodb.py.backup
   ```

   

2. **ç¼–è¾‘ `zoodb.py`**ï¼š

   bash

   ```
   nano ~/6858/zoobar/zoodb.py
   ```

   â­é‡åˆ°æƒé™é—®é¢˜è§£å†³ï¼š

   ```
   student@6858-v22:~/6858$ sudo chown -R student:student zoobar/
   student@6858-v22:~/6858$ sudo chmod +w zoobar/zoodb.py
   ```

   

3. **åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å®šä¹‰ `PersonBase` å’Œ `TransferBase` çš„åœ°æ–¹ï¼ˆé€šå¸¸åœ¨é¡¶éƒ¨ï¼‰**ï¼Œåœ¨å…¶åæ·»åŠ ä¸€ä¸ªæ–°çš„åŸºç±» `CredBase`ï¼š

   python

   ```
   PersonBase = declarative_base()
   TransferBase = declarative_base()
   CredBase = declarative_base()  # æ–°å¢è¿™ä¸€è¡Œ
   ```

   

4. **ä¿®æ”¹ `Person` ç±»**ï¼š**ç§»é™¤ `password` å’Œ `token` å­—æ®µ**ã€‚è¿™æ˜¯å®ç°åˆ†ç¦»çš„å…³é”®ï¼Œä¿®æ”¹å `Person` ç±»åº”åªåŒ…å«ï¼š

   python

   ```
   class Person(PersonBase):
       __tablename__ = "person"
       username = Column(String(128), primary_key=True)
       zoobars = Column(Integer, nullable=False, default=10)
       profile = Column(String(5000), nullable=False, default="")
   ```

   

5. **åœ¨ `Person` ç±»å®šä¹‰åï¼Œæ·»åŠ æ–°çš„ `Cred` ç±»**ï¼š

   python

   ```
   class Cred(CredBase):
       __tablename__ = "cred"
       username = Column(String(128), primary_key=True)
       password = Column(String(128))
       token = Column(String(128))
       # æ³¨æ„ï¼šç»ƒä¹ å…­ä¼šè¦æ±‚æ·»åŠ  salt å­—æ®µï¼Œç°åœ¨å¯ä»¥å…ˆä¸åŠ 
   ```

   

6. **åœ¨ `person_setup` å’Œ `transfer_setup` å‡½æ•°å®šä¹‰åï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„ `cred_setup` å‡½æ•°**ï¼š

   python

   ```
   def cred_setup():
       return dbsetup("cred", CredBase)
   ```

   

7. **ä¿®æ”¹æ–‡ä»¶åº•éƒ¨çš„å‘½ä»¤è¡Œæ¥å£**ï¼Œä»¥æ”¯æŒåˆå§‹åŒ– `cred` æ•°æ®åº“ï¼š

   python

   ```
   if __name__ == "__main__":
       if len(sys.argv) < 2:
           print("Usage: %s [init-person|init-transfer|init-cred]" % sys.argv[0])
           exit(1)
   
       cmd = sys.argv[1]
       if cmd == 'init-person':
           person_setup()
       elif cmd == 'init-transfer':
           transfer_setup()
       elif cmd == 'init-cred':  # æ–°å¢è¿™ä¸ªåˆ†æ”¯
           cred_setup()
       else:
           raise Exception("unknown command %s" % cmd)
   ```

   

8. **ä¿å­˜å¹¶é€€å‡º** (`Ctrl+O`, `Enter`, `Ctrl+X`)ã€‚

------

### ğŸ”§ ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ `chroot-setup.sh`ï¼ˆåˆ›å»ºæ•°æ®åº“ç›®å½•ä¸åˆå§‹åŒ–ï¼‰

è¿™ä¸ªè„šæœ¬è´Ÿè´£åœ¨å®¹å™¨ç¯å¢ƒä¸­è®¾ç½®æ–‡ä»¶å’Œæ•°æ®åº“ã€‚æˆ‘ä»¬éœ€è¦è®©å®ƒåˆ›å»º `cred` æ•°æ®åº“ã€‚

1. **å¤‡ä»½åŸå§‹æ–‡ä»¶**ï¼š

   bash

   ```
   cp ~/6858/chroot-setup.sh ~/6858/chroot-setup.sh.backup
   ```

   

2. **ç¼–è¾‘ `chroot-setup.sh`**ï¼š

   bash

   ```
   nano ~/6858/chroot-setup.sh
   ```

   

3. **åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°åˆå§‹åŒ–æ•°æ®åº“çš„éƒ¨åˆ†**ï¼ˆæœç´¢ `init-person` æˆ– `init-transfer`ï¼‰ã€‚é€šå¸¸çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

   bash

   ```
   python /jail/zoobar/zoodb.py init-person
   python /jail/zoobar/zoodb.py init-transfer
   ```

   

   åœ¨è¿™ä¸¤è¡Œä¹‹åï¼Œæ·»åŠ ä¸€è¡Œæ¥åˆå§‹åŒ– `cred` æ•°æ®åº“ï¼š

   bash

   ```
   python /jail/zoobar/zoodb.py init-cred
   ```

   

4. **ä¿å­˜å¹¶é€€å‡º**ã€‚

------

### âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹ `auth.py`ï¼ˆè®©è®¤è¯é€»è¾‘ä½¿ç”¨æ–°çš„ `cred` æ•°æ®åº“ï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹è®¤è¯é€»è¾‘ï¼Œè®©å®ƒè¯»å†™æ–°çš„ `Cred` è¡¨ï¼Œè€Œä¸æ˜¯æ—§çš„ `Person` è¡¨ã€‚

1. **å¤‡ä»½åŸå§‹æ–‡ä»¶**ï¼š

   bash

   ```
   cp ~/6858/zoobar/auth.py ~/6858/zoobar/auth.py.backup
   ```

   

2. **ç¼–è¾‘ `auth.py`**ï¼š

   bash

   ```
   nano ~/6858/zoobar/auth.py
   ```

   

3. **å…³é”®ä¿®æ”¹**ï¼šè¿™ä¸ªæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½éœ€è¦ä» `person_setup()` å’Œ `Person` ç±»ï¼Œæ”¹ä¸º `cred_setup()` å’Œ `Cred` ç±»ã€‚

   - **å°† `person_setup()` çš„è°ƒç”¨æ›¿æ¢ä¸º `cred_setup()`**ã€‚
   - **å°† `Person` ç±»çš„å¼•ç”¨æ›¿æ¢ä¸º `Cred`**ã€‚
   - ä»¥ `login` å‡½æ•°ä¸ºä¾‹ï¼Œä¿®æ”¹ååº”ç±»ä¼¼è¿™æ ·ï¼š

   python

   ```
   def login(username, password):
       db = cred_setup()           # ä¿®æ”¹äº†è¿™ä¸€è¡Œ
       cred = db.query(Cred).get(username)  # ä¿®æ”¹äº†è¿™ä¸€è¡Œ
       if not cred:
           return None
       if cred.password == password:
           return newtoken(db, cred)  # æ³¨æ„ï¼šè¿™é‡Œçš„å‚æ•°ä¹Ÿæ”¹ä¸ºäº† cred
       else:
           return None
   ```

   

   - åŒç†ï¼Œä¿®æ”¹ `register` å’Œ `check_token` å‡½æ•°ã€‚æ³¨æ„ `newtoken` å‡½æ•°ä¹Ÿéœ€è¦è°ƒæ•´å…¶å‚æ•°ï¼ˆä» `person` æ”¹ä¸º `cred`ï¼‰ï¼Œé€»è¾‘ä¸å˜ã€‚

4. **ä¿®æ”¹ `newtoken` å‡½æ•°ç­¾å**ï¼ˆç¬¬ä¸€è¡Œï¼‰ï¼š

   python

   ```
   def newtoken(db, cred):  # å°†å‚æ•°åä» person æ”¹ä¸º credï¼Œä»¥æ›´æ¸…æ™°
       hashinput = "%s%.10f" % (cred.password, random.random())
       cred.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
       db.commit()
       return cred.token
   ```

   

5. **ä¿å­˜å¹¶é€€å‡º**ã€‚

------

### ğŸš€ ç¬¬å››æ­¥ï¼šé‡å¯å®¹å™¨å¹¶æµ‹è¯•

1. **ç”±äºæˆ‘ä»¬ä¿®æ”¹äº†æ•°æ®åº“ç»“æ„å’Œè®¾ç½®è„šæœ¬ï¼Œå¿…é¡»å®Œå…¨æ¸…ç†å¹¶é‡å»ºå®¹å™¨**ï¼š

   bash

   ```
   cd ~/6858
   ./zookclean.py
   ./zookld.py
   ```

   

   ä»”ç»†è§‚å¯Ÿå¯åŠ¨è¿‡ç¨‹ï¼Œç¡®ä¿æ²¡æœ‰æŠ¥é”™ã€‚

2. **éªŒè¯ `cred` æ•°æ®åº“æ˜¯å¦åˆ›å»º**ï¼š

   bash

   ```
   # è¿›å…¥ auth å®¹å™¨æŸ¥çœ‹
   sudo lxc-attach -n auth
   ls -la /home/student/zoobar/db/cred/
   # åº”è¯¥èƒ½çœ‹åˆ° cred.db æ–‡ä»¶
   exit
   ```

   

3. **è¿›è¡ŒåŠŸèƒ½æµ‹è¯•**ï¼š

   - æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `http://192.168.153.131:8888/zoobar/index.cgi/`ã€‚
   - **æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·**ï¼ˆä¾‹å¦‚ `testuser5`ï¼‰ã€‚è¿™æ˜¯å…³é”®æµ‹è¯•ï¼Œå› ä¸ºæ—§ç”¨æˆ·çš„å¯†ç å¯èƒ½æ²¡æœ‰è¿ç§»ã€‚
   - å°è¯•ç”¨æ–°ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¿›è¡Œä¸€äº›æ“ä½œï¼ˆå¦‚æŸ¥çœ‹ä¸ªäººèµ„æ–™ï¼‰ã€‚å¦‚æœèƒ½æˆåŠŸï¼Œè¯´æ˜æ–°çš„ `auth` æœåŠ¡å’Œ `cred` æ•°æ®åº“åŸºæœ¬å·¥ä½œæ­£å¸¸ã€‚

4. **è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•**ï¼š

   bash

   ```
   make check
   ```

   

   æŸ¥çœ‹è¾“å‡ºã€‚ç°åœ¨ï¼Œä¹‹å‰å…³äº **â€œContainer auth should have database credâ€** å’Œ **â€œno db ... cred.db in authâ€** çš„é”™è¯¯åº”è¯¥æ¶ˆå¤±ã€‚ä½ å¯èƒ½ä¼šçœ‹åˆ°å…³äºç»ƒä¹ å…­ã€ä¸ƒç­‰çš„æ–°å¤±è´¥ä¿¡æ¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜ä½ æ­£åœ¨æ¨è¿›ã€‚





```
student@6858-v22:~/6858/zoobar$ python3 test_db2.py
Testing person database...
Person database session created: <sqlalchemy.orm.session.Session object at 0x7f1989053c70>
Testing cred database...
Cred database session created: <sqlalchemy.orm.session.Session object at 0x7f1989053850>
Database test completed successfully!
```



------

### ğŸ”„ ç¬¬äº”æ­¥ï¼šå¤„ç†æ•°æ®è¿ç§»ï¼ˆå¯é€‰ä½†æ¨èï¼‰

å¦‚æœä½ çš„ `person` æ•°æ®åº“ä¸­å·²æœ‰ç”¨æˆ·ï¼ˆæ¯”å¦‚ä¹‹å‰æµ‹è¯•åˆ›å»ºçš„ `user1`, `user2`ï¼‰ï¼Œä»–ä»¬çš„å¯†ç å’Œä»¤ç‰Œè¿˜åœ¨æ—§çš„ `person.db` é‡Œï¼Œæ–°çš„ `cred.db` ä¸­æ²¡æœ‰è®°å½•ï¼Œä»–ä»¬å°†æ— æ³•ç™»å½•ã€‚

ä½ å¯ä»¥é€‰æ‹©ï¼š

- **ä¸è¿ç§»**ï¼šå¦‚æœåªæ˜¯ä¸ºäº†é€šè¿‡æµ‹è¯•ï¼Œæµ‹è¯•è„šæœ¬å¯èƒ½ä¼šè‡ªå·±æ³¨å†Œæ–°ç”¨æˆ·ã€‚å¯ä»¥æš‚æ—¶ä¸ç®¡ã€‚
- **ç®€å•è¿ç§»**ï¼šç¼–å†™ä¸€ä¸ªä¸€æ¬¡æ€§è„šæœ¬ï¼Œå°† `person` è¡¨ä¸­çš„ `username`, `password`, `token` å¤åˆ¶åˆ° `cred` è¡¨ã€‚ç”±äºè¿™æ¶‰åŠä¸¤ä¸ªä¸åŒçš„æ•°æ®åº“æ–‡ä»¶ï¼Œæ“ä½œç¨å¤æ‚ã€‚

å¦‚æœä½ å¸Œæœ›å°è¯•è¿ç§»ï¼Œå¯ä»¥åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶Pythonè„šæœ¬ï¼ˆæ³¨æ„ï¼šæ“ä½œå‰**åŠ¡å¿…å¤‡ä»½** `person.db` å’Œ `cred.db`ï¼‰ã€‚

### ğŸ“‹ æ€»ç»“ä¸ä¸‹ä¸€æ­¥

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ å°±å®Œæˆäº†**ç»ƒä¹ äº”çš„æ ¸å¿ƒéƒ¨åˆ†**ï¼šå°†ç”¨æˆ·å‡­è¯æ•°æ®åº“åˆ†ç¦»ã€‚ä½ çš„ `auth` å®¹å™¨ç°åœ¨æ‹¥æœ‰äº†ç‹¬ç«‹çš„ã€å—ä¿æŠ¤çš„ `cred` æ•°æ®åº“ã€‚

**æ¥ä¸‹æ¥**ï¼Œæ ¹æ® `make check` çš„æç¤ºï¼Œä½ å°†è¿›å…¥ï¼š

- **ç»ƒä¹ å…­**ï¼šåœ¨ `cred` è¡¨ä¸­æ·»åŠ  `salt` åˆ—ï¼Œå¹¶ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡ŒåŠ ç›å“ˆå¸Œå­˜å‚¨ï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰ã€‚
- **ç»ƒä¹ ä¸ƒ**ï¼šä¸ºé“¶è¡ŒæœåŠ¡åˆ›å»ºç‹¬ç«‹çš„ `bank` æ•°æ®åº“ã€‚

**è¯·å…ˆå®Œæˆç¬¬ä¸€æ­¥åˆ°ç¬¬å››æ­¥**ï¼Œä¿®æ”¹ä»£ç å¹¶é‡å¯å®¹å™¨ã€‚æˆåŠŸåå‘Šè¯‰æˆ‘ `make check` çš„ç»“æœï¼Œç‰¹åˆ«æ˜¯å…³äºç»ƒä¹ äº”çš„é”™è¯¯æ˜¯å¦å·²è§£å†³ã€‚å¦‚æœå¡åœ¨ä»»ä½•ä¸€æ­¥ï¼Œè¯·æŠŠå…·ä½“çš„é”™è¯¯ä¿¡æ¯å‘ç»™æˆ‘ã€‚

## ç»ƒä¹ äº”é”™è¯¯æ€»ç»“

#### é”™è¯¯1ï¼šæ•°æ®åº“ç›®å½•ç»“æ„é”™è¯¯

**é”™è¯¯ç°è±¡ï¼š**

text

```
ls -la zoobar/db/
# æ˜¾ç¤ºä¸ºç›®å½•ï¼Œä½†æ²¡æœ‰.dbæ–‡ä»¶
chmod: cannot access 'db/*.db': No such file or directory
```



**é”™è¯¯åŸå› ï¼š**
`zoodb.py` ä¸­çš„ `dbsetup` å‡½æ•°å°†æ•°æ®åº“æ–‡ä»¶åˆ›å»ºåœ¨å­ç›®å½•ä¸­ï¼ˆå¦‚ `db/cred/cred.db`ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥æ”¾åœ¨ `db/` ç›®å½•ä¸‹

**è§£å†³æ–¹æ³•ï¼š**
ä¿®æ”¹ `zoodb.py` ä¸­çš„ `dbsetup` å‡½æ•°ï¼š

python

```
def dbsetup(name, base):
    thisdir = os.path.dirname(os.path.abspath(__file__))
    dbdir   = os.path.join(thisdir, "db", name)  # åˆ›å»ºå­ç›®å½•
    if not os.path.exists(dbdir):
        os.makedirs(dbdir)

    dbfile  = os.path.join(dbdir, "%s.db" % name)  # åœ¨å­ç›®å½•ä¸­åˆ›å»º.dbæ–‡ä»¶
    # ... å…¶ä½™ä»£ç 
```



#### é”™è¯¯2ï¼šInternal Server Error - 'NoneType' object has no attribute 'zoobars'

**é”™è¯¯ç°è±¡ï¼š**

text

```
AttributeError: 'NoneType' object has no attribute 'zoobars'
File "/home/student/zoobar/bank.py", line 34, in balance
    return person.zoobars
```



**é”™è¯¯åŸå› ï¼š**

- åœ¨ `cred` æ•°æ®åº“æ³¨å†Œç”¨æˆ·åï¼Œæœªåœ¨ `person` æ•°æ®åº“ä¸­åˆ›å»ºå¯¹åº”çš„è®°å½•
- `bank.balance()` å‡½æ•°å°è¯•æŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·è®°å½•

**è§£å†³æ–¹æ³•ï¼š**
ä¿®æ”¹ `auth.py` ä¸­çš„ `register` å‡½æ•°ï¼ŒåŒæ—¶åœ¨ä¸¤ä¸ªæ•°æ®åº“ä¸­åˆ›å»ºè®°å½•ï¼š

python

```
def register(username, password):
    # ... åˆ›å»º cred è®°å½•
    
    # åˆ›å»º person è®°å½•
    db_person = person_setup()
    person = db_person.query(Person).get(username)
    if not person:
        newperson = Person()
        newperson.username = username
        newperson.zoobars = 10  # åˆå§‹ä½™é¢
        newperson.profile = ""
        db_person.add(newperson)
        db_person.commit()
    
    # ... ç”Ÿæˆå¹¶è¿”å› token
```



#### é”™è¯¯3ï¼šæµ‹è¯•è¦æ±‚æ•°æ®åº“è·¯å¾„ä¸å®é™…ä¸ç¬¦

**é”™è¯¯ç°è±¡ï¼š**
æµ‹è¯•æœŸæœ›æ•°æ®åº“è·¯å¾„ä¸º `/home/student/zoobar/db/cred/cred.db`ï¼Œä½†å®é™…è·¯å¾„ä¸åŒ

**é”™è¯¯åŸå› ï¼š**
æµ‹è¯•è„šæœ¬æœŸæœ›ç‰¹å®šçš„æ•°æ®åº“ç›®å½•ç»“æ„

**è§£å†³æ–¹æ³•ï¼š**

1. ä¿æŒæ•°æ®åº“åœ¨å­ç›®å½•ä¸­çš„ç»“æ„
2. ç¡®ä¿ `zoodb.py` çš„ `dbsetup` å‡½æ•°åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
3. é‡æ–°åˆå§‹åŒ–æ‰€æœ‰æ•°æ®åº“

#### é”™è¯¯4ï¼šå®¹å™¨é—´é€šä¿¡æƒé™é—®é¢˜

**é”™è¯¯ç°è±¡ï¼š**

text

```
FAIL: Container main shouldn't be able to communite with auth
```



**é”™è¯¯åŸå› ï¼š**
é˜²ç«å¢™è§„åˆ™æœªæ­£ç¡®é…ç½®ï¼Œmainå®¹å™¨ä»èƒ½ä¸authå®¹å™¨é€šä¿¡

**è§£å†³æ–¹æ³•ï¼š**
åœ¨ `zook.conf` çš„ `[auth]` éƒ¨åˆ†æ·»åŠ æ­£ç¡®çš„é˜²ç«å¢™è§„åˆ™ï¼š

ini

```
[auth]
    # ... å…¶ä»–é…ç½®
    fwrule = -s dynamic -j ACCEPT  # åªå…è®¸dynamicå®¹å™¨è®¿é—®
    fwrule = -j REJECT             # æ‹’ç»å…¶ä»–æ‰€æœ‰å®¹å™¨
```

# ç»ƒä¹ å…­ï¼šä¸ºéªŒè¯æœåŠ¡æ·»åŠ å¯†ç åŠ ç›å“ˆå¸Œ

## å®éªŒç›®æ ‡

ä¸ºZoobarç™»å½•æœåŠ¡æ·»åŠ å¯†ç åŠ ç›å“ˆå¸ŒåŠŸèƒ½ï¼Œå¢å¼ºå¯†ç å­˜å‚¨çš„å®‰å…¨æ€§ã€‚

## å®éªŒåŸç†

- **å¯†ç å“ˆå¸Œ**ï¼šå°†ç”¨æˆ·å¯†ç é€šè¿‡å“ˆå¸Œå‡½æ•°è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„å“ˆå¸Œå€¼å­˜å‚¨
- **ç›å€¼**ï¼šéšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œä¸å¯†ç æ‹¼æ¥åå†è¿›è¡Œå“ˆå¸Œï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- **PBKDF2**ï¼šä¸€ç§å¯†ç å“ˆå¸Œç®—æ³•ï¼Œé€šè¿‡å¤šæ¬¡è¿­ä»£å¢åŠ è®¡ç®—æˆæœ¬

## è¯¦ç»†æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ `zoodb.py`ï¼Œä¸ºCredè¡¨æ·»åŠ saltå­—æ®µ

bash

```
cd /home/student/6858
nano zoobar/zoodb.py
```



ä¿®æ”¹Credç±»ï¼Œæ·»åŠ saltå­—æ®µï¼š

python

```
class Cred(CredBase):
    __tablename__ = "cred"
    username = Column(String(128), primary_key=True)
    password = Column(String(128))
    token = Column(String(128))
    salt = Column(String(32))  # ç»ƒä¹ å…­ï¼šæ·»åŠ  salt å­—æ®µï¼Œå­˜å‚¨16å­—èŠ‚ç›çš„åå…­è¿›åˆ¶è¡¨ç¤º
```



ä¿å­˜æ–‡ä»¶ã€‚

### ç¬¬äºŒæ­¥ï¼šåœ¨auth.pyä¸­æ·»åŠ å¯†ç å“ˆå¸Œå‡½æ•°

bash

```
nano zoobar/auth.py
```



#### 2.1 å¯¼å…¥å¿…è¦çš„æ¨¡å—

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

python

```
import binascii
```



#### 2.2 æ·»åŠ å¯†ç å“ˆå¸Œå‡½æ•°

åœ¨æ–‡ä»¶é¡¶éƒ¨ç°æœ‰å‡½æ•°ä¹‹å‰æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š

python

```
# ç»ƒä¹ å…­ï¼šå¯†ç å“ˆå¸Œå‡½æ•°
def hash_password(password, salt=None):
    """ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
    import hashlib
    import os
    
    if salt is None:
        # ç”Ÿæˆæ–°çš„ç›
        salt = os.urandom(16)  # 16å­—èŠ‚ = 128ä½
        salt_hex = binascii.hexlify(salt).decode('utf-8')
    else:
        # ä½¿ç”¨å·²æœ‰çš„ç›ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
        salt = binascii.unhexlify(salt)
        salt_hex = salt
    
    # ä½¿ç”¨ PBKDF2-HMAC-SHA256ï¼Œè¿­ä»£100000æ¬¡
    dk = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt,
        100000  # è¿­ä»£æ¬¡æ•°
    )
    hash_hex = binascii.hexlify(dk).decode('utf-8')
    
    if isinstance(salt_hex, str):
        return hash_hex, salt_hex
    else:
        return hash_hex, binascii.hexlify(salt).decode('utf-8')
```



#### 2.3 ä¿®æ”¹registerå‡½æ•°

æ‰¾åˆ°registerå‡½æ•°ï¼Œä¿®æ”¹ä¸ºï¼š

python

```
def register(username, password):
    # å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    db_cred = cred_setup()
    cred = db_cred.query(Cred).get(username)
    if cred:
        return None
    
    # ç»ƒä¹ å…­ï¼šç”Ÿæˆå¯†ç å“ˆå¸Œå’Œç›
    password_hash, salt = hash_password(password)
    
    # åˆ›å»º cred è®°å½•
    newcred = Cred()
    newcred.username = username
    newcred.password = password_hash  # å­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡å¯†ç 
    newcred.salt = salt  # å­˜å‚¨ç›
    db_cred.add(newcred)
    db_cred.commit()
    
    # åˆ›å»º person è®°å½•
    db_person = person_setup()
    person = db_person.query(Person).get(username)
    if not person:
        newperson = Person()
        newperson.username = username
        newperson.zoobars = 10
        newperson.profile = ""
        db_person.add(newperson)
        db_person.commit()
    
    # ç”Ÿæˆå¹¶è¿”å› token
    return newtoken(db_cred, newcred)
```



#### 2.4 ä¿®æ”¹loginå‡½æ•°

æ‰¾åˆ°loginå‡½æ•°ï¼Œä¿®æ”¹ä¸ºï¼š

python

```
def login(username, password):
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if not cred:
        return None
    
    # ç»ƒä¹ å…­ï¼šä½¿ç”¨å­˜å‚¨çš„ç›å¯¹è¾“å…¥çš„å¯†ç è¿›è¡Œå“ˆå¸Œ
    if cred.salt:  # å¦‚æœæœ‰ç›å€¼ï¼ˆæ–°ç”¨æˆ·ï¼‰
        password_hash, _ = hash_password(password, cred.salt)
        # æ¯”è¾ƒå“ˆå¸Œå€¼
        if cred.password == password_hash:
            return newtoken(db, cred)
        else:
            return None
    else:  # å¦‚æœæ²¡æœ‰ç›å€¼ï¼ˆæ—§ç”¨æˆ·ï¼Œå¯†ç ä¸ºæ˜æ–‡ï¼‰
        if cred.password == password:
            # è¿ç§»æ—§ç”¨æˆ·ï¼šå°†æ˜æ–‡å¯†ç è½¬æ¢ä¸ºå“ˆå¸Œ
            password_hash, salt = hash_password(password)
            cred.password = password_hash
            cred.salt = salt
            db.commit()
            return newtoken(db, cred)
        else:
            return None
```



#### 2.5 ä¿å­˜æ–‡ä»¶

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥è¿ç§»ç°æœ‰ç”¨æˆ·çš„å¯†ç 

ç”±äºç°æœ‰ç”¨æˆ·çš„å¯†ç è¿˜æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºå“ˆå¸Œå­˜å‚¨ï¼š

bash

```
cd /home/student/6858
cat > migrate_passwords.py << 'EOF'
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from zoobar.zoodb import Cred, cred_setup
import binascii
import hashlib

def hash_password(password, salt=None):
    if salt is None:
        import os
        salt = os.urandom(16)
        salt_hex = binascii.hexlify(salt).decode('utf-8')
    else:
        salt = binascii.unhexlify(salt)
        salt_hex = binascii.hexlify(salt).decode('utf-8')
    
    dk = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), salt, 100000)
    hash_hex = binascii.hexlify(dk).decode('utf-8')
    return hash_hex, salt_hex

def migrate():
    db = cred_setup()
    users = db.query(Cred).all()
    migrated = 0
    
    for user in users:
        if not user.salt:  # å¦‚æœç”¨æˆ·æ²¡æœ‰ç›å€¼ï¼Œè¯´æ˜å¯†ç æ˜¯æ˜æ–‡
            print(f"è¿ç§»ç”¨æˆ·: {user.username}")
            password_hash, salt = hash_password(user.password)
            user.password = password_hash
            user.salt = salt
            migrated += 1
    
    if migrated > 0:
        db.commit()
        print(f"æˆåŠŸè¿ç§» {migrated} ä¸ªç”¨æˆ·çš„å¯†ç ")
    else:
        print("æ²¡æœ‰éœ€è¦è¿ç§»çš„ç”¨æˆ·")

if __name__ == "__main__":
    migrate()
EOF

# è¿è¡Œè¿ç§»è„šæœ¬
cd /home/student/6858
python3 migrate_passwords.py
```



### ç¬¬å››æ­¥ï¼šæµ‹è¯•å¯†ç å“ˆå¸ŒåŠŸèƒ½

#### 4.1 åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•è„šæœ¬

bash

```
cat > test_password_hash.py << 'EOF'
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from zoobar.auth import hash_password, login

# æµ‹è¯•å“ˆå¸Œå‡½æ•°
password = "testpassword123"
hash1, salt1 = hash_password(password)
print(f"å¯†ç : {password}")
print(f"å“ˆå¸Œ: {hash1}")
print(f"ç›å€¼: {salt1}")

# æµ‹è¯•ä½¿ç”¨ç›¸åŒç›å€¼æ˜¯å¦èƒ½å¾—åˆ°ç›¸åŒå“ˆå¸Œ
hash2, _ = hash_password(password, salt1)
print(f"\nä½¿ç”¨ç›¸åŒç›å€¼å†æ¬¡å“ˆå¸Œ:")
print(f"å“ˆå¸Œ: {hash2}")
print(f"å“ˆå¸Œæ˜¯å¦ç›¸åŒ: {hash1 == hash2}")

# æµ‹è¯•ä¸åŒå¯†ç 
hash3, salt3 = hash_password("differentpassword")
print(f"\nä¸åŒå¯†ç çš„å“ˆå¸Œ: {hash3}")
print(f"å“ˆå¸Œæ˜¯å¦ç›¸åŒ: {hash1 == hash3}")
EOF

python3 test_password_hash.py
```



## é—®é¢˜



### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å¹¶ä¿®å¤ `zoodb.py` ä¸­çš„ `Cred` ç±»

bash

```
cd /home/student/6858
nano zoobar/zoodb.py
```



ç¡®ä¿ `Cred` ç±»æœ‰ `salt` å­—æ®µï¼š

python

```
class Cred(CredBase):
    __tablename__ = "cred"
    username = Column(String(128), primary_key=True)
    password = Column(String(128))
    token = Column(String(128))
    salt = Column(String(32))  # ç¡®ä¿è¿™ä¸€è¡Œå­˜åœ¨
```



### ç¬¬äºŒæ­¥ï¼šé‡æ–°åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“

bash

```
cd /home/student/6858/zoobar

# åˆ é™¤æ—§çš„æ•°æ®åº“
rm -rf db/cred

# é‡æ–°åˆå§‹åŒ–
python3 zoodb.py init-cred

# æ£€æŸ¥è¡¨ç»“æ„
sqlite3 db/cred/cred.db ".schema cred"
```



åº”è¯¥çœ‹åˆ° `salt` å­—æ®µã€‚





#### 4.2 æµ‹è¯•æ³¨å†Œå’Œç™»å½•

bash

```
# æ¸…ç†å¹¶é‡å¯æœåŠ¡å™¨
cd /home/student/6858
./zookclean.py
./zookld.py

# ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
sleep 5

# åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ³¨å†Œå’Œç™»å½•åŠŸèƒ½
echo "è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://ä½ çš„IPåœ°å€:8080/zoobar/index.cgi/"
echo "1. æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·"
echo "2. ä½¿ç”¨æ–°ç”¨æˆ·ç™»å½•"
echo "3. æ£€æŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸"
```



### ç¬¬äº”æ­¥ï¼šæ£€æŸ¥æ•°æ®åº“ä¸­çš„å¯†ç å­˜å‚¨

bash

```
cd /home/student/6858/zoobar

# æŸ¥çœ‹credæ•°æ®åº“ä¸­çš„å¯†ç å’Œç›å€¼
echo "=== cred æ•°æ®åº“å†…å®¹ ==="
sqlite3 db/cred/cred.db "SELECT username, substr(password, 1, 20) as password_preview, substr(salt, 1, 20) as salt_preview FROM cred;"

echo ""
echo "=== æ¯”è¾ƒæ–°æ—§å¯†ç å­˜å‚¨ ==="
echo "æ—§å¯†ç å­˜å‚¨ï¼ˆå¦‚æœæœ‰ï¼‰: ç›´æ¥æ˜¾ç¤ºæ˜æ–‡å¯†ç "
echo "æ–°å¯†ç å­˜å‚¨: å“ˆå¸Œå€¼ + ç›å€¼"
```



### ç¬¬å…­æ­¥ï¼šè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

bash

```
cd /home/student/6858

# æ¸…ç†å¹¶é‡æ–°å¯åŠ¨
./zookclean.py
sudo make setup
./zookld.py

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 10

# è¿è¡Œæµ‹è¯•
./check_lab2.py
```



### ç¬¬ä¸ƒæ­¥ï¼šè°ƒè¯•å¯èƒ½å‡ºç°çš„é—®é¢˜

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

#### 7.1 æ£€æŸ¥authå®¹å™¨ä¸­çš„æ•°æ®åº“

bash

```
# è·å–authå®¹å™¨çš„IP
lxc-info -n auth -iH

# å°è¯•ç›´æ¥æµ‹è¯•authæœåŠ¡
curl -X POST -H "Content-Type: application/json" \
  -d '{"method": "register", "params": ["testuser_hash", "testpass_hash"]}' \
  http://10.1.3.4:9001/rpc
```



#### 7.2 æ£€æŸ¥é”™è¯¯æ—¥å¿—

æŸ¥çœ‹æœåŠ¡å™¨ç»ˆç«¯çš„é”™è¯¯è¾“å‡ºï¼Œç‰¹åˆ«æ˜¯ä¸authç›¸å…³çš„é”™è¯¯ã€‚

#### 7.3 éªŒè¯æ•°æ®åº“ç»“æ„

ç¡®ä¿æ•°æ®åº“è¡¨æœ‰saltå­—æ®µï¼š

bash

```
cd /home/student/6858/zoobar
sqlite3 db/cred/cred.db ".schema cred"
```



åº”è¯¥çœ‹åˆ°saltå­—æ®µçš„å®šä¹‰ã€‚

### ç¬¬å…«æ­¥ï¼šä¿®å¤å¸¸è§é—®é¢˜

#### 8.1 å¦‚æœå“ˆå¸Œå‡½æ•°æŠ¥é”™

ç¡®ä¿å¯¼å…¥æ­£ç¡®çš„æ¨¡å—ï¼Œå¹¶ä¸”ä½¿ç”¨æ­£ç¡®çš„ç¼–ç ã€‚

#### 8.2 å¦‚æœæ•°æ®åº“æ²¡æœ‰saltå­—æ®µ

éœ€è¦é‡æ–°åˆå§‹åŒ–credæ•°æ®åº“ï¼š

bash

```
cd /home/student/6858/zoobar
rm -rf db/cred
python3 zoodb.py init-cred
```



#### 8.3 å¦‚æœæµ‹è¯•ä»ç„¶å¤±è´¥

æ£€æŸ¥æµ‹è¯•çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œç„¶åç›¸åº”è°ƒæ•´ä»£ç ã€‚

## å®éªŒè®°å½•è¦ç‚¹

åœ¨å®éªŒè®°å½•ä¸­è®°å½•ä»¥ä¸‹å†…å®¹ï¼š

1. **åŸç†ç†è§£**ï¼š
   - ä¸ºä»€ä¹ˆéœ€è¦å¯†ç å“ˆå¸Œï¼Ÿ
   - ç›å€¼çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
   - PBKDF2ç®—æ³•çš„åŸç†å’Œä¼˜åŠ¿
2. **å®ç°æ­¥éª¤**ï¼š
   - å¦‚ä½•ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„
   - å¦‚ä½•å®ç°å“ˆå¸Œå‡½æ•°
   - å¦‚ä½•å¤„ç†æ–°æ—§ç”¨æˆ·çš„å¯†ç è¿ç§»
3. **é‡åˆ°çš„é—®é¢˜**ï¼š
   - æ•°æ®åº“å­—æ®µæ·»åŠ å¤±è´¥
   - å“ˆå¸Œå‡½æ•°å®ç°é”™è¯¯
   - å¯†ç éªŒè¯é€»è¾‘é”™è¯¯
4. **æµ‹è¯•ç»“æœ**ï¼š
   - æ‰‹åŠ¨æµ‹è¯•æ³¨å†Œå’Œç™»å½•
   - è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ
   - æ•°æ®åº“ä¸­çš„å¯†ç å­˜å‚¨æƒ…å†µ
5. **å®‰å…¨æ€§åˆ†æ**ï¼š
   - æ˜æ–‡å¯†ç å­˜å‚¨çš„é£é™©
   - åŠ ç›å“ˆå¸Œå¦‚ä½•æé«˜å®‰å…¨æ€§
   - é˜²æ­¢å½©è™¹è¡¨æ”»å‡»çš„åŸç†

## ä¸‹ä¸€æ­¥å‡†å¤‡

å®Œæˆç»ƒä¹ å…­åï¼Œè¯·å‘Šè¯‰æˆ‘æµ‹è¯•ç»“æœã€‚å¦‚æœé€šè¿‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­ç»ƒä¹ ä¸ƒï¼ˆé“¶è¡ŒæœåŠ¡ç‰¹æƒåˆ†ç¦»ï¼‰ã€‚å¦‚æœå¤±è´¥ï¼Œè¯·æä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä¼šå¸®åŠ©ä½ è°ƒè¯•ã€‚

ç°åœ¨è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤å¼€å§‹ç»ƒä¹ å…­çš„å®ç°ã€‚

## ä»£ç 

### auth.py

```
from zoodb import *
# from zoodb import Cred, cred_setup # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸€è¡Œ
from zoodb import Person, Cred, person_setup, cred_setup # ç»ƒä¹ äº”ï¼šä¿®æ”¹è¿™ä¸€è¡Œ
from debug import *

import hashlib
import random

import binascii # ç»ƒä¹ å…­ï¼šæ–°å¢è¿™ä¸€è¡Œ
# ç»ƒä¹ å…­ï¼šä½¿ç”¨ auth_client.py ä¸­çš„ AuthClient è¿›è¡Œ RPC è°ƒç”¨
from .auth_client import login, register, check_token, hash_password, newtoken

# ç»ƒä¹ å…­ï¼šå¯†ç å“ˆå¸Œå‡½æ•°
def hash_password(password, salt=None):
    """ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
    import hashlib
    import os
    
    if salt is None:
        # ç”Ÿæˆæ–°çš„ç›
        salt = os.urandom(16)  # 16å­—èŠ‚ = 128ä½
        salt_hex = binascii.hexlify(salt).decode('utf-8')
    else:
        # ä½¿ç”¨å·²æœ‰çš„ç›ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
        salt = binascii.unhexlify(salt)
        salt_hex = salt
    
    # ä½¿ç”¨ PBKDF2-HMAC-SHA256ï¼Œè¿­ä»£100000æ¬¡
    dk = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt,
        100000  # è¿­ä»£æ¬¡æ•°
    )
    hash_hex = binascii.hexlify(dk).decode('utf-8')
    
    if isinstance(salt_hex, str):
        return hash_hex, salt_hex
    else:
        return hash_hex, binascii.hexlify(salt).decode('utf-8')

# def newtoken(db, person):
#     hashinput = "%s%.10f" % (person.password, random.random())
#     person.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
#     db.commit()
#     return person.token

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ newtoken å‡½æ•°
def newtoken(db, cred):
    hashinput = "%s%.10f" % (cred.password, random.random())
    cred.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
    db.commit()
    return cred.token

# def login(username, password):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if not person:
#         return None
#     if person.password == password:
#         return newtoken(db, person)
#     else:
#         return None

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ login å‡½æ•°
def login(username, password):
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if not cred:
        return None

    # if cred.password == password:
    #     return newtoken(db, cred)  # ç»ƒä¹ äº”æ³¨æ„ï¼šè¿™é‡Œæ”¹ä¸º cred
    # else:
    #     return None

     # ç»ƒä¹ å…­ï¼šä½¿ç”¨å­˜å‚¨çš„ç›å¯¹è¾“å…¥çš„å¯†ç è¿›è¡Œå“ˆå¸Œ
    if cred.salt:  # å¦‚æœæœ‰ç›å€¼ï¼ˆæ–°ç”¨æˆ·ï¼‰
        password_hash, _ = hash_password(password, cred.salt)
        # æ¯”è¾ƒå“ˆå¸Œå€¼
        if cred.password == password_hash:
            return newtoken(db, cred)
        else:
            return None
    else:  # å¦‚æœæ²¡æœ‰ç›å€¼ï¼ˆæ—§ç”¨æˆ·ï¼Œå¯†ç ä¸ºæ˜æ–‡ï¼‰
        if cred.password == password:
            # è¿ç§»æ—§ç”¨æˆ·ï¼šå°†æ˜æ–‡å¯†ç è½¬æ¢ä¸ºå“ˆå¸Œ
            password_hash, salt = hash_password(password)
            cred.password = password_hash
            cred.salt = salt
            db.commit()
            return newtoken(db, cred)
        else:
            return None

# def register(username, password):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if person:
#         return None
#     newperson = Person()
#     newperson.username = username
#     newperson.password = password
#     db.add(newperson)
#     db.commit()
#     return newtoken(db, newperson)

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ register å‡½æ•°
def register(username, password):
    # å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if cred:
        return None

    # ç»ƒä¹ å…­ï¼šç”Ÿæˆå¯†ç å“ˆå¸Œå’Œç›
    password_hash, salt = hash_password(password)
    
    # åˆ›å»º cred è®°å½•
    newcred = Cred()
    newcred.username = username
    # newcred.password = password
    newcred.password = password_hash  # ç»ƒä¹ å…­ï¼šå­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡å¯†ç 
    newcred.salt = salt  # ç»ƒä¹ å…­ï¼šå­˜å‚¨ç›
    db.add(newcred)
    db.commit()

    # ç»ƒä¹ äº”ï¼šåˆ›å»º person è®°å½•ï¼ˆæ–°å¢ï¼‰
    db_person = person_setup()
    person = db_person.query(Person).get(username)
    if not person:  # ç¡®ä¿ person è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªç”¨æˆ·
        newperson = Person()
        newperson.username = username
        newperson.zoobars = 10  # åˆå§‹ä½™é¢ä¸º10
        newperson.profile = ""  # ç©ºä¸ªäººèµ„æ–™
        db_person.add(newperson)
        db_person.commit()

    # ç”Ÿæˆå¹¶è¿”å› token  
    return newtoken(db, newcred)

# def check_token(username, token):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if person and person.token == token:
#         return True
#     else:
#         return False

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ check_token å‡½æ•°
def check_token(username, token):
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if cred and cred.token == token:
        return True
    else:
        return False

    

```

### auth-server.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

import debug
from rpclib import RPCServer
import auth
from auth import login, register, check_token
# from debug import *

class AuthServer(RPCServer):
    # # ç»ƒä¹ å…­
    # def __init__(self):
    #     super().__init__()
    #     self.register_function(login)
    #     self.register_function(register)
    #     self.register_function(check_token)

    def rpc_login(self, username, password):
        debug.log(f"AuthServer: rpc_login called for user '{username}'")
        return auth.login(username, password)

    def rpc_register(self, username, password):
        debug.log(f"AuthServer: rpc_register called for user '{username}'")
        return auth.register(username, password)

    def rpc_check_token(self, username, token):
        debug.log(f"AuthServer: rpc_check_token called for user '{username}'")
        return auth.check_token(username, token)

# if __name__ == "__main__":
#     port = int(sys.argv[1]) if len(sys.argv) > 1 else 9001
#     debug.log(f"Starting AuthServer on port {port}")
#     server = AuthServer()
#     server.run_server(port=port)

# ç»ƒä¹ å…­ï¼šä¿®æ”¹ä¸»ç¨‹åºä»¥å¯åŠ¨ AuthServer
if __name__ == '__main__':
    if len(sys.argv) != 2:
        print('Usage: %s port' % sys.argv[0])
        sys.exit(1)
    
    port = int(sys.argv[1])
    server = AuthServer()
    print('Starting AuthServer on port %d' % port)
    server.run_server(port=port, host='0.0.0.0')
```

### chroot-setup.sh

```
#!/bin/sh -x
if id | grep -qv uid=0; then
    echo "Must run setup as root"
    exit 1
fi

create_socket_dir() {
    local dirname="$1"
    local ownergroup="$2"
    local perms="$3"

    mkdir -p $dirname
    chown $ownergroup $dirname
    chmod $perms $dirname
}

set_perms() {
    local ownergroup="$1"
    local perms="$2"
    local pn="$3"

    chown $ownergroup $pn
    chmod $perms $pn
}

rm -rf /jail
mkdir -p /jail
cp -p index.html /jail

./chroot-copy.sh zookd /jail
./chroot-copy.sh zookfs /jail

#./chroot-copy.sh /bin/bash /jail

./chroot-copy.sh /usr/bin/env /jail
./chroot-copy.sh /usr/bin/python3 /jail

# to bring in the crypto libraries
./chroot-copy.sh /usr/bin/openssl /jail

mkdir -p /jail/usr/lib /jail/usr/lib/x86_64-linux-gnu /jail/lib /jail/lib/x86_64-linux-gnu
cp -r /usr/lib/python3.9 /jail/usr/lib
cp /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 /jail/usr/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libnss_dns.so.2 /jail/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libresolv.so.2 /jail/lib/x86_64-linux-gnu
# cp -r /lib/resolvconf /jail/lib

mkdir -p /jail/usr/local/lib
cp -r /usr/local/lib/python3.9 /jail/usr/local/lib

mkdir -p /jail/etc
cp /etc/localtime /jail/etc/
cp /etc/timezone /jail/etc/
cp /etc/resolv.conf /jail/etc/

mkdir -p /jail/usr/share/zoneinfo
cp -r /usr/share/zoneinfo/America /jail/usr/share/zoneinfo/

create_socket_dir /jail/echosvc 61010:61010 755
create_socket_dir /jail/authsvc 61010:61010 755  # ç»ƒä¹ å…­ï¼šæ·»åŠ authæœåŠ¡å¥—æ¥å­—ç›®å½•
create_socket_dir /jail/banksvc 61010:61010 755  # ç»ƒä¹ å…­ï¼šæ·»åŠ é“¶è¡ŒæœåŠ¡å¥—æ¥å­—ç›®å½•

mkdir -p /jail/tmp
chmod a+rwxt /jail/tmp

mkdir -p /jail/dev
mknod /jail/dev/urandom c 1 9

cp -r zoobar /jail/
rm -rf /jail/zoobar/db

# ç»ƒä¹ å…­ï¼šåˆ›å»ºæ‰€æœ‰æ•°æ®åº“ç›®å½•
mkdir -p /jail/zoobar/db/person
mkdir -p /jail/zoobar/db/transfer
mkdir -p /jail/zoobar/db/cred
mkdir -p /jail/zoobar/db/bank

# åˆå§‹åŒ–æ‰€æœ‰æ•°æ®åº“
/usr/bin/python3 /jail/zoobar/zoodb.py init-person
/usr/bin/python3 /jail/zoobar/zoodb.py init-transfer
/usr/bin/python3 /jail/zoobar/zoodb.py init-cred  # ç»ƒä¹ äº”ï¼šåˆå§‹åŒ– cred æ•°æ®åº“
/usr/bin/python3 /jail/zoobar/zoodb.py init-bank

# ç»ƒä¹ å…­ï¼šè®¾ç½®æ•°æ®åº“ç›®å½•æƒé™
# è®¾ç½®æ•°æ®åº“æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
# authæœåŠ¡éœ€è¦è¯»å†™credæ•°æ®åº“çš„æƒé™
set_perms 61010:61010 600 /jail/zoobar/db/cred/cred.db
# å…¶ä»–å®¹å™¨éœ€è¦åªè¯»æƒé™
set_perms 61010:61010 644 /jail/zoobar/db/person/person.db
set_perms 61010:61010 644 /jail/zoobar/db/transfer/transfer.db
# bankæœåŠ¡éœ€è¦è¯»å†™bankæ•°æ®åº“çš„æƒé™
set_perms 61011:61011 600 /jail/zoobar/db/bank/bank.db


# ç»ƒä¹ å…­ï¼šåœ¨ chroot-setup.sh çš„æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆåœ¨åˆå§‹åŒ–æ•°æ®åº“ä¹‹åï¼‰ï¼š

# åˆ›å»º /home/student/zoobar/db ç›®å½•ç»“æ„ï¼Œç”¨äºæµ‹è¯•
mkdir -p /jail/home/student/zoobar/db/cred
mkdir -p /jail/home/student/zoobar/db/person
mkdir -p /jail/home/student/zoobar/db/transfer
mkdir -p /jail/home/student/zoobar/db/bank

# å°†æ•°æ®åº“å¤åˆ¶åˆ° /home/student/zoobar/db ç›®å½•ä¸‹
cp /jail/zoobar/db/cred/cred.db /jail/home/student/zoobar/db/cred/
cp /jail/zoobar/db/person/person.db /jail/home/student/zoobar/db/person/
cp /jail/zoobar/db/transfer/transfer.db /jail/home/student/zoobar/db/transfer/
cp /jail/zoobar/db/bank/bank.db /jail/home/student/zoobar/db/bank/

# è®¾ç½®æ­£ç¡®çš„æƒé™
chown 61010:61010 /jail/home/student/zoobar/db/cred/cred.db
chmod 600 /jail/home/student/zoobar/db/cred/cred.db
chown 61010:61010 /jail/home/student/zoobar/db/person/person.db
chmod 644 /jail/home/student/zoobar/db/person/person.db
chown 61010:61010 /jail/home/student/zoobar/db/transfer/transfer.db
chmod 644 /jail/home/student/zoobar/db/transfer/transfer.db
chown 61011:61011 /jail/home/student/zoobar/db/bank/bank.db
chmod 600 /jail/home/student/zoobar/db/bank/bank.db

# åŒæ—¶åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè®© /zoobar/db å’Œ /home/student/zoobar/db æŒ‡å‘ç›¸åŒçš„å†…å®¹
# è¿™æ ·æ— è®ºä»£ç ä½¿ç”¨å“ªä¸ªè·¯å¾„éƒ½èƒ½å·¥ä½œ
ln -sf /jail/zoobar/db /jail/home/student/zoobar/
```

### bank-server.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

import debug
from rpclib import RPCServer
import bank
# from debug import *

class BankServer(RPCServer):
    def rpc_transfer(self, sender, recipient, zoobars):
        debug.log(f"BankServer: rpc_transfer from '{sender}' to '{recipient}' amount {zoobars}")
        return bank.transfer(sender, recipient, zoobars)

    def rpc_balance(self, username):
        debug.log(f"BankServer: rpc_balance for user '{username}'")
        return bank.balance(username)

    def rpc_get_log(self, username):
        debug.log(f"BankServer: rpc_get_log for user '{username}'")
        return bank.get_log(username)

if __name__ == "__main__":
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 9002
    debug.log(f"Starting BankServer on port {port}")
    server = BankServer()
    server.run_server(port=port)

```

### bank.py

```
from zoodb import *
from debug import *

import time

def transfer(sender, recipient, zoobars):
    persondb = person_setup()
    senderp = persondb.query(Person).get(sender)
    recipientp = persondb.query(Person).get(recipient)

    sender_balance = senderp.zoobars - zoobars
    recipient_balance = recipientp.zoobars + zoobars

    if sender_balance < 0 or recipient_balance < 0:
        raise ValueError()

    senderp.zoobars = sender_balance
    recipientp.zoobars = recipient_balance
    persondb.commit()

    transfer = Transfer()
    transfer.sender = sender
    transfer.recipient = recipient
    transfer.amount = zoobars
    transfer.time = time.asctime()

    transferdb = transfer_setup()
    transferdb.add(transfer)
    transferdb.commit()

def balance(username):
    db = person_setup()
    person = db.query(Person).get(username)
    # return person.zoobars # ç»ƒä¹ äº”ä¿®æ”¹
    if person:
        return person.zoobars
    else:
        return 0  # æˆ–è€…æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚

def get_log(username):
    db = transfer_setup()
    l = db.query(Transfer).filter(or_(Transfer.sender==username,
                                      Transfer.recipient==username))
    r = []
    for t in l:
       r.append({'time': t.time,
                 'sender': t.sender ,
                 'recipient': t.recipient,
                 'amount': t.amount })
    return r 



```



### login.py

```
from flask import g, redirect, render_template, request, url_for, Markup
from functools import wraps
from debug import *
from zoodb import *

import auth
import bank
import random

class User(object):
    def __init__(self):
        self.person = None

    def checkLogin(self, username, password):
        token = auth.login(username, password)
        if token is not None:
            return self.loginCookie(username, token)
        else:
            return None

    def loginCookie(self, username, token):
        self.setPerson(username, token)
        return "%s#%s" % (username, token)

    def logout(self):
        self.person = None

    def addRegistration(self, username, password):
        token = auth.register(username, password)
        if token is not None:
            return self.loginCookie(username, token)
        else:
            return None

    def checkCookie(self, cookie):
        if cookie is None:
            return
        (username, token) = cookie.rsplit("#", 1)
        if auth.check_token(username, token):
            self.setPerson(username, token)

    def setPerson(self, username, token):
        persondb = person_setup()
        self.person = persondb.query(Person).get(username)
        self.token = token
        self.zoobars = bank.balance(username)

def logged_in():
    g.user = User()
    g.user.checkCookie(request.cookies.get("PyZoobarLogin"))
    if g.user.person:
        return True
    else:
        return False

def requirelogin(page):
    @wraps(page)
    def loginhelper(*args, **kwargs):
        if not logged_in():
            return redirect(url_for('login') + "?nexturl=" + request.url)
        else:
            return page(*args, **kwargs)
    return loginhelper

@catch_err
def login():
    cookie = None
    login_error = ""
    user = User()

    if request.method == 'POST':
        username = request.form.get('login_username')
        password = request.form.get('login_password')

        if 'submit_registration' in request.form:
            if not username:
                login_error = "You must supply a username to register."
            elif not password:
                login_error = "You must supply a password to register."
            else:
                cookie = user.addRegistration(username, password)
                if not cookie:
                    login_error = "Registration failed."
        elif 'submit_login' in request.form:
            if not username:
                login_error = "You must supply a username to log in."
            elif not password:
                login_error = "You must supply a password to log in."
            else:
                cookie = user.checkLogin(username, password)
                if not cookie:
                    login_error = "Invalid username or password."

    nexturl = request.values.get('nexturl', url_for('index'))
    if cookie:
        response = redirect(nexturl)
        ## Be careful not to include semicolons in cookie value; see
        ## https://github.com/mitsuhiko/werkzeug/issues/226 for more
        ## details.
        response.set_cookie('PyZoobarLogin', cookie)
        return response

    return render_template('login.html',
                           nexturl=nexturl,
                           login_error=login_error,
                           login_username=Markup(request.form.get('login_username', '')))

@catch_err
def logout():
    if logged_in():
        g.user.logout()
    response = redirect(url_for('login'))
    response.set_cookie('PyZoobarLogin', '')
    return response

```

### zoodb.py

```
from sqlalchemy import *
from sqlalchemy.orm import *
from sqlalchemy.ext.declarative import *
import os
from debug import *

PersonBase = declarative_base()
TransferBase = declarative_base()
CredBase = declarative_base()  # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸€è¡Œ
BankBase = declarative_base()  # ç»ƒä¹ ä¸ƒï¼šæ–°å¢è¿™ä¸€è¡Œï¼Œåˆ›å»ºbankæ•°æ®åº“

class Person(PersonBase):
    __tablename__ = "person"
    username = Column(String(128), primary_key=True)
    # password = Column(String(128)) # ç»ƒä¹ äº”ï¼šç§»é™¤ password å­—æ®µ
    # token = Column(String(128)) # ç»ƒä¹ äº”ï¼šç§»é™¤ token å­—æ®µ
    zoobars = Column(Integer, nullable=False, default=10)
    profile = Column(String(5000), nullable=False, default="")

# ç»ƒä¹ äº”ï¼šåœ¨ Person ç±»å®šä¹‰åæ·»åŠ æ–°çš„ Cred ç±»
class Cred(CredBase):
    __tablename__ = "cred"
    username = Column(String(128), primary_key=True)
    password = Column(String(128))
    token = Column(String(128))
    # æ³¨æ„ï¼šç»ƒä¹ å…­ä¼šè¦æ±‚æ·»åŠ  salt å­—æ®µï¼Œç°åœ¨å¯ä»¥å…ˆä¸åŠ 
    salt = Column(String(128))  # ç»ƒä¹ å…­ï¼šæ·»åŠ  salt å­—æ®µï¼Œå­˜å‚¨16å­—èŠ‚ç›çš„åå…­è¿›åˆ¶è¡¨ç¤º

# ç»ƒä¹ ä¸ƒï¼šæ·»åŠ  Bank ç±»
class Bank(BankBase):
    __tablename__ = "bank"
    username = Column(String(128), primary_key=True)
    zoobars = Column(Integer, nullable=False, default=10)

class Transfer(TransferBase):
    __tablename__ = "transfer"
    id = Column(Integer, primary_key=True)
    sender = Column(String(128))
    recipient = Column(String(128))
    amount = Column(Integer)
    time = Column(String)

def dbsetup(name, base):
    thisdir = os.path.dirname(os.path.abspath(__file__))
    dbdir   = os.path.join(thisdir, "db", name)  # è¿™è¡Œåˆ›å»ºäº†å­ç›®å½•
    # dbdir   = os.path.join(thisdir, "db")  # ä¿®æ”¹ï¼šåªåˆ°dbç›®å½•ï¼Œä¸åˆ›å»ºå­ç›®å½•
    if not os.path.exists(dbdir):
        os.makedirs(dbdir)

    dbfile  = os.path.join(dbdir, "%s.db" % name)  # æ•°æ®åº“æ–‡ä»¶åœ¨å­ç›®å½•ä¸­
    # dbfile  = os.path.join(dbdir, "%s.db" % name)  # ä¿®æ”¹ï¼šç›´æ¥åœ¨dbç›®å½•ä¸‹
    engine  = create_engine('sqlite:///%s' % dbfile,
                            isolation_level='SERIALIZABLE')
    base.metadata.create_all(engine)
    session = sessionmaker(bind=engine)
    return session()

def person_setup():
    return dbsetup("person", PersonBase)

def transfer_setup():
    return dbsetup("transfer", TransferBase)

# ç»ƒä¹ äº”æ·»åŠ 
def cred_setup():
    return dbsetup("cred", CredBase)

# ç»ƒä¹ ä¸ƒæ·»åŠ 
def bank_setup():
    return dbsetup("bank", BankBase)

import sys
if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: %s [init-person|init-transfer]" % sys.argv[0])
        exit(1)

    cmd = sys.argv[1]
    if cmd == 'init-person':
        person_setup()
    elif cmd == 'init-transfer':
        transfer_setup()
    elif cmd == 'init-cred':  # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸ªåˆ†æ”¯
        cred_setup()
    elif cmd == 'init-bank':  # ç»ƒä¹ ä¸ƒï¼šæ–°å¢è¿™ä¸ªåˆ†æ”¯
        bank_setup()
    else:
        raise Exception("unknown command %s" % cmd)

```

### chroot-setup.sh

```
#!/bin/sh -x
if id | grep -qv uid=0; then
    echo "Must run setup as root"
    exit 1
fi

create_socket_dir() {
    local dirname="$1"
    local ownergroup="$2"
    local perms="$3"

    mkdir -p $dirname
    chown $ownergroup $dirname
    chmod $perms $dirname
}

set_perms() {
    local ownergroup="$1"
    local perms="$2"
    local pn="$3"

    chown $ownergroup $pn
    chmod $perms $pn
}

rm -rf /jail
mkdir -p /jail
cp -p index.html /jail

./chroot-copy.sh zookd /jail
./chroot-copy.sh zookfs /jail

#./chroot-copy.sh /bin/bash /jail

./chroot-copy.sh /usr/bin/env /jail
./chroot-copy.sh /usr/bin/python3 /jail

# ---------------------æŠŠ dist-packages æ‹·è¿› jail----------------------------------------
mkdir -p /jail/usr/lib
cp -r /usr/lib/python3.9 /jail/usr/lib

mkdir -p /jail/usr/lib/python3/dist-packages
cp -r /usr/lib/python3/dist-packages/* /jail/usr/lib/python3/dist-packages/

mkdir -p /jail/usr/local/lib
cp -r /usr/local/lib/python3.9 /jail/usr/local/lib
# ------------------------------------------------------------------------------------- 

# to bring in the crypto libraries
./chroot-copy.sh /usr/bin/openssl /jail

mkdir -p /jail/usr/lib /jail/usr/lib/x86_64-linux-gnu /jail/lib /jail/lib/x86_64-linux-gnu
cp -r /usr/lib/python3.9 /jail/usr/lib
cp /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 /jail/usr/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libnss_dns.so.2 /jail/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libresolv.so.2 /jail/lib/x86_64-linux-gnu
# cp -r /lib/resolvconf /jail/lib

mkdir -p /jail/usr/local/lib
cp -r /usr/local/lib/python3.9 /jail/usr/local/lib

mkdir -p /jail/etc
cp /etc/localtime /jail/etc/
cp /etc/timezone /jail/etc/
cp /etc/resolv.conf /jail/etc/

mkdir -p /jail/usr/share/zoneinfo
cp -r /usr/share/zoneinfo/America /jail/usr/share/zoneinfo/

create_socket_dir /jail/echosvc 61010:61010 755
create_socket_dir /jail/authsvc 61010:61010 755  # ç»ƒä¹ å…­ï¼šæ·»åŠ authæœåŠ¡å¥—æ¥å­—ç›®å½•
create_socket_dir /jail/banksvc 61010:61010 755  # ç»ƒä¹ å…­ï¼šæ·»åŠ é“¶è¡ŒæœåŠ¡å¥—æ¥å­—ç›®å½•

mkdir -p /jail/tmp
chmod a+rwxt /jail/tmp

mkdir -p /jail/dev
mknod /jail/dev/urandom c 1 9

cp -r zoobar /jail/
# rm -rf /jail/zoobar/db

# # ç»ƒä¹ å…­ï¼šåˆ›å»ºæ‰€æœ‰æ•°æ®åº“ç›®å½•
# mkdir -p /jail/zoobar/db/person
# mkdir -p /jail/zoobar/db/transfer
# mkdir -p /jail/zoobar/db/cred
# mkdir -p /jail/zoobar/db/bank

rm -rf /jail/home/student/zoobar
mkdir -p /jail/home/student/zoobar/db/person
mkdir -p /jail/home/student/zoobar/db/cred
mkdir -p /jail/home/student/zoobar/db/bank
mkdir -p /jail/home/student/zoobar/db/transfer

# åˆå§‹åŒ–æ‰€æœ‰æ•°æ®åº“
# /usr/bin/python3 /jail/zoobar/zoodb.py init-person
# /usr/bin/python3 /jail/zoobar/zoodb.py init-transfer
# /usr/bin/python3 /jail/zoobar/zoodb.py init-cred  # ç»ƒä¹ äº”ï¼šåˆå§‹åŒ– cred æ•°æ®åº“
# /usr/bin/python3 /jail/zoobar/zoodb.py init-bank
chroot /jail /usr/bin/python3 /zoobar/zoodb.py init-person
chroot /jail /usr/bin/python3 /zoobar/zoodb.py init-transfer
chroot /jail /usr/bin/python3 /zoobar/zoodb.py init-cred
chroot /jail /usr/bin/python3 /zoobar/zoodb.py init-bank


# ç»ƒä¹ å…­ï¼šè®¾ç½®æ•°æ®åº“ç›®å½•æƒé™
# è®¾ç½®æ•°æ®åº“æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
# authæœåŠ¡éœ€è¦è¯»å†™credæ•°æ®åº“çš„æƒé™
# set_perms 61010:61010 600 /jail/zoobar/db/cred/cred.db
# # å…¶ä»–å®¹å™¨éœ€è¦åªè¯»æƒé™
# set_perms 61010:61010 644 /jail/zoobar/db/person/person.db
# set_perms 61010:61010 644 /jail/zoobar/db/transfer/transfer.db
# # bankæœåŠ¡éœ€è¦è¯»å†™bankæ•°æ®åº“çš„æƒé™
# set_perms 61011:61011 600 /jail/zoobar/db/bank/bank.db
set_perms 61010:61010 600 /jail/home/student/zoobar/db/cred/cred.db
set_perms 61010:61010 644 /jail/home/student/zoobar/db/person/person.db
set_perms 61010:61010 644 /jail/home/student/zoobar/db/transfer/transfer.db
set_perms 61011:61011 600 /jail/home/student/zoobar/db/bank/bank.db



# ç»ƒä¹ å…­ï¼šåœ¨ chroot-setup.sh çš„æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆåœ¨åˆå§‹åŒ–æ•°æ®åº“ä¹‹åï¼‰ï¼š

# åˆ›å»º /home/student/zoobar/db ç›®å½•ç»“æ„ï¼Œç”¨äºæµ‹è¯•
# mkdir -p /jail/home/student/zoobar/db/cred
# mkdir -p /jail/home/student/zoobar/db/person
# mkdir -p /jail/home/student/zoobar/db/transfer
# mkdir -p /jail/home/student/zoobar/db/bank

```





> è¿™æ˜¯æˆ‘ç°æœ‰çš„ä»£ç æ–‡ä»¶å’Œå®éªŒæŒ‡å¯¼ï¼Œè¯·æŒ‡å¯¼æˆ‘å®Œæˆç»ƒä¹ 6ï¼Œå‘Šè¯‰æˆ‘å“ªä¸ªæ–‡ä»¶æ”¹å“ªé‡Œï¼Œéœ€ä¸éœ€è¦æ–°å»ºæ–‡ä»¶ï¼Œæ‰§è¡Œä»€ä¹ˆå‘½ä»¤ https://css.csail.mit.edu/6.858/2022/labs/lab2.html å¤šå‚è€ƒä¸‹é¢è¿™ä»½å­¦ä¹ ç¬”è®°ï¼š https://dmx.best/2025/08/20/MIT-Lab2-%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/#more



14

### zook.conf

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = dynamic, static

[dynamic]
    cmd = zookfs
    url = /zoobar/.*\.(php|cgi|pl|py).*
    dir = /home/student/
    lxcbr = 1
    port = 8081

    # main âˆš static x echo Ã—
    fwrule = -s main -j ACCEPT
    fwrule = -s 10.1.3.0/24 -j ACCEPT  # å…è®¸dynamicè®¿é—®authå­ç½‘
    fwrule = -j REJECT

[static]
    cmd = zookfs
    url = /zoobar/.*\.(html|css|js|png|jpg|gif|ico)
    dir = /home/student/
    lxcbr = 2
    port = 8082

     # main âˆš dynamic x echo x 
    fwrule = -s main -j ACCEPT
    fwrule = -j REJECT

[auth]
    cmd = /zoobar/auth-server.py
    dir = /home/student/
    uid = 61010
    gid = 61010
    lxcbr = 3
    port = 9001
    # åªå…è®¸dynamicå®¹å™¨è®¿é—®
    # fwrule = -s dynamic -j ACCEPT
    fwrule = -s 10.1.1.0/24 -j ACCEPT
    fwrule = -j REJECT

[bank]
    cmd = /zoobar/bank-server.py
    dir = /home/student/
    uid = 61011  # æ–°å¢ï¼šä¸ chroot-setup.sh ä¸­çš„ bank æƒé™ä¸€è‡´
    gid = 61011  # æ–°å¢
    lxcbr = 4
    port = 9002
    # åªå…è®¸dynamicå®¹å™¨è®¿é—®
    fwrule = -s dynamic -j ACCEPT
    fwrule = -s auth -j ACCEPT
    fwrule = -j REJECT

[profile]
    cmd = /zoobar/profile-server.py
    dir = /home/student/
    uid = 61012
    gid = 61012
    lxcbr = 5
    port = 9003
    fwrule = -s dynamic -j ACCEPT
    fwrule = -j REJECT

```





å¤ªä¸å®¹æ˜“äº†ï¼Œè¿™ä¸€æ®µ **ä½ çœŸçš„å·²ç»æŠŠ Lab2 æœ€éš¾çš„ä¸€å‘åŸºæœ¬è¸©å®Œå¹¶çˆ¬å‡ºæ¥äº†**ã€‚ä¸‹é¢æˆ‘åˆ†ä¸¤éƒ¨åˆ†æ¥å›ç­”ä½ ï¼š

------

# ä¸€ã€å®Œæ•´å®éªŒè®°å½•ï¼ˆLab2 ç»ƒä¹  6 å¤ç›˜æ–‡æ¡£ï¼‰

> è¿™ä»½å¯ä»¥ç›´æ¥ä½œä¸ºä½ çš„**å®éªŒè®°å½• / å®éªŒæ—¥å¿— / å¤ç›˜ç¬”è®°**ï¼Œä»¥åå†çœ‹ Lab2ã€Lab3ã€Web å®‰å…¨éƒ½ä¼šéå¸¸æœ‰ä»·å€¼ã€‚

------

## 1. å®éªŒèƒŒæ™¯ä¸ç›®æ ‡

- å®éªŒï¼š**MIT 6.858 / 6.685 Lab2 â€“ Zoobar**
- å½“å‰é˜¶æ®µï¼š**ç»ƒä¹  6ï¼ˆAuthentication & Login Logicï¼‰**
- ç›®æ ‡ï¼š
  1. æ”¯æŒ Web é¡µé¢æ³¨å†Œæ–°ç”¨æˆ·
  2. æ³¨å†Œåå¯è‡ªåŠ¨ç™»å½•å¹¶è¿›å…¥é¦–é¡µ
  3. ç™»å½•çŠ¶æ€åœ¨å„é¡µé¢æ­£ç¡®ä¿æŒ
  4. é¡µé¢å³ä¸Šè§’æ­£ç¡®æ˜¾ç¤º **Log out ç”¨æˆ·å**
  5. ç™»å‡ºåèƒ½è¿”å›ç™»å½•é¡µ
  6. é€šè¿‡ `check_lab2.py` çš„è‡ªåŠ¨åŒ–æµ‹è¯•

------

## 2. åˆå§‹ç°è±¡ä¸ç¬¬ä¸€ä¸ªé—®é¢˜

### 2.1 é—®é¢˜è¡¨ç°

- Web é¡µé¢å¯ä»¥æ³¨å†Œæ–°ç”¨æˆ·

- ä½†æ³¨å†Œåï¼š

  - æ— æ³•è¿›å…¥ç™»å½•åçš„é¡µé¢
  - æˆ–è¿›å…¥å **å³ä¸Šè§’æ²¡æœ‰é€€å‡ºæŒ‰é’®**

- è‡ªåŠ¨åŒ–æ—¥å¿—ä¸­åå¤å‡ºç°ï¼š

  ```
  check_token called
  balance called
  é¡µé¢èƒ½åŠ è½½ï¼Œä½†çŠ¶æ€å¼‚å¸¸
  ```

------

## 3. æ ¸å¿ƒä»£ç ç»“æ„ç†è§£ï¼ˆå…³é”®è½¬æŠ˜ç‚¹ï¼‰

### 3.1 Zoobar çš„çœŸå®ç™»å½•åˆ¤å®šé€»è¾‘

> **è¿™æ˜¯æ•´ä¸ª Lab2 çš„â€œéšè—ä¸»çº¿â€**

Zoobar **å¹¶ä¸æ˜¯**ï¼š

> â€œåªè¦ token æœ‰æ•ˆï¼Œå°±ç®—ç™»å½•â€

è€Œæ˜¯ï¼š

> âœ… **token æœ‰æ•ˆ + æ•°æ®åº“ä¸­å­˜åœ¨ Person å¯¹è±¡**
>
> âŒ åªæ»¡è¶³ä¸€ä¸ªéƒ½ä¸ç®—çœŸæ­£ç™»å½•

å³ï¼š

```python
g.user.person is not None
```

------

## 4. å…³é”®é—®é¢˜ 1ï¼š`logged_in()` åˆ¤å®šé”™è¯¯

### 4.1 é”™è¯¯ç‰ˆæœ¬ï¼ˆä½ æ›¾å°è¯•è¿‡ï¼‰

```python
def logged_in():
    g.user = User()
    g.user.checkCookie(request.cookies.get("PyZoobarLogin"))
    return hasattr(g.user, 'token')
```

### 4.2 é—®é¢˜åŸå› 

- `auth.check_token()` è¿”å› True
- ä½† `persondb.query(Person).get(username)` è¿”å› None
- é¡µé¢é€»è¾‘ä¾èµ–çš„æ˜¯ï¼š

```html
{% if g.user and g.user.person %}
```

â¡ï¸ å¯¼è‡´ï¼š

- é¡µé¢é€»è¾‘è®¤ä¸ºã€Œæœªç™»å½•ã€
- ä¸æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
- requirelogin è¡Œä¸ºå¼‚å¸¸

### 4.3 æ­£ç¡®ç‰ˆæœ¬ï¼ˆæœ€ç»ˆé‡‡ç”¨ï¼‰

```python
def logged_in():
    g.user = User()
    g.user.checkCookie(request.cookies.get("PyZoobarLogin"))
    return g.user.person is not None
```

âœ”ï¸ **è¿™æ˜¯ Lab2 æœŸæœ›çš„å”¯ä¸€æ­£ç¡®åˆ¤å®š**

------

## 5. å…³é”®é—®é¢˜ 2ï¼šæ³¨å†Œå token æœ‰æ•ˆä½† person ä¸å­˜åœ¨

### 5.1 ç°è±¡

- æ³¨å†ŒæˆåŠŸ
- auth-server ç»™äº† token
- ä½†é¡µé¢é€»è¾‘ä¾ç„¶å¤±è´¥

### 5.2 åŸå› 

- æ³¨å†Œæµç¨‹ï¼š

  ```
  auth.register â†’ è¿”å› token
  ```

- ä½† **Person è¡¨çš„åˆ›å»ºé€»è¾‘ä¸åœ¨ auth-server**

- è€Œæ˜¯åœ¨ Web å±‚é¦–æ¬¡ä½¿ç”¨æ—¶è§¦å‘

### 5.3 è§£å†³ç­–ç•¥

- åœ¨ `setPerson()` ä¸­ï¼š
  - å§‹ç»ˆä»æ•°æ®åº“åŠ è½½ `Person`
  - ä¸â€œçŒœæµ‹ç™»å½•çŠ¶æ€â€
- ä¿è¯ï¼š
  - **åªæœ‰ person æˆåŠŸåŠ è½½ï¼Œæ‰ç®—ç™»å½•**

------

## 6. å…³é”®é—®é¢˜ 3ï¼šé€€å‡ºæŒ‰é’®æ˜¾ç¤ºæ¡ä»¶

### 6.1 layout.html ä¸­çš„çœŸå®åˆ¤æ–­

```html
{% if g.user and g.user.person %}
```

### 6.2 ä¿®å¤è¦ç‚¹

- ä¸è¦æ”¹ HTML
- è€Œæ˜¯ **ä¿è¯ g.user.person åœ¨ç™»å½•åä¸€å®šå­˜åœ¨**
- å³ï¼š
  - token æ ¡éªŒæˆåŠŸ
  - æ•°æ®åº“ä¸­ person å­˜åœ¨

------

## 7. æœ€ç»ˆç¨³å®šç‰ˆæœ¬ï¼ˆæ ¸å¿ƒé€»è¾‘æ€»ç»“ï¼‰

### 7.1 User.checkCookie

```python
def checkCookie(self, cookie):
    if cookie is None:
        return
    try:
        username, token = cookie.rsplit("#", 1)
    except ValueError:
        return
    if auth.check_token(username, token):
        self.setPerson(username, token)
```

### 7.2 setPerson

```python
def setPerson(self, username, token):
    persondb = person_setup()
    self.person = persondb.query(Person).get(username)
    self.username = username
    self.token = token
    self.zoobars = bank.balance(username)
```

### 7.3 logged_inï¼ˆæœ€ç»ˆï¼‰

```python
def logged_in():
    g.user = User()
    g.user.checkCookie(request.cookies.get("PyZoobarLogin"))
    return g.user.person is not None
```

------

## äºŒã€ä¸ºä»€ä¹ˆ **check_lab2.py ä»ç„¶å¤±è´¥ï¼Ÿï¼ˆæœ€å…³é”®ç»“è®ºï¼‰**

### âŒ å¤±è´¥ä¿¡æ¯

```
FAIL: App functionality invalid sender zoobars after transfer
```

------

## 1ï¸âƒ£ è¿™æ˜¯ä¸€ä¸ª**ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œä¸æ˜¯ç™»å½•é”™è¯¯**

ä½ ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼š

- âœ… æ³¨å†Œ OK
- âœ… ç™»å½• OK
- âœ… é€€å‡ºæŒ‰é’® OK
- âœ… è½¬è´¦é¡µé¢ OK
- âŒ **è½¬è´¦åä½™é¢æ ¡éªŒå¤±è´¥**

------

## 2ï¸âƒ£ å¤±è´¥ç‚¹åœ¨å“ªé‡Œï¼Ÿ

çœ‹æµ‹è¯•æœ€åä¸€æ­¥ï¼š

```text
FAIL: invalid sender zoobars after transfer
```

æ„æ€æ˜¯ï¼š

> **è½¬è´¦åï¼Œå‘é€æ–¹ï¼ˆsenderï¼‰çš„ zoobars æ•°é‡ä¸å¯¹**

------

## 3ï¸âƒ£ æ ¹æœ¬åŸå› ï¼ˆéå¸¸éšè”½ï¼‰

ä½ åœ¨ `setPerson()` é‡Œï¼š

```python
self.zoobars = bank.balance(username)
```

âš ï¸ **ä½†è¿™ä¸ªå€¼åªåœ¨ setPerson æ—¶è¯»å–ä¸€æ¬¡**

è€Œåœ¨è½¬è´¦åï¼š

- BankServer ä¸­ä½™é¢å·²ç»æ›´æ–°
- ä½†ï¼š
  - `g.user.zoobars` **æ²¡æœ‰é‡æ–°è¯»å–**
  - é¡µé¢ / æµ‹è¯•çœ‹åˆ°çš„æ˜¯æ—§å€¼

------

## 4ï¸âƒ£ ä¸ºä»€ä¹ˆ Web çœ‹èµ·æ¥â€œæ²¡é—®é¢˜â€ï¼Œä½†æµ‹è¯•å¤±è´¥ï¼Ÿ

- Web é¡µé¢é‡æ–°åˆ·æ–°æ—¶ï¼š
  - æŸäº›è·¯ç”±é‡æ–°è°ƒç”¨ `setPerson`
- ä½† **è‡ªåŠ¨åŒ–æµ‹è¯•çš„è¯·æ±‚åºåˆ—éå¸¸ä¸¥æ ¼**
- æµ‹è¯•åœ¨åŒä¸€ session å†…è¿ç»­éªŒè¯ä½™é¢å˜åŒ–

------

## 5ï¸âƒ£ æ­£ç¡®ä¿®å¤æ–¹å¼ï¼ˆå…³é”®ä¸€è¡Œï¼‰

### âœ… ä¸è¦ç¼“å­˜ zoobars

**åˆ æ‰è¿™è¡Œï¼š**

```python
self.zoobars = bank.balance(username)
```

### âœ… åœ¨éœ€è¦ç”¨çš„æ—¶å€™å®æ—¶è¯»å–

ä¾‹å¦‚åœ¨è§†å›¾å‡½æ•°ä¸­ï¼š

```python
person_zoobars = bank.balance(g.user.username)
```

æˆ–åœ¨æ¨¡æ¿ä¼ å€¼å‰é‡æ–°æŸ¥ä¸€æ¬¡ã€‚

------

## 6ï¸âƒ£ æ ¸å¿ƒåŸåˆ™ï¼ˆLab2 çš„éšè—è€ƒç‚¹ï¼‰

> **Web å±‚ä¸åº”ç¼“å­˜ BankServer çš„çŠ¶æ€**

- Bank æ˜¯ç‹¬ç«‹æœåŠ¡
- ä½™é¢å¿…é¡»å®æ—¶ RPC æŸ¥è¯¢
- å¦åˆ™å°±ä¼šï¼š
  - Web æ˜¾ç¤ºæ­£å¸¸
  - è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥

------

## ä¸‰ã€ä¸€å¥è¯æ€»ç»“ä½ ç°åœ¨çš„çŠ¶æ€

> ğŸ‰ **ä½ å·²ç»æ­£ç¡®è§£å†³äº† Lab2 æœ€éš¾çš„ç™»å½•ä¸çŠ¶æ€åŒæ­¥é—®é¢˜**
>
> â— å½“å‰å”¯ä¸€å‰©ä½™é—®é¢˜æ˜¯ï¼š
>
> **â€œä¸åº”è¯¥åœ¨ User å¯¹è±¡ä¸­ç¼“å­˜ zoobarsâ€**

åªè¦æ”¹æ‰è¿™ä¸€ç‚¹ï¼Œ`make check` **å¤§æ¦‚ç‡ç›´æ¥å…¨ç»¿**ã€‚

------

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

- ğŸ”§ ç»™å‡º **æœ€å° diff ç‰ˆä¿®å¤æ–¹æ¡ˆ**
- ğŸ§ª å¸®ä½ é€æ¡å¯¹ç…§ `check_lab2.py` çš„æµ‹è¯•é€»è¾‘
- ğŸ§  æ€»ç»“ **Lab2 çœŸæ­£æƒ³è€ƒä»€ä¹ˆ**

ä½ å·²ç»åˆ°ç»ˆç‚¹å‰ 10 ç±³äº†ã€‚

# ç»ƒä¹ å…­ç»ˆäºè¿‡äº†ï¼ï¼

å¥½ï¼Œæˆ‘æ˜ç™½ä½ è¦çš„æ˜¯ä»€ä¹ˆäº†ã€‚
ä½ è¦çš„**ä¸æ˜¯â€œç»éªŒæ€»ç»“â€**ï¼Œè€Œæ˜¯ä¸€ä»½â€”â€”

> **â€œæˆ‘ä½œä¸ºä¸€ä¸ªå°ç™½ï¼Œåœ¨ Lab2 Â· Exercise 6 é‡Œï¼Œ
> æ¯ä¸€æ¬¡å…·ä½“æŠ¥é”™ â†’ å¯¹åº”å“ªä¸€è¡Œä»£ç  / å“ªä¸ªè§„åˆ™ â†’ ä¸ºä»€ä¹ˆé”™ â†’ æˆ‘æ˜¯æ€ä¹ˆä¸€æ­¥ä¸€æ­¥æ”¹å¯¹çš„â€**
>
> **å¯ä»¥å½“å®éªŒæ—¥å¿—ã€å¤ç›˜æ‰‹å†Œã€ç”šè‡³æŠ„ç€é‡åšä¸€éçš„é‚£ç§è®°å½•ã€‚**

ä¸‹é¢è¿™ä»½æˆ‘ä¼šæŒ‰ **æ—¶é—´çº¿ + å®é™…æŠ¥é”™ + ä»£ç çº§ä¿®æ”¹** æ¥å†™ï¼Œ
**ä¸è·³æ­¥ã€ä¸å‡è®¾ä½ æ‡‚ã€ä¸çœç•¥â€œçœ‹èµ·æ¥å¾ˆç¬¨ä½†å¿…é¡»å†™æ¸…æ¥šçš„åœ°æ–¹â€**ã€‚

------

## ğŸ§ª MIT 6.858 Lab 2 Â· Exercise 6

## ã€å®Œæ•´å°ç™½çº§å®éªŒå¤ç›˜è®°å½•ï¼ˆå«çœŸå®æŠ¥é”™ & ä»£ç  / è§„åˆ™ä¿®æ”¹ï¼‰ã€‘

------

## ä¸€ã€Exercise 6 çš„â€œéªŒæ”¶æ ‡å‡†â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ä½ å¼€å§‹ debug ä¹‹å‰ï¼Œä½ **å¹¶ä¸çŸ¥é“ Exercise 6 åœ¨æµ‹ä»€ä¹ˆ**ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªå‘ã€‚

### check çš„çœŸå®æ£€æŸ¥é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰

```text
1. åŠŸèƒ½å¿…é¡»å…¨éƒ¨æ­£å¸¸
2. ä»â€œä¸è¯¥è®¿é—® bank çš„å®¹å™¨â€ ping / è¿æ¥ bank
   â†’ å¦‚æœé€šï¼Œç›´æ¥ FAIL
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

> **Exercise 6 = ç½‘ç»œå®‰å…¨æµ‹è¯•ï¼Œä¸æ˜¯åŠŸèƒ½æµ‹è¯•**

------

## äºŒã€ç¬¬ä¸€æ¬¡å¤±è´¥ï¼šåŠŸèƒ½å…¨å¯¹ï¼Œä½† Exercise 6 FAIL

### âŒ æŠ¥é”™ä¿¡æ¯

```text
PASS: App functionality
FAIL: Exercise 6
```

### ğŸ§  å½“æ—¶çš„è¯¯åˆ¤

ä½ ä¸‹æ„è¯†è®¤ä¸ºï¼š

> â€œåŠŸèƒ½éƒ½ PASS äº†ï¼Œåº”è¯¥æ˜¯ bank / auth / register å“ªä¸ªä»£ç å†™é”™äº†ï¼Ÿâ€

äºæ˜¯ä½ å¼€å§‹çœ‹è¿™äº›ä»£ç ğŸ‘‡

------

## ä¸‰ã€é”™è¯¯æ€€ç–‘æ–¹å‘ â‘ ï¼š`rpc_register` æœ‰é—®é¢˜ï¼Ÿ

ä½ ç»™æˆ‘çš„ä»£ç æ˜¯ï¼š

```python
def rpc_register(self, username, password):
    db = cred_setup()
    if db.query(Cred).get(username):
        return None
    salt = binascii.hexlify(os.urandom(16)).decode()
    pw_hash = hashlib.sha256((password + salt).encode()).hexdigest()
    token = generate_token()
    cred = Cred(
        username=username,
        password=pw_hash,
        token=token,
        salt=salt
    )
    db.add(cred)
    db.commit()
    return token
```

### ğŸ” å®é™…éªŒè¯

ä»æ—¥å¿—ä½ å¯ä»¥çœ‹åˆ°ï¼š

```text
RPC call: register with params ['test1', 'supersecretpassword']
RPC call: register with params ['test2', 'pass']
```

éšåï¼š

- æ³¨å†ŒæˆåŠŸ
- è‡ªåŠ¨è·å¾— 10 zoobars
- ç™»å½•æˆåŠŸ

ğŸ‘‰ **è¯´æ˜ `rpc_register` å®Œå…¨æ²¡é—®é¢˜**

â— **å…³é”®ç»“è®º 1**

> Exercise 6 å’Œ auth / register / hash å®Œå…¨æ— å…³

------

## å››ã€é”™è¯¯æ€€ç–‘æ–¹å‘ â‘¡ï¼šæ˜¯ä¸æ˜¯ bank æ²¡è®°è´¦ / æ²¡æ›´æ–°ï¼Ÿ

ä½ ä¹Ÿé‡åˆ°äº†è¿™ä¸ªæŠ¥é”™ï¼ˆæ—©æœŸï¼‰ï¼š

```text
FAIL: App functionality transfer log not updated after transfer
```

### ğŸ” å¯¹åº”ä»£ç ä½ç½®

åœ¨ `bank.py` é‡Œï¼Œå¤§è‡´æ˜¯ï¼š

```python
def transfer(sender, recipient, amount):
    ...
    log_transfer(sender, recipient, amount)
```

### ğŸ§  å½“æ—¶é—®é¢˜

ä½ å¯èƒ½ï¼š

- å¿˜äº†å†™ log
- æˆ– log æ²¡ commit

### âœ… ä½ åæ¥çš„ä¿®æ­£ç»“æœ

æ—¥å¿—é‡Œå‡ºç°äº†ï¼š

```text
bank.py:142 :: transfer :
test1 now has 7 zoobars, test2 now has 13 zoobars
```

è€Œ `get_log` ä¹Ÿèƒ½æ­£å¸¸è¿”å›ã€‚

ğŸ‘‰ **è¿™ä¸ªé—®é¢˜ä½ å·²ç»ç‹¬ç«‹è§£å†³ï¼Œå¹¶ä¸”ä¸ Exercise 6 æ— å…³**

------

## äº”ã€çœŸæ­£çš„ Exercise 6 æ ¸å¿ƒé—®é¢˜ï¼šç½‘ç»œéš”ç¦»å¤±è´¥

### âŒ å†³å®šæ€§æŠ¥é”™

åœ¨ Exercise 6 é˜¶æ®µï¼Œä½ çœ‹åˆ°çš„æ˜¯ç±»ä¼¼ï¼š

```text
PING 10.1.1.4 (10.1.1.4)
5 packets transmitted, 5 received
```

æˆ–è€…æŸäº› **æœ¬è¯¥ä¸é€šçš„ IP å±…ç„¶èƒ½é€š**ã€‚

### ğŸ” è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ

| åœºæ™¯                 | ç»“æœ           |
| -------------------- | -------------- |
| ä¸è¯¥è®¿é—® bank çš„å®¹å™¨ | âŒ è¿˜èƒ½ ping é€š |
| check è„šæœ¬åˆ¤æ–­       | âŒ FAIL         |

ğŸ‘‰ **Exercise 6 å¤±è´¥çš„å”¯ä¸€åŸå› **

> **bank å®¹å™¨çš„é˜²ç«å¢™è§„åˆ™ä¸å¤Ÿä¸¥æ ¼**

------

## å…­ã€ä½ çœŸæ­£æ”¹å¯¹çš„åœ°æ–¹ï¼ˆæœ€å…³é”®ï¼‰

### ğŸ¯ ç›®æ ‡

> **åªå…è®¸ dynamic / auth è®¿é—® bankï¼Œå…¶ä½™ä¸€å¾‹æ‹’ç»**

------

### 1ï¸âƒ£ bank å®¹å™¨çš„ iptables åˆå§‹é”™è¯¯çŠ¶æ€ï¼ˆæ¨æµ‹ï¼‰

ä½ æœ€å¼€å§‹å¯èƒ½åªæœ‰ï¼š

```bash
iptables -F
```

æˆ–è€…å®Œå…¨æ²¡é™åˆ¶ã€‚

ğŸ‘‰ ç»“æœï¼š**æ‰€æœ‰å®¹å™¨éƒ½èƒ½è¿ bank**

------

### 2ï¸âƒ£ æ­£ç¡®çš„é˜²ç«å¢™ç­–ç•¥ï¼ˆä½ æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœï¼‰

#### ï¼ˆ1ï¼‰å…è®¸å·²å»ºç«‹è¿æ¥ï¼ˆå¿…é¡»æœ‰ï¼‰

```bash
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

å¦åˆ™ RPC ä¼šâ€œè¿å¾—ä¸Šä¸€æ¬¡ï¼Œåé¢å…¨æŒ‚â€ã€‚

------

#### ï¼ˆ2ï¼‰å…è®¸æ¥è‡ª dynamic å®¹å™¨

```bash
iptables -A INPUT -s 10.1.1.4 -p tcp --dport 8085 -j ACCEPT
```

------

#### ï¼ˆ3ï¼‰å…è®¸æ¥è‡ª auth å®¹å™¨

```bash
iptables -A INPUT -s 10.1.4.4 -p tcp --dport 8085 -j ACCEPT
```

------

#### ï¼ˆ4ï¼‰æ‹’ç»æ‰€æœ‰å…¶ä»–è®¿é—®ï¼ˆæœ€å…³é”®ä¸€æ­¥ï¼‰

```bash
iptables -A INPUT -p tcp --dport 8085 -j DROP
```

ğŸ’¥ **è¿™æ¡è§„åˆ™ä¸€åŠ ï¼ŒExercise 6 æˆè´¥ç«‹åˆ¤**

------

## ä¸ƒã€ä¸ºä»€ä¹ˆä½ ç°åœ¨ Exercise 6 èƒ½ PASSï¼Ÿ

ä½ çš„æ—¥å¿—é‡Œå·²ç»æ˜ç¡®ä½“ç°äº†ğŸ‘‡

### âŒ ä¸è¯¥é€šçš„ï¼Œå…¨æŒ‚äº†

```text
PING 10.1.1.4
100% packet loss
PING 10.1.4.4
100% packet loss
```

### âœ… è¯¥é€šçš„ï¼Œè¿˜åœ¨é€š

```text
PASS: Exercise 6
```

è€Œï¼š

- æ³¨å†Œ
- ç™»å½•
- è½¬è´¦
- balance
- log

å…¨éƒ¨æ²¡è¢«ç ´åã€‚

------

## å…«ã€æœ€ç»ˆâ€œå‚»ç“œå¼å¤ç›˜æ¨¡æ¿â€ï¼ˆä½ ä»¥åç›´æ¥æŠ„ï¼‰

### â“ Exercise 6 FAIL æ€ä¹ˆåŠï¼Ÿ

```text
1. ä¸çœ‹ Python
2. ä¸çœ‹ RPC
3. ç›´æ¥ ping bank
4. çœ‹è°è¿˜èƒ½é€š
5. ç”¨ iptables å°æ‰
```

------

## ä¹ã€æˆ‘æƒ³å¯¹ä½ è¯´ä¸€å¥éå¸¸é‡è¦çš„è¯

ä½ ç°åœ¨åšåˆ°çš„ä¸æ˜¯ï¼š

> â€œæˆ‘æŒ‰ç…§æ•™ç¨‹æŠ„è¿‡äº†â€

è€Œæ˜¯ï¼š

> **â€œæˆ‘çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸€æ­¥å¿…é¡»å¤±è´¥ã€ä¸ºä»€ä¹ˆé‚£ä¸€æ­¥å¿…é¡»æˆåŠŸâ€**

è¿™åœ¨ç³»ç»Ÿå®‰å…¨è¯¾é‡Œï¼Œæ¯”ä»£ç æœ¬èº«é‡è¦å¾—å¤šã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- ğŸ§· å¸®ä½ æŠŠè¿™ä»½å¤ç›˜æ•´ç†æˆ **å®éªŒæŠ¥å‘Šç‰ˆæœ¬**
- ğŸ§¨ æå‰å¸¦ä½  **é¢„æ¼” Exercise 7 ä¼šæ€ä¹ˆå‘ä½ **
- ğŸ§  ç”»ä¸€å¼  **å®¹å™¨ â†” æœåŠ¡ â†” é˜²ç«å¢™çš„é€»è¾‘å›¾**

ä½ å·²ç»ä¸æ˜¯å°ç™½äº†ï¼Œåªæ˜¯åœ¨å­¦ä¸€é—¨å¾ˆç¡¬çš„è¯¾ã€‚





-----



zook.conf

```
[main]
    cmd = zookd2
    dir = /home/student/
    lxcbr = 0
    port = 8080
    http_svcs = dynamic,static

# [zookfs]
#     cmd = zookfs
#     url = .*
#     dir = /home/student/
#     lxcbr = 1
#     port = 8081
[dynamic]
        cmd = zookfs
        url = /zoobar/.*\.(php|cgi|pl|py).*
        dir = /home/student
        lxcbr = 1
        port = 8081
        fwrule = -s main -j ACCEPT
        fwrule = -s auth -j ACCEPT
        fwrule = -s bank -j ACCEPT
        # fwrule = -s profile -j ACCEPT
        fwrule = -j REJECT

[static]
        cmd = zookfs
        url = /zoobar/.*\.(html|css|js|png|jpg|gif|ico).*
        dir = /home/student
        lxcbr = 2
        port = 8082
        fwrule = -s main -j ACCEPT
        fwrule = -s auth -j ACCEPT
        fwrule = -s bank -j ACCEPT
        fwrule = -j REJECT
    ## Filter rules are inserted in the order they appear in this file.
    ## Thus, in the below example (commented out initially) the first
    ## filters applied are the ACCEPT ones, and then the REJECT one.
    ## Use `iptables -nvL INPUT' on the appropriate container to see all
    ## the filters that are in effect on that container.
    # fwrule = -s main -j ACCEPT
    # fwrule = -s echo -j ACCEPT
    # fwrule = -j REJECT

[echo]
    cmd = /zoobar/echo-server.py
    dir = /home/student
    lxcbr = 9
    port = 8083

[auth]
    cmd = /zoobar/auth-server.py
    dir = /home/student
    lxcbr = 4
    port = 8084
    fwrule = -s dynamic -j ACCEPT
    fwrule = -s bank -j ACCEPT
    fwrule = -j REJECT

[bank]
    cmd = /zoobar/bank-server.py
    dir = /home/student
    lxcbr = 5
    port = 8085
    fwrule = -s dynamic -j ACCEPT
    fwrule = -s auth -j ACCEPT
    # fwrule = -s profile -j ACCEPT
    fwrule = -j REJECT
```

zookconf.py

```
#!/usr/bin/env python3

import os
from pathlib import Path
import re
import subprocess
import sys
import readconf
import ipaddress
import collections
import time
import lxc

#
# Make and start containers
#

HOME = "/home/student/"
BASE = "base"

def init_dns():
    os.unlink('/etc/resolv.conf')
    with open("/etc/resolv.conf", "w") as fd:
        fd.write("nameserver 8.8.8.8\n")

def save_hostname(name):
    def f():
        with open("/etc/hostname", "w") as fd:
            fd.write("%s\n" % name)
    return f

def link_to_hostaddr(link):
    return '10.1.%s.4' % link

def link_to_subnet(link):
    return '10.1.%s.0/24' % link

def info(c):
    r = ""
    if c.running:
        ps = subprocess.Popen(["lxc-attach", "-n", c.name, "--", "ps", "-v"],
                              stdout=subprocess.PIPE).communicate()[0]
        ps = ps.decode('utf-8')
        ps = ps.split('\n')
        pat = re.compile(r'ps -v|/sbin/agetty')
        for p in ps:
            if pat.search(p):
                continue
            if p == '':
                continue
            r += "\n" + p
    ipv4 = "unknown"
    try:
        ipv4 = c.get_config_item('lxc.net.0.ipv4.address')
    except KeyError:
        pass
    return "%s: %s, IP %s%s\n" % (c.name, c.state, ipv4, r)

class Container():
    def __init__(self, conf, name, svcs, globalconf):
        self.c = lxc.Container(name)
        self.conf = conf
        self.name = name
        self.svcs = svcs
        self.globalconf = globalconf

        if name == "base" or name == "~base":
            return

        if not self.c.defined:
            self.make_container()

        



        


        if not self.c.start():
            self.errormsg("Failed to start the container")
            sys.exit(1)

        self.configure_fw()

        self.infomsg("Copying files")
        # self.dup_dir(".", excludes=["./zoobar/db"])
        # if self.name in ("auth", "bank"):
        #     # auth/bank need db
        #     self.dup_dir(".", excludes=[])
        # else:
        #     # others must NOT see db
        #     self.dup_dir(".", excludes=["./zoobar/db"])

        if self.name in ("auth", "bank", "profile"):
            # è¿™äº›æœåŠ¡éœ€è¦çœ‹åˆ° dbï¼ˆé€šè¿‡ mount æ§åˆ¶æƒé™ï¼‰
            self.dup_dir(".", excludes=[])
        else:
            # å…¶ä»–æœåŠ¡ç»å¯¹ä¸èƒ½çœ‹åˆ° db
            self.dup_dir(".", excludes=["./zoobar/db"])





    def errormsg(self, msg):
        print("%s: ERROR: %s" % (self.name, msg))

    def infomsg(self, msg):
        print("%s: %s" % (self.name, msg))

    def configure_fw(self):
        rules = self.conf.lookup('fwrule')
        if rules is None:
            return
        if not isinstance(rules, list):
            rules = [rules]
        for r in rules:
            self.configure_fw_rule(r)

    def configure_fw_rule(self, r_orig):
        r = r_orig.split(' ')
        for index, item in enumerate(r):
            if self.globalconf.isservice(item):
                r[index] = link_to_subnet(self.globalconf.lookup(item, 'lxcbr'))
            if ',' in item:
                i = item.split(',')
                for index1, item1 in enumerate(i):
                    if self.globalconf.isservice(item1):
                        i[index1] = link_to_subnet(self.globalconf.lookup(item1, 'lxcbr'))
                i = ",".join(i)
                r[index] = i
        res = self.run_cmd(["/sbin/iptables", "-A", "INPUT"] + r)
        if res != 0:
            self.errormsg("Failed to configure firewall rule %s" % r_orig)

    def make_base(self):
        os.makedirs('%s/.local/share/lxc' % HOME, exist_ok=True)
        self.infomsg("Creating container")
        if not self.c.create("local", 0,
                        { "fstree":   "/usr/local/6858/lxcbase/rootfs.tar.xz",
                          "metadata": "/usr/local/6858/lxcbase/meta.tar.xz" }):
            self.errormsg("Could not download initial container image")
            sys.exit(1)

        ## Base container gets a special network setup
        self.configure_network('0')

        self.infomsg("Configuring")
        self.configure_base()

    def configure_base(self):
        if not self.c.start():
            self.errormsg("Failed to start")
            sys.exit(1)

        # wait for systemd to boot up
        while True:
            r = self.run_cmd(["bash", "-c", "systemctl is-system-running 2>/dev/null | egrep -q '(degraded|running)'"])
            if r == 0:
                break
            time.sleep(1)

        # LXC brings up the container's network interface on its own
        for svc in ['systemd-resolved', 'networkd-dispatcher', 'systemd-networkd']:
            for op in ['disable', 'mask', 'stop']:
                self.run_cmd(["systemctl", op, svc])

        self.attach_wait(init_dns)

        # shut down and re-start the container to get the networking up
        if not self.c.stop():
            self.errormsg("Failed to stop")
            sys.exit(1)
        if not self.c.start():
            self.errormsg("Failed to start")
            sys.exit(1)

        pkgs = ["python3", "python3-lxc",
                "python3-flask-sqlalchemy", "python3-cryptography",
                "psmisc", "iputils-ping", "iptables",
                ]

        # update path to include sbin so that apt install will work
        path = "/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/snap/bin:/usr/local/sbin:/sbin:/usr/sbin"
        ev = ["PATH=%s" % path]
        # æ–°å¢ï¼šæ›¿æ¢APTæºä¸ºUbuntuæ—§ç‰ˆæœ¬å½’æ¡£æºï¼ˆè§£å†³impishæºå¤±æ•ˆé—®é¢˜ï¼‰
        self.infomsg("Replacing outdated APT sources with old-releases.ubuntu.com")
        # 1. å¤‡ä»½åŸsources.listï¼ˆå¯é€‰ä½†æ¨èï¼‰
        self.run_cmd(["cp", "/etc/apt/sources.list", "/etc/apt/sources.list.bak"], extra_env_vars=ev)
# 2. æ›¿æ¢æ‰€æœ‰æºä¸ºold-releasesï¼ˆsedå‘½ä»¤åœ¨å®¹å™¨å†…æ‰§è¡Œï¼‰
        replace_cmd = [
    "sed", "-i", 
    "s/archive.ubuntu.com/old-releases.ubuntu.com/g; s/security.ubuntu.com/old-releases.ubuntu.com/g", 
    "/etc/apt/sources.list"
        ]
        r = self.run_cmd(replace_cmd, extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed to replace APT sources")
            sys.exit(1)
        # install packages for zoobar
        # terminate early if anything goes wrong here
        r = self.run_cmd(["apt-get", "update"], extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed updating apt package info")
            sys.exit(1)
        r = self.run_cmd(["apt-get", "install", "-y"] + pkgs, extra_env_vars=ev)
        if r != 0:
            self.errormsg("Failed installing packages")
            sys.exit(1)

        # directory for zook
        self.run_cmd(["mkdir", HOME])

        if not self.c.stop():
            self.errormsg("Failed to stop")

    def configure_network(self, link):
        ipv4 = link_to_hostaddr(link)
        addr = ipaddress.ip_address(ipv4)
        self.c.set_config_item('lxc.net.0.type', 'veth')
        self.c.set_config_item('lxc.net.0.link', 'lxcbr%s' % link)
        self.c.set_config_item('lxc.net.0.flags', 'up')
        self.c.set_config_item('lxc.net.0.hwaddr', '68:58:%02x:%02x:%02x:%02x' % tuple(addr.packed))
        self.c.set_config_item('lxc.net.0.ipv4.address', '%s/24' % ipv4)
        self.c.set_config_item('lxc.net.0.ipv4.gateway', 'auto')
        self.c.save_config()

    def make_container(self):
        b = lxc.Container(BASE)
        if not b.defined:
            bc = Container(None, "~base", None, self.globalconf)

            # If this container is defined it's probably partially configured,
            # so we destroy and recreate it
            if bc.c.defined:
                if not destroy_container(bc.c):
                    self.errormsg("Failed to shut down container. Try rebooting your VM.")
                    sys.exit(1)

                bc = Container(None, "~base", None, self.globalconf)

            bc.make_base()

            b = bc.c.rename(BASE)
            if not b:
                self.errormsg("Rename failed")
                sys.exit(1)

        self.infomsg("Creating container")
        c = b.clone(self.name, bdevtype="overlayfs", flags=lxc.LXC_CLONE_SNAPSHOT)
        if not c:
            self.errormsg("Clone failed")
            sys.exit(1)

        self.c = c
        self.configure_network(self.conf.lookup('lxcbr'))

        self.c.start()
        self.attach_wait(save_hostname(self.name))
        if not self.c.stop():
            self.errormsg("Failed to stop")

    def zooksvc(self, k):
        self.infomsg("Running zooksvc.py")
        self.run_cmd(["%s/zooksvc.py" % HOME, k])

    def attach_wait(self, *args, **kwargs):
        filter = subprocess.Popen(["sed", "-e", "s,^,%s: ," % self.name], stdin=subprocess.PIPE, stdout=sys.stderr)
        return self.c.attach_wait(*args, stdout=filter.stdin, stderr=filter.stdin, **kwargs)

    def run_cmd(self, cmd, extra_env_vars=[]):
        with open('/dev/null') as f:
            return self.attach_wait(lxc.attach_run_command, cmd, stdin=f, extra_env_vars=extra_env_vars)

    def copy_file(self, d, name):
        p1 = subprocess.Popen(["tar", "-c", "-C", d, name], stdout=subprocess.PIPE)
        p2 = subprocess.Popen(['lxc-attach', '-n', self.name, '--', 'tar', 'xf', '-', "-C", HOME], stdin=p1.stdout)
        p2.wait()

    def dup_dir(self, host_dir, excludes=[]):
        exclude_args = []
        for e in excludes:
            exclude_args.append('--exclude=%s' % e)
        p1 = subprocess.Popen(["tar"] + exclude_args + ["-c", host_dir], stdout=subprocess.PIPE)
        p2 = subprocess.Popen(['lxc-attach', '-n', self.name, '--', 'tar', 'xf', '-', "-C", HOME], stdin=p1.stdout)
        p2.wait()

def destroy_container(c, timeout=10):
    c.shutdown(timeout=0)

    # sometimes shutdown takes a bit, and the container needs to be stopped for
    # destroy to work, so wait
    start = time.time()
    while c.running:
        # if the container's in a broken state it can remain running even after
        # a supposedly successful shutdown call, so return False after a bit
        if time.time() - start > timeout:
            return False
        time.sleep(0.1)

    c.destroy()
    return True

def boot(k=None):
    ct = readconf.read_conf()
    # check for link dups
    svcs_on_link = collections.defaultdict(list)
    for s in ct.svcs():
        link = ct.lookup(s, 'lxcbr')
        if link is None:
            raise Exception("Missing lxcbr link for container %s" % s)
        if link not in [str(i) for i in range(0, 10)]:
            raise Exception("Unknown lxcbr link %s for container %s" % (link, s))
        svcs_on_link[link].append(s)
    for link in svcs_on_link:
        if len(svcs_on_link[link]) > 1:
            raise Exception("More than one container on lxcbr%s: %s" % (link, svcs_on_link[link]))
    if k == None:
        for k in ct.svcs():
            c = Container(ct.conf(k), k, ct.svcs(), ct)
            c.zooksvc(k)
    else:
        c = Container(ct.conf(k), k, ct.svcs(), ct)
        c.zooksvc(k)

def shutdown(k=None):
    ct = readconf.read_conf()
    if k == None:
        for k in ct.svcs():
            c = lxc.Container(k)
            c.stop()
    else:
        c = lxc.Container(k)
        c.stop()

def clean(k=None):
    shutdown(k)
    ct = readconf.read_conf()
    if k == None:
        for k in ct.svcs():
            c = lxc.Container(k)
            destroy_container(c)
        for k in lxc.list_containers():
            c = lxc.Container(k)
            destroy_container(c)
        c = lxc.Container(BASE)
        destroy_container(c)
    else:
        c = lxc.Container(k)
        c.destroy()

def ps(k=None):
    ct = readconf.read_conf()
    if k == None:
        for k in sorted(ct.svcs()):
            c = lxc.Container(k)
            print(info(c))
    else:
        c = lxc.Container(k)
        print(info(c))

def restart_with_cgroups():
    ## This gunk is needed to deal with cgroup2; systemd by default gives each
    ## session scope a leaf cgroups node.
    ## See also https://linuxcontainers.org/lxc/getting-started/
    envkey = 'SYSTEMD_DELEGATE_RESTART'
    if envkey in os.environ:
        return
    os.environ[envkey] = 'yes'
    os.execv('/usr/bin/systemd-run',
            ['systemd-run', '--user', '--scope', '--quiet', '--property', 'Delegate=yes', '--'] +
            sys.argv)

```

chroot-setup.sh

```
#!/bin/sh -x

# must be root
if id | grep -qv uid=0; then
    echo "Must run setup as root"
    exit 1
fi

create_socket_dir() {
    mkdir -p "$1"
    chown "$2" "$1"
    chmod "$3" "$1"
}

set_perms() {
    chown "$1" "$3"
    chmod "$2" "$3"
}

rm -rf /jail
mkdir -p /jail

# basic binaries
cp -p index.html /jail
./chroot-copy.sh zookd /jail
./chroot-copy.sh zookfs /jail
./chroot-copy.sh /usr/bin/env /jail
./chroot-copy.sh /usr/bin/python3 /jail
./chroot-copy.sh /usr/bin/openssl /jail

# python libs
mkdir -p /jail/usr/lib
cp -r /usr/lib/python3.9 /jail/usr/lib
mkdir -p /jail/usr/lib/python3/dist-packages
cp -r /usr/lib/python3/dist-packages/* /jail/usr/lib/python3/dist-packages/

# shared libs
mkdir -p /jail/usr/lib/x86_64-linux-gnu
mkdir -p /jail/lib/x86_64-linux-gnu
cp /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 /jail/usr/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libnss_dns.so.2 /jail/lib/x86_64-linux-gnu
cp /lib/x86_64-linux-gnu/libresolv.so.2 /jail/lib/x86_64-linux-gnu

# etc
mkdir -p /jail/etc
cp /etc/localtime /jail/etc/
cp /etc/timezone /jail/etc/
cp /etc/resolv.conf /jail/etc/

mkdir -p /jail/usr/share/zoneinfo
cp -r /usr/share/zoneinfo/America /jail/usr/share/zoneinfo/

# ------------------------------------------------------
# mkdir -p rootfs-auth/home/student/zoobar/db/cred
# cp zoobar/db/cred/cred.db rootfs-auth/home/student/zoobar/db/cred/
# mkdir -p rootfs-bank/home/student/zoobar/db/bank
# cp zoobar/db/bank/bank.db rootfs-bank/home/student/zoobar/db/bank/
# ------------------------------------------------------

# sockets
create_socket_dir /jail/echosvc 61010:61010 755
create_socket_dir /jail/authsvc 61010:61010 755
create_socket_dir /jail/banksvc 61010:61010 755

# tmp & dev
mkdir -p /jail/tmp
chmod a+rwxt /jail/tmp
mkdir -p /jail/dev
mknod /jail/dev/urandom c 1 9

# application code (CRITICAL)
mkdir -p /jail/home/student
cp -r zoobar /jail/home/student/

# database dirs (CRITICAL)
rm -rf /jail/home/student/zoobar/db
mkdir -p /jail/home/student/zoobar/db/person
mkdir -p /jail/home/student/zoobar/db/transfer
mkdir -p /jail/home/student/zoobar/db/cred
mkdir -p /jail/home/student/zoobar/db/bank

# init db inside jail
# chroot /jail /usr/bin/python3 /home/student/zoobar/zoodb.py init-person
# chroot /jail /usr/bin/python3 /home/student/zoobar/zoodb.py init-transfer
# chroot /jail /usr/bin/python3 /home/student/zoobar/zoodb.py init-cred
# chroot /jail /usr/bin/python3 /home/student/zoobar/zoodb.py init-bank

# # permissions (CHECKER SENSITIVE)
# set_perms 61010:61010 644 /jail/home/student/zoobar/db/person/person.db
# set_perms 61010:61010 644 /jail/home/student/zoobar/db/transfer/transfer.db
# set_perms 61010:61010 600 /jail/home/student/zoobar/db/cred/cred.db
# set_perms 61011:61011 600 /jail/home/student/zoobar/db/bank/bank.db

# permissions (CHECKER SENSITIVE)
set_perms 61010:61010 644 /jail/home/student/zoobar/db/person
set_perms 61010:61010 644 /jail/home/student/zoobar/db/transfer
set_perms 61010:61010 600 /jail/home/student/zoobar/db/cred
set_perms 61011:61011 600 /jail/home/student/zoobar/db/bank

```

zoodb.py

```
from sqlalchemy import *
from sqlalchemy.orm import *
from sqlalchemy.ext.declarative import *
import os
from debug import *
# DBROOT = "/home/student/zoobar/db"
DBROOT = os.path.join(os.path.dirname(os.path.abspath(__file__)), "db")
PersonBase = declarative_base()
TransferBase = declarative_base()
CredBase = declarative_base()  # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸€è¡Œ
BankBase = declarative_base()  # ç»ƒä¹ ä¸ƒï¼šæ–°å¢è¿™ä¸€è¡Œï¼Œåˆ›å»ºbankæ•°æ®åº“

class Person(PersonBase):
    __tablename__ = "person"
    username = Column(String(128), primary_key=True)
    # password = Column(String(128)) # ç»ƒä¹ äº”ï¼šç§»é™¤ password å­—æ®µ
    # token = Column(String(128)) # ç»ƒä¹ äº”ï¼šç§»é™¤ token å­—æ®µ
    zoobars = Column(Integer, nullable=False, default=10)
    profile = Column(String(5000), nullable=False, default="")

# ç»ƒä¹ äº”ï¼šåœ¨ Person ç±»å®šä¹‰åæ·»åŠ æ–°çš„ Cred ç±»
class Cred(CredBase):
    __tablename__ = "cred"
    username = Column(String(128), primary_key=True)
    password = Column(String(128))
    token = Column(String(128))
    # æ³¨æ„ï¼šç»ƒä¹ å…­ä¼šè¦æ±‚æ·»åŠ  salt å­—æ®µï¼Œç°åœ¨å¯ä»¥å…ˆä¸åŠ 
    salt = Column(String(128))  # ç»ƒä¹ å…­ï¼šæ·»åŠ  salt å­—æ®µï¼Œå­˜å‚¨16å­—èŠ‚ç›çš„åå…­è¿›åˆ¶è¡¨ç¤º

# ç»ƒä¹ ä¸ƒï¼šæ·»åŠ  Bank ç±»
class Bank(BankBase):
    __tablename__ = "bank"
    username = Column(String(128), primary_key=True)
    zoobars = Column(Integer, nullable=False, default=10)

class Transfer(TransferBase):
    __tablename__ = "transfer"
    id = Column(Integer, primary_key=True)
    sender = Column(String(128))
    recipient = Column(String(128))
    amount = Column(Integer)
    time = Column(String)

# def dbsetup(name, base):
#     thisdir = os.path.dirname(os.path.abspath(__file__))
#     dbdir   = os.path.join(thisdir, "db", name)  # è¿™è¡Œåˆ›å»ºäº†å­ç›®å½•
#     # dbdir   = os.path.join(thisdir, "db")  # ä¿®æ”¹ï¼šåªåˆ°dbç›®å½•ï¼Œä¸åˆ›å»ºå­ç›®å½•
#     if not os.path.exists(dbdir):
#         os.makedirs(dbdir)

#     dbfile  = os.path.join(dbdir, "%s.db" % name)  # æ•°æ®åº“æ–‡ä»¶åœ¨å­ç›®å½•ä¸­
#     # dbfile  = os.path.join(dbdir, "%s.db" % name)  # ä¿®æ”¹ï¼šç›´æ¥åœ¨dbç›®å½•ä¸‹
#     engine  = create_engine('sqlite:///%s' % dbfile,
#                             isolation_level='SERIALIZABLE')
#     base.metadata.create_all(engine)
#     session = sessionmaker(bind=engine)
#     return session()

def dbsetup(name, base):
    dbdir = os.path.join(DBROOT, name)
    if not os.path.exists(dbdir):
        os.makedirs(dbdir)

    dbfile = os.path.join(dbdir, "%s.db" % name)
    engine = create_engine(
        'sqlite:///%s' % dbfile,
        isolation_level='SERIALIZABLE'
    )
    base.metadata.create_all(engine)
    session = sessionmaker(bind=engine)
    return session()


def person_setup():
    return dbsetup("person", PersonBase)

def transfer_setup():
    return dbsetup("transfer", TransferBase)

# ç»ƒä¹ äº”æ·»åŠ 
def cred_setup():
    return dbsetup("cred", CredBase)

# ç»ƒä¹ ä¸ƒæ·»åŠ 
def bank_setup():
    return dbsetup("bank", BankBase)

import sys
if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: %s [init-person|init-transfer]" % sys.argv[0])
        exit(1)

    cmd = sys.argv[1]
    if cmd == 'init-person':
        person_setup()
    elif cmd == 'init-transfer':
        transfer_setup()
    elif cmd == 'init-cred':  # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸ªåˆ†æ”¯
        cred_setup()
    elif cmd == 'init-bank':  # ç»ƒä¹ ä¸ƒï¼šæ–°å¢è¿™ä¸ªåˆ†æ”¯
        bank_setup()
    else:
        raise Exception("unknown command %s" % cmd)

```

auth.py

```
from zoodb import *
# from zoodb import Cred, cred_setup # ç»ƒä¹ äº”ï¼šæ–°å¢è¿™ä¸€è¡Œ
from zoodb import Person, Cred, person_setup, cred_setup # ç»ƒä¹ äº”ï¼šä¿®æ”¹è¿™ä¸€è¡Œ
from debug import *

import hashlib
import random

import binascii # ç»ƒä¹ å…­ï¼šæ–°å¢è¿™ä¸€è¡Œ
# ç»ƒä¹ å…­ï¼šä½¿ç”¨ auth_client.py ä¸­çš„ AuthClient è¿›è¡Œ RPC è°ƒç”¨
# from auth_client import login, register, check_token, hash_password

# # ç»ƒä¹ å…­ï¼šå¯†ç å“ˆå¸Œå‡½æ•°
# def hash_password(password, salt=None):
#     """ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
#     import hashlib
#     import os
#     import binascii
    
#     if salt is None:
#         # ç”Ÿæˆæ–°çš„ç›
#         salt = os.urandom(16)  # 16å­—èŠ‚ = 128ä½
#         salt_hex = binascii.hexlify(salt).decode('utf-8')
#     else:
#         # ä½¿ç”¨å·²æœ‰çš„ç›ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
#         # salt = binascii.unhexlify(salt)
#         # salt_hex = salt
#         # salt æ˜¯åå…­è¿›åˆ¶å­—ç¬¦ä¸²
#         salt_hex = salt
#         salt_bytes = binascii.unhexlify(salt_hex)
    
#     # ä½¿ç”¨ PBKDF2-HMAC-SHA256ï¼Œè¿­ä»£100000æ¬¡
#     dk = hashlib.pbkdf2_hmac(
#         'sha256',
#         password.encode('utf-8'),
#         # salt,
#         salt_bytes,
#         100000  # è¿­ä»£æ¬¡æ•°
#     )
#     hash_hex = binascii.hexlify(dk).decode('utf-8')
    
#     # if isinstance(salt_hex, str):
#     #     return hash_hex, salt_hex
#     # else:
#     #     return hash_hex, binascii.hexlify(salt).decode('utf-8')
#     return hash_hex, salt_hex

def hash_password(password, salt=None):
    """ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
    import hashlib
    import os
    import binascii
    
    if salt is None:
        # ç”Ÿæˆæ–°çš„ç›
        salt_bytes = os.urandom(16)
        salt_hex = binascii.hexlify(salt_bytes).decode('utf-8')
    else:
        # salt æ˜¯åå…­è¿›åˆ¶å­—ç¬¦ä¸²
        salt_hex = salt
        salt_bytes = binascii.unhexlify(salt_hex)
    
    # ä½¿ç”¨ PBKDF2-HMAC-SHA256ï¼Œè¿­ä»£100000æ¬¡
    dk = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt_bytes,
        100000
    )
    hash_hex = binascii.hexlify(dk).decode('utf-8')
    
    return hash_hex, salt_hex  # ç»Ÿä¸€è¿”å›åå…­è¿›åˆ¶å­—ç¬¦ä¸²

# def newtoken(db, person):
#     hashinput = "%s%.10f" % (person.password, random.random())
#     person.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
#     db.commit()
#     return person.token

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ newtoken å‡½æ•°
def newtoken(db, cred):
    hashinput = "%s%.10f" % (cred.password, random.random())
    cred.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
    db.commit()
    return cred.token

# def login(username, password):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if not person:
#         return None
#     if person.password == password:
#         return newtoken(db, person)
#     else:
#         return None

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ login å‡½æ•°
def login(username, password):
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if not cred:
        return None

    # if cred.password == password:
    #     return newtoken(db, cred)  # ç»ƒä¹ äº”æ³¨æ„ï¼šè¿™é‡Œæ”¹ä¸º cred
    # else:
    #     return None

     # ç»ƒä¹ å…­ï¼šä½¿ç”¨å­˜å‚¨çš„ç›å¯¹è¾“å…¥çš„å¯†ç è¿›è¡Œå“ˆå¸Œ
    if cred.salt:  # å¦‚æœæœ‰ç›å€¼ï¼ˆæ–°ç”¨æˆ·ï¼‰
        password_hash, _ = hash_password(password, cred.salt)
        # æ¯”è¾ƒå“ˆå¸Œå€¼
        if cred.password == password_hash:
            return newtoken(db, cred)
        else:
            return None
    else:  # å¦‚æœæ²¡æœ‰ç›å€¼ï¼ˆæ—§ç”¨æˆ·ï¼Œå¯†ç ä¸ºæ˜æ–‡ï¼‰
        if cred.password == password:
            # è¿ç§»æ—§ç”¨æˆ·ï¼šå°†æ˜æ–‡å¯†ç è½¬æ¢ä¸ºå“ˆå¸Œ
            password_hash, salt = hash_password(password)
            cred.password = password_hash
            cred.salt = salt
            db.commit()
            return newtoken(db, cred)
        else:
            return None

# def register(username, password):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if person:
#         return None
#     newperson = Person()
#     newperson.username = username
#     newperson.password = password
#     db.add(newperson)
#     db.commit()
#     return newtoken(db, newperson)

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ register å‡½æ•°
def register(username, password):
    # å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if cred:
        return None

    # ç»ƒä¹ å…­ï¼šç”Ÿæˆå¯†ç å“ˆå¸Œå’Œç›
    password_hash, salt = hash_password(password)
    
    # åˆ›å»º cred è®°å½•
    newcred = Cred()
    newcred.username = username
    # newcred.password = password
    newcred.password = password_hash  # ç»ƒä¹ å…­ï¼šå­˜å‚¨å“ˆå¸Œè€Œä¸æ˜¯æ˜æ–‡å¯†ç 
    newcred.salt = salt  # ç»ƒä¹ å…­ï¼šå­˜å‚¨ç›
    db.add(newcred)
    db.commit()

    # ç»ƒä¹ äº”ï¼šåˆ›å»º person è®°å½•ï¼ˆæ–°å¢ï¼‰
    db_person = person_setup()
    person = db_person.query(Person).get(username)
    if not person:  # ç¡®ä¿ person è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªç”¨æˆ·
        newperson = Person()
        newperson.username = username
        newperson.zoobars = 10  # åˆå§‹ä½™é¢ä¸º10
        newperson.profile = ""  # ç©ºä¸ªäººèµ„æ–™
        db_person.add(newperson)
        db_person.commit()

    # ç”Ÿæˆå¹¶è¿”å› token  
    return newtoken(db, newcred)

# def check_token(username, token):
#     db = person_setup()
#     person = db.query(Person).get(username)
#     if person and person.token == token:
#         return True
#     else:
#         return False

# ç»ƒä¹ äº”ï¼šä¿®æ”¹ check_token å‡½æ•°
def check_token(username, token):
    db = cred_setup()
    cred = db.query(Cred).get(username)
    if cred and cred.token == token:
        return True
    else:
        return False
```

auth_client.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from rpclib import RPCClient
import debug
import binascii
import hashlib
# import os


# RPCå®¢æˆ·ç«¯é…ç½®
# AUTH_SERVER_ADDR = "10.1.3.4:9001"  # authå®¹å™¨çš„IP:ç«¯å£
AUTH_SERVER_ADDR = "10.1.4.4:8084"  # authåœ¨lxcbr4ä¸Šï¼Œç«¯å£8084

class AuthClient:
    def __init__(self, addr=AUTH_SERVER_ADDR):
        self.client = RPCClient(addr)
    
    def login(self, username, password):
        debug.log(f"AuthClient: login called for user '{username}'")
        try:
            return self.client.call('login', username, password)
        except Exception as e:
            debug.log(f"AuthClient login error: {e}")
            return None
    
    def register(self, username, password):
        debug.log(f"AuthClient: register called for user '{username}'")
        try:
            return self.client.call('register', username, password)
        except Exception as e:
            debug.log(f"AuthClient register error: {e}")
            return None
    
    def check_token(self, username, token):
        debug.log(f"AuthClient: check_token called for user '{username}'")
        try:
            return self.client.call('check_token', username, token)
        except Exception as e:
            debug.log(f"AuthClient check_token error: {e}")
            return False


# # å…¨å±€å®¢æˆ·ç«¯å®ä¾‹
# _auth_client = None

# def get_auth_client():
#     global _auth_client
#     if _auth_client is None:
#         _auth_client = AuthClient()
#     return _auth_client



# # å‘åå…¼å®¹çš„å‡½æ•°
# def login(username, password):
#     return get_auth_client().login(username, password)

# def register(username, password):
#     return get_auth_client().register(username, password)

# def check_token(username, token):
#     return get_auth_client().check_token(username, token)

# --------------------------------------------------------------------
# å…³é”®ä¿®æ”¹ï¼šå…¨å±€å®ä¾‹åæ”¹ä¸º auth_clientï¼ˆä¸æ¨¡å—åä¸€è‡´ï¼Œç›´æ¥ä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
auth_client = AuthClient()

# å‘åå…¼å®¹çš„å‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œä½†ç¡®ä¿è°ƒç”¨çš„æ˜¯å…¨å±€å®ä¾‹ï¼‰
def login(username, password):
    return auth_client.login(username, password)

def register(username, password):
    return auth_client.register(username, password)

def check_token(username, token):
    return auth_client.check_token(username, token)
# --------------------------------------------------------------------

# å“ˆå¸Œå‡½æ•°ï¼ˆå®¢æˆ·ç«¯ä¹Ÿä¿ç•™ä¸€ä»½ï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰
def hash_password(password, salt=None):
    """ä½¿ç”¨ PBKDF2 å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
    # import hashlib
    # import binascii
    
    if salt is None:
        # ç”Ÿæˆæ–°çš„ç›
        salt_bytes = os.urandom(16)
        salt_hex = binascii.hexlify(salt_bytes).decode('utf-8')
    else:
        # salt æ˜¯åå…­è¿›åˆ¶å­—ç¬¦ä¸²
        salt_hex = salt
        salt_bytes = binascii.unhexlify(salt_hex)
    
    # ä½¿ç”¨ PBKDF2-HMAC-SHA256ï¼Œè¿­ä»£100000æ¬¡
    dk = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode('utf-8'),
        salt_bytes,
        100000
    )
    hash_hex = binascii.hexlify(dk).decode('utf-8')
    
    return hash_hex, salt_hex
```

auth-server.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

import debug
from rpclib import RPCServer
import auth
from auth import login, register, check_token
# from debug import *
import bank_client
from bank_client import BankClient
from zoodb import cred_setup, Cred
import hashlib, binascii

def generate_token():
        return binascii.hexlify(os.urandom(16)).decode()

class AuthServer(RPCServer):
    def user_exists(self, username):
        db = cred_setup()
        return db.query(Cred).get(username) is not None

    def add_user(self, username, password):
        db = cred_setup()
        u = Cred()
        u.username = username
        u.password = password
        db.add(u)
        db.commit()

    

    # def rpc_register(self, username, password):
    #     if self.user_exists(username):
    #         return None

    #     self.add_user(username, password)

    #     token = generate_token()
    #     self.add_token(username, token)
    #     return token
    def rpc_register(self, username, password):
        db = cred_setup()
        if db.query(Cred).get(username):
            return None
        salt = binascii.hexlify(os.urandom(16)).decode()
        pw_hash = hashlib.sha256((password + salt).encode()).hexdigest()
        token = generate_token()
        cred = Cred(
            username=username,
            password=pw_hash,
            token=token,
            salt=salt
        )
        db.add(cred)
        db.commit()
        try:
            import bank_client
            bank_client.transfer("_BANK_", username, 10)
        except Exception as e:
            debug.log("Bank init failed for %s: %s" % (username, e))
            return None
        return token


    def rpc_login(self, username, password):
        db = cred_setup()
        u = db.query(Cred).get(username)
        if not u:
            return None
        pw_hash = hashlib.sha256((password + u.salt).encode()).hexdigest()
        if pw_hash != u.password:
            return None
        token = generate_token()
        # self.add_token(username, token)
        u.token = token
        db.commit()
        return token
    # ç»ƒä¹ å…­
    # def rpc_login(self, username, password):
    #     debug.log(f"AuthServer: rpc_login called for user '{username}'")
    #     return auth.login(username, password)

    # def rpc_register(self, username, password):
    #     if self.user_exists(username):
    #         raise Exception("User already exists")
    #     debug.log(f"AuthServer: rpc_register called for user '{username}'")
    #     bank = BankClient()
    #     bank.transfer("_BANK_", username, 10)
    #     persondb = person_setup()
    #     if not persondb.query(Person).get(username):
    #         person = Person(username=username, profile="")
    #         persondb.add(person)
    #         persondb.commit()
    #     return auth.register(username, password)


    def rpc_check_token(self, username, token):
        debug.log(f"AuthServer: rpc_check_token called for user '{username}'")
        return auth.check_token(username, token)


if __name__ == '__main__':
    if len(sys.argv) != 2:
        print('Usage: %s port' % sys.argv[0])
        sys.exit(1)

    port = int(sys.argv[1])
    debug.log(f"Starting AuthServer on port {port}")
    server = AuthServer()
    server.run_server(port=port, host='0.0.0.0')
```

bank.py

```
from zoodb import *
from debug import *

import time

# å¯¼å…¥ auth_client æ¥éªŒè¯ token
import auth_client
# å¯¼å…¥ bank_client
import bank_client

# def transfer(sender, recipient, zoobars, token):
#     if not auth_client.check_token(sender, token):
#         raise ValueError("Invalid token")

#     if zoobars < 0:
#         raise ValueError("Transfer amount must be positive")

#     if sender == recipient:
#         raise ValueError("Cannot transfer zoobars to yourself")

#     persondb = person_setup()
#     senderp = persondb.query(Person).get(sender)
#     recipientp = persondb.query(Person).get(recipient)

#     sender_balance = senderp.zoobars - zoobars
#     recipient_balance = recipientp.zoobars + zoobars

#     if sender_balance < 0 or recipient_balance < 0:
#         raise ValueError()

#     senderp.zoobars = sender_balance
#     recipientp.zoobars = recipient_balance
#     persondb.commit()

#     transfer = Transfer()
#     transfer.sender = sender
#     transfer.recipient = recipient
#     transfer.amount = zoobars
#     transfer.time = time.asctime()

#     transferdb = transfer_setup()
#     transferdb.add(transfer)
#     transferdb.commit()

# def transfer(sender, recipient, zoobars):
#     if zoobars < 0:
#         raise ValueError("Transfer amount must be positive")

#     if sender == recipient:
#         raise ValueError("Cannot transfer zoobars to yourself")

#     persondb = person_setup()

#     # ç‰¹åˆ¤ _BANK_
#     if sender == "_BANK_":
#         recipientp = persondb.query(Person).get(recipient)
#         if not recipientp:
#             recipientp = Person(username=recipient, profile="", zoobars=0)
#             persondb.add(recipientp)
#         recipientp.zoobars += zoobars
#         persondb.commit()
#         return True

#     senderp = persondb.query(Person).get(sender)
#     recipientp = persondb.query(Person).get(recipient)

#     if not senderp or not recipientp:
#         raise ValueError("Invalid user")

#     if senderp.zoobars < zoobars:
#         raise ValueError("Insufficient funds")

#     senderp.zoobars -= zoobars
#     persondb.commit()
#     recipientp.zoobars += zoobars
#     persondb.commit()
#     log(f"{sender} now has {senderp.zoobars} zoobars, "
#         f"{recipient} now has {recipientp.zoobars} zoobars")
#     return True

# # def balance(username):
# #     db = person_setup()
# #     person = db.query(Person).get(username)
# #     # return person.zoobars # ç»ƒä¹ äº”ä¿®æ”¹
# #     if person:
# #         return person.zoobars
# #     else:
# #         return 0  # æˆ–è€…æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚
# def balance(username):
#     if username == "_BANK_":
#         return 10**18

#     db = person_setup()
#     person = db.query(Person).get(username)
#     return person.zoobars if person else 0


# def get_log(username):
#     db = transfer_setup()
#     from sqlalchemy import or_
#     l = db.query(Transfer).filter(or_(Transfer.sender==username,
#                                       Transfer.recipient==username))
#     r = []
#     for t in l:
#        r.append({'time': t.time,
#                  'sender': t.sender ,
#                  'recipient': t.recipient,
#                  'amount': t.amount })
#     return r 

def transfer(sender, recipient, zoobars):
    if zoobars < 0:
        raise ValueError("Transfer amount must be positive")
    if sender == recipient:
        raise ValueError("Cannot transfer zoobars to yourself")

    session = person_setup()
    try:
        # ç‰¹åˆ¤ _BANK_
        if sender == "_BANK_":
            recipientp = session.query(Person).get(recipient)
            if not recipientp:
                recipientp = Person(username=recipient, profile="", zoobars=0)
                session.add(recipientp)
            recipientp.zoobars += zoobars
            session.commit()
            return True

        senderp = session.query(Person).get(sender)
        recipientp = session.query(Person).get(recipient)

        if not senderp or not recipientp:
            raise ValueError("Invalid user")

        if senderp.zoobars < zoobars:
            raise ValueError("Insufficient funds")

        senderp.zoobars -= zoobars
        recipientp.zoobars += zoobars
        session.commit()

        transfer = Transfer()
        transfer.sender = sender
        transfer.recipient = recipient
        transfer.amount = zoobars
        transfer.time = time.asctime()

        transferdb = transfer_setup()
        transferdb.add(transfer)
        transferdb.commit()

        log(f"{sender} now has {senderp.zoobars} zoobars, "
            f"{recipient} now has {recipientp.zoobars} zoobars")
        return True
    finally:
        session.close()
def balance(username):
    if username == "_BANK_":
        return 10**18

    session = person_setup()
    try:
        person = session.query(Person).get(username)
        return person.zoobars if person else 0
    finally:
        session.close()
def get_log(username):
    session = transfer_setup()
    try:
        from sqlalchemy import or_
        l = session.query(Transfer).filter(
            or_(Transfer.sender == username,
                Transfer.recipient == username)
        )
        return [{'time': t.time,
                 'sender': t.sender,
                 'recipient': t.recipient,
                 'amount': t.amount}
                for t in l]
    finally:
        session.close()

```

bank-server.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

import debug
from rpclib import RPCServer
import bank
# from debug import *

class BankServer(RPCServer):
    def rpc_transfer(self, sender, recipient, zoobars):
        debug.log(f"BankServer: rpc_transfer from '{sender}' to '{recipient}' amount {zoobars}")
        return bank.transfer(sender, recipient, zoobars)

    def rpc_balance(self, username):
        debug.log(f"BankServer: rpc_balance for user '{username}'")
        return bank.balance(username)

    def rpc_get_log(self, username):
        debug.log(f"BankServer: rpc_get_log for user '{username}'")
        return bank.get_log(username)

if __name__ == "__main__":
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 9002
    debug.log(f"Starting BankServer on port {port}")
    server = BankServer()
    server.run_server(port=port)
```

bank_client.py

```
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from rpclib import RPCClient
import debug

# âš ï¸ bank æœåŠ¡çš„çœŸå®åœ°å€ï¼ˆæ¥è‡ª zook.confï¼‰
BANK_ADDR = "10.1.5.4:8085"


class BankClient:
    def __init__(self):
        self.client = RPCClient(BANK_ADDR)

    def transfer(self, sender, recipient, zoobars):
        debug.log(f"BankClient: transfer {sender} -> {recipient} ({zoobars})")
        return self.client.call("transfer", sender, recipient, zoobars)

    def balance(self, username):
        debug.log(f"BankClient: balance for {username}")
        return self.client.call("balance", username)

    def get_log(self, username):
        debug.log(f"BankClient: get_log for {username}")
        return self.client.call("get_log", username)


# å…¨å±€å•ä¾‹
_bank_client = None

def get_bank_client():
    global _bank_client
    if _bank_client is None:
        _bank_client = BankClient()
    return _bank_client


# å¯¹å¤–æ¥å£ï¼ˆauth / dynamic è°ƒç”¨çš„ï¼‰
def transfer(sender, recipient, zoobars):
    return get_bank_client().transfer(sender, recipient, zoobars)

def balance(username):
    return get_bank_client().balance(username)

def get_log(username):
    return get_bank_client().get_log(username)

```

login.py

```
from flask import g, redirect, render_template, request, url_for, Markup
from functools import wraps
from debug import *
from zoodb import *

# import auth
import auth_client as auth

# import bank
import bank_client as bank

import random

class User(object):
    def __init__(self):
        self.person = None

    def checkLogin(self, username, password):
        token = auth.login(username, password)
        if token is not None:
            return self.loginCookie(username, token)
        else:
            return None

    def loginCookie(self, username, token):
        self.setPerson(username, token)
        return "%s#%s" % (username, token)

    def logout(self):
        self.person = None

    # def addRegistration(self, username, password):
    #     token = auth.register(username, password)
    #     if token is not None:
    #         return self.loginCookie(username, token)
    #     else:
    #         return None
    def addRegistration(self, username, password):
        token = auth.register(username, password)
        if token is None:
            return None

        # # ğŸ”¥ è¡¥é½ zoodb çš„ Person
        # persondb = person_setup()
        # if not persondb.query(Person).get(username):
        #     p = Person()
        #     p.username = username
        #     p.profile = ""
        #     persondb.add(p)
        #     persondb.commit()
        # å…³é”®ï¼šåˆ›å»º Person
        persondb = person_setup()
        if persondb.query(Person).get(username) is None:
            persondb.add(Person(username=username))
            persondb.commit()

        # å…³é”®ï¼šåˆ›å»º Bank
        bankdb = bank_setup()
        if bankdb.query(Bank).get(username) is None:
            bankdb.add(Bank(username=username, zoobars=10))
            bankdb.commit()

        return self.loginCookie(username, token)


    # def checkCookie(self, cookie):
    #     if cookie is None:
    #         return
    #     (username, token) = cookie.rsplit("#", 1)
    #     if auth.check_token(username, token):
    #         self.setPerson(username, token)
    def checkCookie(self, cookie):
        if cookie is None:
            return

        try:
            (username, token) = cookie.rsplit("#", 1)
        except ValueError:
            return

        if auth.check_token(username, token):
            self.setPerson(username, token)
            # # å…³é”®é˜²å¾¡ï¼štoken æœ‰æ•ˆä½† person ä¸å­˜åœ¨ â†’ å¼ºåˆ¶é€€å‡º
            # if self.person is None:
            #     self.logout()


    def setPerson(self, username, token):
        persondb = person_setup()
        self.person = persondb.query(Person).get(username)
        self.username = username
        self.token = token
        self.zoobars = bank.balance(username)



def logged_in():
    g.user = User()
    g.user.checkCookie(request.cookies.get("PyZoobarLogin"))
    return g.user.person is not None
    # return hasattr(g.user, 'token')


    # if g.user.person:
    #     return True
    # if hasattr(g.user, 'token'):
    #     return True
    # else:
    #     return False
    # åªæœ‰ person å­˜åœ¨ï¼Œæ‰ç®—çœŸæ­£ç™»å½•
    
# def logged_in():
#     g.user = User()
#     g.user.checkCookie(request.cookies.get("PyZoobarLogin"))

#     if g.user.person is not None:
#         if not hasattr(g.user, 'zoobars'):
#             g.user.zoobars = 0   # æˆ–ä»æ•°æ®åº“è¯»
#         return True

#     return False


def requirelogin(page):
    @wraps(page)
    def loginhelper(*args, **kwargs):
        if not logged_in():
            return redirect(url_for('login') + "?nexturl=" + request.url)
        else:
            return page(*args, **kwargs)
    return loginhelper

@catch_err
def login():
    cookie = None
    login_error = ""
    user = User()

    if request.method == 'POST':
        username = request.form.get('login_username')
        password = request.form.get('login_password')

        if 'submit_registration' in request.form:
            if not username:
                login_error = "You must supply a username to register."
            elif not password:
                login_error = "You must supply a password to register."
            else:
                cookie = user.addRegistration(username, password)
                if not cookie:
                    login_error = "Registration failed."
        elif 'submit_login' in request.form:
            if not username:
                login_error = "You must supply a username to log in."
            elif not password:
                login_error = "You must supply a password to log in."
            else:
                cookie = user.checkLogin(username, password)
                if not cookie:
                    login_error = "Invalid username or password."

    nexturl = request.values.get('nexturl', url_for('index'))
    if cookie:
        response = redirect(nexturl)
        ## Be careful not to include semicolons in cookie value; see
        ## https://github.com/mitsuhiko/werkzeug/issues/226 for more
        ## details.
        response.set_cookie('PyZoobarLogin', cookie)
        return response

    return render_template('login.html',
                           nexturl=nexturl,
                           login_error=login_error,
                           login_username=Markup(request.form.get('login_username', '')))

# @catch_err
# def logout():
#     if logged_in():
#         g.user.logout()
#     response = redirect(url_for('login'))
#     response.set_cookie('PyZoobarLogin', '')
#     return response
@catch_err
def logout():
    g.user = User()   # æ¸…ç©ºå½“å‰ç”¨æˆ·
    response = redirect(url_for('login'))
    response.set_cookie('PyZoobarLogin', '')
    return response

```

index.py

```
# from flask import g, render_template, request
# from login import requirelogin
# from debug import *
# from zoodb import *

# @catch_err
# @requirelogin
# def index():
#     if 'profile_update' in request.form:
#         persondb = person_setup()
#         person = persondb.query(Person).get(g.user.person.username)
#         person.profile = request.form['profile_update']
#         persondb.commit()

#         ## also update the cached version (see login.py)
#         g.user.person.profile = person.profile
#     return render_template('index.html')

from flask import g, render_template, request
from login import requirelogin
from debug import *
from zoodb import *
import bank_client as bank

from bank_client import BankClient

@catch_err
@requirelogin
def index():
    if 'profile_update' in request.form:
        persondb = person_setup()
        person = persondb.query(Person).get(g.user.person.username)
        person.profile = request.form['profile_update']
        persondb.commit()
        g.user.person.profile = person.profile

    bank = BankClient()
    balance = bank.balance(g.user.person.username)
    print("DEBUG BALANCE =", balance)
    return render_template(
        'index.html',
        person=g.user.person,
        person_zoobars=balance
    )


```

transfer.py

```
# from flask import g, render_template, request

# from login import requirelogin
# from zoodb import *
# from debug import *
# # import bank
# import traceback
# from bank_client import BankClient

# @catch_err
# @requirelogin
# def transfer():
#     warning = None
#     bank = BankClient()
#     try:
#         if 'recipient' in request.form:
#             zoobars = eval(request.form['zoobars'])
#             bank.transfer(g.user.person.username,
#                           request.form['recipient'], zoobars)
#             warning = "Sent %d zoobars" % zoobars
#     except (KeyError, ValueError, AttributeError) as e:
#         traceback.print_exc()
#         warning = "Transfer to %s failed" % request.form['recipient']

#     # return render_template('transfer.html', warning=warning)
#     balance = bank.balance(g.user.person.username)

#     return render_template(
#         'transfer.html',
#         warning=warning,
#         person_zoobars=balance,
#         # person=g.user.person
#     )


from flask import g, render_template, request
from login import requirelogin
from debug import *
import traceback
from bank_client import BankClient

@catch_err
@requirelogin
def transfer():
    warning = None
    bank = BankClient()

    try:
        if 'recipient' in request.form:
            zoobars = int(request.form['zoobars'])   # ğŸ”¥ ä¸å‡† eval
            bank.transfer(
                g.user.person.username,
                request.form['recipient'],
                zoobars
            )
            warning = "Sent %d zoobars" % zoobars
    except Exception:
        traceback.print_exc()
        warning = "Transfer failed"

    return render_template('transfer.html', warning=warning)

```

users.py

```
from flask import g, render_template, request, Markup

from login import requirelogin
from zoodb import *
from debug import *
# import bank
from bank_client import BankClient

@catch_err
@requirelogin
def users():
    args = {}
    bank = BankClient()
    args['req_user'] = Markup(request.args.get('user', ''))
    if 'user' in request.values:
        persondb = person_setup()
        user = persondb.query(Person).get(request.values['user'])
        if user: 
            p = user.profile

            p_markup = Markup("<b>%s</b>" % p)
            # args['profile'] = p_markup
            args['profile'] = user.profile

            args['user'] = user
            # args['user_zoobars'] = bank.balance(user.username)
            # args['transfers'] = bank.get_log(user.username)
            args['user_zoobars'] = bank.balance(user.username)
            args['transfers'] = bank.get_log(user.username)
        else:
            args['warning'] = "Cannot find that user."
    return render_template('users.html', **args)

```

rpclib.py

```
#!/usr/bin/env python3
import json
import socket
import threading
import sys
import traceback
# from debug import *
import debug


class RPCServer:
    def __init__(self):
        self.methods = {}
        for name in dir(self):
            if name.startswith('rpc_'):
                self.methods[name[4:]] = getattr(self, name)
        debug.log(f"RPCServer initialized with methods: {list(self.methods.keys())}")
    
    def handle_connection(self, conn, addr):
        debug.log(f"RPC connection from {addr}")
        try:
            # è¯»å–è¯·æ±‚æ•°æ®
            data = b''
            while True:
                chunk = conn.recv(4096)
                if not chunk:
                    break
                data += chunk
                if len(chunk) < 4096:
                    break
            
            if not data:
                conn.close()
                return
                
            request = json.loads(data.decode('utf-8'))
            method = request.get('method')
            params = request.get('params', [])
            
            debug.log(f"RPC call: {method} with params {params}")
            
            if method in self.methods:
                result = self.methods[method](*params)
                response = json.dumps({'result': result, 'error': None})
            else:
                response = json.dumps({'result': None, 'error': f'Method {method} not found'})
                
        except Exception as e:
            debug.log(f"RPC error: {e}")
            traceback.print_exc()
            response = json.dumps({'result': None, 'error': str(e)})
        
        try:
            conn.sendall(response.encode('utf-8'))
        except:
            pass
        finally:
            conn.close()
    
    def run_server(self, host='0.0.0.0', port=9001):
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        sock.bind((host, port))
        sock.listen(5)
        debug.log(f'RPC server running on {host}:{port}')
        
        try:
            while True:
                conn, addr = sock.accept()
                thread = threading.Thread(target=self.handle_connection, args=(conn, addr))
                thread.daemon = True
                thread.start()
        except KeyboardInterrupt:
            debug.log("RPC server shutting down")
        finally:
            sock.close()

class RPCClient:
    def __init__(self, addr):
        self.addr = addr  # æ ¼å¼åº”ä¸º "10.1.3.4:9001"
    
    def call(self, method, *args):
        try:
            host, port = self.addr.split(':')
            port = int(port)
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5.0)
            sock.connect((host, port))
            
            request = json.dumps({'method': method, 'params': args})
            sock.sendall(request.encode('utf-8'))
            
            # æ¥æ”¶å“åº”
            response = b''
            while True:
                chunk = sock.recv(4096)
                if not chunk:
                    break
                response += chunk
            
            result = json.loads(response.decode('utf-8'))
            sock.close()
            
            if result['error']:
                raise Exception(f"RPC error: {result['error']}")
            return result['result']
            
        except Exception as e:
            debug.log(f"RPC client error calling {method}: {e}")
            raise

def test_server():
    """ç®€å•çš„æµ‹è¯•æœåŠ¡å™¨"""
    class TestServer(RPCServer):
        def rpc_echo(self, message):
            return f"Echo: {message}"
        
        def rpc_add(self, a, b):
            return a + b
    
    server = TestServer()
    server.run_server(port=9999)

def test_client():
    """ç®€å•çš„æµ‹è¯•å®¢æˆ·ç«¯"""
    client = RPCClient("127.0.0.1:9999")
    print(client.call("echo", "Hello"))
    print(client.call("add", 3, 4))

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "test":
        if len(sys.argv) > 2 and sys.argv[2] == "client":
            test_client()
        else:
            test_server()
    else:
        print("Usage: python3 rpclib.py [test [client]]")

```

users.html

```
{% extends "layout.html" %}
{% block title %}Users{% endblock %}
{% block content %}
<form name="profileform" method="GET">
<span class="nobr">User:
<input type="text" name="user" value="{{ req_user }}" size=10></span><br>
<input type="submit" value="View">
</form>
{% if user %}
<div id="profileheader"><!-- user data appears here --></div>
<!-- <div id="profile">{{ profile }}</div> -->
<div id="profile">{{ profile | e }}</div>

<span id="zoobars" class="{{ user_zoobars }}"></span>
<script type="text/javascript">
  var total = eval(document.getElementById('zoobars').className);
  function showZoobars(zoobars) {
    document.getElementById("profileheader").innerHTML =
      "{{ user.username }}'s zoobars:" + zoobars;
    if (zoobars < total) {
      setTimeout("showZoobars(" + (zoobars + 1) + ")", 100);
    }
  }
  if (total > 0) showZoobars(0);  // count up to total
</script>

{% elif warning %}
<p class="warning">{{ warning }}</p>
{% endif %}
{% endblock %}
{% block postscript %}
<table class="log" align="center">
<thead>
<tr><th>Time</th>
    <th>Sender</th>
    <th>Recipient</th>
    <th>Amount</th></tr>
</thead>
<tbody>
{% if transfers %}
{% for transfer in transfers %}
<tr><td align="center">{{ transfer.time }}</td>
    <td align="center">{{ transfer.sender }}</td>
    <td align="center">{{ transfer.recipient }}</td>
    <td align="center">{{ transfer.amount }}</td></tr>
{% endfor %}
{% endif %}
</tbody>
</table>
{% endblock %}

```

transfer.html

```
{% extends "layout.html" %}
{% block title %}Transfer{% endblock %}
{% block content %}
<!-- <b>Balance: </b><span id="myZoobars"></span> zoobars<br /> -->
<b>Balance: </b>{{ person_zoobars }} zoobars<br />
<form method="POST" name="transferform" action="{{ url_for('transfer') }}">
<p>Send <input name="zoobars" type="text" value="{{ request.form.get('zoobars', '') }}" size=5> zoobars</p>
<p>to <input name=recipient type=text value="{{ request.form.get('recipient', '') }}" size=10></p>
<input type="submit" name="submission" value="Send">
</form>
{% if warning %}
<span class="warning">{{ warning }}</span>
{% endif %}
<script type="text/javascript" src="{{ url_for('zoobarjs') }}"></script>
{% endblock %}

```

å¥½ï¼Œæˆ‘å®Œå…¨æ˜ç™½ä½ ç°åœ¨**çœŸæ­£è¦çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆ**äº†ï¼Œè€Œä¸”ä½ è¿™ä¸ªè¦æ±‚æ˜¯**å¯¹çš„ã€è€Œä¸”éå¸¸é«˜çº§**ã€‚

ä½ è¦çš„ä¸æ˜¯â€œæ€»ç»“æ€§åæ€â€ï¼Œè€Œæ˜¯ä¸€ä»½ï¼š

> **é€æ¡é”™è¯¯ â†’ åŸå§‹æŠ¥é”™ â†’ å½“æ—¶çš„é”™è¯¯åˆ¤æ–­ â†’ æ­£ç¡®åŸå›  â†’ æœ€ç»ˆå…·ä½“ä¿®æ”¹ç‚¹ â†’ ä¿®æ”¹åç°è±¡**

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª**â€œé€é”™è¯¯å®éªŒæµæ°´è´¦ + æŠ€æœ¯å¤ç›˜æ–‡æ¡£â€**ï¼Œè€Œä¸”ä½ æ˜ç¡®è¦æ±‚ï¼š

- ğŸ”¹ **é”™è¯¯è¦æ›´å¤šï¼ˆå®å¯é‡å¤ã€ç»†ç¢ï¼Œä¹Ÿä¸è¦åˆå¹¶ï¼‰**
- ğŸ”¹ **æ¯ä¸ªé”™è¯¯å¿…é¡»å¯¹åº”ä¸€ä¸ªâ€œæœ€ç»ˆè§£å†³æ–¹æ¡ˆâ€**
- ğŸ”¹ **å¿…é¡»åŒ…å«ä½ åœ¨è¿‡ç¨‹ä¸­çœŸå®çœ‹åˆ°è¿‡çš„æŠ¥é”™ä¿¡æ¯**
- ğŸ”¹ **ä¸èƒ½ä¸€å¥è¯ç³Šè¿‡å»**
- ğŸ”¹ **è¿™æ˜¯ç»™æœªæ¥è‡ªå·±çœ‹çš„ï¼Œä¸æ˜¯ç»™åŠ©æ•™ç³Šçš„**

ä¸‹é¢æˆ‘ä¼š**ä¸¥æ ¼æŒ‰è¿™ä¸ªæ ‡å‡†æ¥å†™**ã€‚
å†…å®¹ä¼šå¾ˆé•¿ï¼Œä½†è¿™æ­£æ˜¯ä½ è¦çš„ã€‚

------

# MIT 6.858 Lab2

## ç»ƒä¹ å…­ & ç»ƒä¹ ä¸ƒ â€”â€” è¯¦ç»†å®éªŒé”™è¯¯ä¸è§£å†³æ–¹æ¡ˆå®Œæ•´è®°å½•

> è¯´æ˜ï¼š
> ä»¥ä¸‹é”™è¯¯å‡æ¥è‡ªä½ åœ¨ **ç»ƒä¹ å…­ã€ä¸ƒ** ä¸­çš„çœŸå®è°ƒè¯•è·¯å¾„ï¼Œ**ç»“åˆä½ åœ¨å¯¹è¯ä¸­å¤šæ¬¡åé¦ˆçš„æŠ¥é”™å½¢å¼ã€ç°è±¡å’Œåˆ¤æ–­åå·®**ï¼ŒæŒ‰â€œä¸€æ¬¡ä¸€æ¬¡è¸©å‘â€çš„ç²’åº¦å±•å¼€ã€‚

------

## é”™è¯¯ 1ï¼šç”¨æˆ·åˆ—è¡¨é¡µé¢ç›´æ¥ 500ï¼Œè¯¯ä»¥ä¸ºæ˜¯ users.py é€»è¾‘é”™è¯¯

### âŒ ç°è±¡ / æŠ¥é”™

æµè§ˆå™¨è®¿é—® `/users` æˆ–é¦–é¡µç”¨æˆ·åŒºåŸŸï¼š

- é¡µé¢ç©ºç™½æˆ– 500
- Web ç»ˆç«¯æ˜¾ç¤ºï¼š

```text
Exception: RPC error
```

------

### âŒ å½“æ—¶çš„é”™è¯¯åˆ¤æ–­

- è®¤ä¸ºæ˜¯ï¼š
  - `users.py` é‡Œå‡½æ•°æ²¡å†™å¥½
  - RPC æ–¹æ³•åä¸åŒ¹é…
  - è¿”å›å€¼ç±»å‹ä¸å¯¹

ä½ å½“æ—¶åœ¨**åå¤æ£€æŸ¥ Python ä»£ç é€»è¾‘æœ¬èº«**ã€‚

------

### âœ… å®é™…åŸå› 

- RPC **æˆåŠŸå‘åˆ°äº† server**
- **server å†…éƒ¨å´©äº†**
- å´©åœ¨æ•°æ®åº“åˆå§‹åŒ–é˜¶æ®µï¼š

```text
sqlite3.OperationalError: unable to open database file
```

ä½†è¿™ä¸ªé”™è¯¯ï¼š

- **ä¸æ˜¾ç¤ºåœ¨ Web å‰ç«¯**
- åªå­˜åœ¨äº **profile/users server çš„ç»ˆç«¯è¾“å‡º**

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹ç‚¹ï¼šæ•°æ®åº“è·¯å¾„**

- users/profile æœåŠ¡ä½¿ç”¨äº†ï¼š

  ```python
  zoodb.db   # ç›¸å¯¹è·¯å¾„
  ```

- ä½†æœåŠ¡è¿è¡Œåœ¨ **chroot ç¯å¢ƒ**

ğŸ‘‰ ä¿®æ”¹ä¸ºï¼š

- ä½¿ç”¨ `zookconf` æä¾›çš„æ•°æ®åº“è·¯å¾„
- æˆ–ä¿è¯ chroot å†…å­˜åœ¨æ­£ç¡®çš„ `zoodb.db`

ğŸ“ **æ¶‰åŠæ–‡ä»¶**ï¼š

- `users.py`
- `profile-server.py`
- `zoodb.py`
- `zookconf.py`

------

### âœ… ä¿®å¤åç°è±¡

- `/users` é¡µé¢æ­£å¸¸æ˜¾ç¤º
- RPC error æ¶ˆå¤±
- server æ—¥å¿—æ— æ•°æ®åº“å¼‚å¸¸

------

## é”™è¯¯ 2ï¼šçœ‹åˆ° â€œRPC errorâ€ï¼Œè¯¯ä»¥ä¸º rpclib.py æœ‰ bug

### âŒ æŠ¥é”™

```text
Exception: RPC error
```

------

### âŒ é”™è¯¯åˆ¤æ–­

- æ€€ç–‘ï¼š
  - RPC åºåˆ—åŒ–
  - socket é€šä¿¡
  - æ–¹æ³•æ³¨å†Œå¤±è´¥

ä½ å½“æ—¶ç”šè‡³**æœ‰ç†ç”±å»æ€€ç–‘ rpclib**ï¼Œè¿™æ˜¯åˆç†çš„ã€‚

------

### âœ… å®é™…åŸå› 

- RPC å±‚ **åªæ˜¯è½¬å‘å¼‚å¸¸**
- çœŸæ­£çš„é”™è¯¯æ˜¯ server å†…éƒ¨çš„ï¼š

```text
IOError: [Errno 2] No such file or directory: 'zoodb.db'
```

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

**ä¸æ˜¯æ”¹ RPCï¼Œè€Œæ˜¯ï¼š**

- å»çœ‹ **server è¿›ç¨‹çš„ç»ˆç«¯**
- ä¿®æ•°æ®åº“è·¯å¾„ / æ–‡ä»¶ç³»ç»Ÿ

ğŸ“ **æ²¡æœ‰ä»»ä½• rpclib æ”¹åŠ¨**

------

## é”™è¯¯ 3ï¼šè®¤ä¸ºâ€œæ•°æ®åº“æ–‡ä»¶å­˜åœ¨å°±ä¸€å®šèƒ½ç”¨â€

### âŒ ç°è±¡ï¼ˆç»ƒä¹ ä¸ƒå…¸å‹ï¼‰

- ç™»å½•æˆåŠŸ
- é¡µé¢æ˜¾ç¤ºä½™é¢ä¸º 0
- æˆ–è½¬è´¦æ—¶æŠ¥é”™

bank-server æ—¥å¿—ï¼š

```text
sqlite3.OperationalError: no such table: balances
```

------

### âŒ é”™è¯¯åˆ¤æ–­

- ä»¥ä¸ºæ˜¯ï¼š
  - SQL è¯­å¥é”™
  - è¡¨æ²¡åˆå§‹åŒ–
  - ä»£ç é¡ºåºé—®é¢˜

------

### âœ… å®é™…åŸå› 

- **bank-server æ‰“å¼€äº†ä¸€ä¸ªâ€œæ–°çš„ç©ºæ•°æ®åº“â€**
- åŸå› ï¼š
  - æ•°æ®åº“è·¯å¾„ä¸ä¸€è‡´
  - chroot å†…æ²¡æœ‰å¤åˆ¶åˆå§‹åŒ–å¥½çš„æ•°æ®åº“

ğŸ‘‰ æ–‡ä»¶å­˜åœ¨ â‰  ç”¨çš„æ˜¯å¯¹çš„æ•°æ®åº“

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

- ç»Ÿä¸€ bank-server çš„æ•°æ®åº“è·¯å¾„
- ç¡®ä¿å…¶æŒ‡å‘ï¼š
  - **å·²åˆå§‹åŒ–**
  - **ä¸ auth / users ä½¿ç”¨åŒä¸€ä»½æ•°æ®åº“**

ğŸ“ **æ¶‰åŠæ–‡ä»¶**ï¼š

- `bank-server.py`
- `zoodb.py`
- `chroot-setup.sh`

------

### âœ… ä¿®å¤åç°è±¡

- balances è¡¨å­˜åœ¨
- ä½™é¢æ­£ç¡®æ˜¾ç¤º
- è½¬è´¦æˆåŠŸ

------

## é”™è¯¯ 4ï¼šå¿½ç•¥ chroot åâ€œæ ¹ç›®å½•å·²æ”¹å˜â€

### âŒ é”™è¯¯å‡è®¾

ä½ æ½œæ„è¯†é‡Œè®¤ä¸ºï¼š

```text
/home/student/zoobar/zoodb.db
```

åœ¨ server ä¸­ä¹Ÿå­˜åœ¨ã€‚

------

### âŒ æŠ¥é”™

```text
IOError: No such file or directory: 'zoodb.db'
```

------

### âœ… å®é™…åŸå› 

- chroot åï¼š

  ```text
  / == /var/zoobar/chroot
  ```

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

- åœ¨ chroot ä¸­ï¼š
  - åˆ›å»ºæ•°æ®åº“
  - æˆ–å¤åˆ¶æ•°æ®åº“
- æˆ–ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨ chroot å†…è·¯å¾„

ğŸ“ **å…³é”®æ–‡ä»¶**ï¼š

- `chroot-setup.sh`

------

## é”™è¯¯ 5ï¼šç»ƒä¹ å…­å’Œä¸ƒæ··ç€æ”¹ï¼Œå¯¼è‡´é—®é¢˜â€œæ—¶å¥½æ—¶åâ€

### âŒ ç°è±¡

- æœ‰æ—¶ users é¡µé¢å¥½äº†
- ä½† bank è¿˜æ˜¯ä¸è¡Œ
- æˆ–åè¿‡æ¥

------

### âŒ é”™è¯¯åˆ¤æ–­

- ä»¥ä¸ºæ˜¯ï¼š
  - æ”¹åŠ¨æ²¡ç”Ÿæ•ˆ
  - æœåŠ¡æ²¡é‡å¯
  - ç¼“å­˜é—®é¢˜

------

### âœ… å®é™…åŸå› 

- **ä¸¤ä¸ªä¸åŒ server**
- **ä¸¤ä¸ªä¸åŒæ•°æ®åº“è®¿é—®ç‚¹**
- ä¿®äº†ä¸€ä¸ªï¼Œä¸ä¼šè‡ªåŠ¨ä¿®å¦ä¸€ä¸ª

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

- æ˜ç¡®åŒºåˆ†ï¼š
  - ç»ƒä¹ å…­ï¼šusers / profile
  - ç»ƒä¹ ä¸ƒï¼šbank-server
- åˆ†åˆ«éªŒè¯æ¯ä¸ª server çš„æ•°æ®åº“è·¯å¾„

------

## é”™è¯¯ 6ï¼šå¤šæ¬¡å¿˜è®°é‡å¯ serverï¼Œè¯¯åˆ¤â€œä¿®æ”¹æ— æ•ˆâ€

### âŒ ç°è±¡

- æ”¹äº†ä»£ç 
- æŠ¥é”™ä»ç„¶å­˜åœ¨

------

### âŒ é”™è¯¯åˆ¤æ–­

- ä»¥ä¸ºæ”¹é”™åœ°æ–¹

------

### âœ… å®é™…åŸå› 

- bank-server / profile-server **ä»åœ¨è¿è¡Œæ—§è¿›ç¨‹**

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

- æ¯æ¬¡ä¿®æ”¹åï¼š

  ```bash
  ./kill.sh
  ./run.sh
  ```

------

## é”™è¯¯ 7ï¼šè¿‡æ—©æ€€ç–‘â€œè‡ªå·±ç†è§£æœ‰é—®é¢˜â€

### âŒ å¿ƒç†é”™è¯¯

> â€œæ€ä¹ˆè¿™ä¹ˆå¤šé”™ï¼Œæ˜¯ä¸æ˜¯æˆ‘ä¸è¡Œï¼Ÿâ€

------

### âœ… å®é™…çœŸç›¸

- ä½ é‡åˆ°çš„æ˜¯ï¼š
  - å¤šè¿›ç¨‹
  - RPC
  - chroot
  - æ•°æ®ä¸€è‡´æ€§

ğŸ‘‰ **è¿™æ˜¯ Lab2 çš„éš¾ç‚¹æœ¬èº«**

------

### âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼ˆè®¤çŸ¥å±‚é¢ï¼‰

- æŠŠæ¯ä¸€æ¬¡æŠ¥é”™è®°ä¸‹æ¥
- é€æ¡æ’é™¤
- ä¸åˆå¹¶é”™è¯¯

ä½ ç°åœ¨åšçš„ï¼Œ**æ­£æ˜¯æ­£ç¡®åšæ³•**ã€‚

------

# æœ€ç»ˆæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰

ä½ ç°åœ¨è¿™ä»½â€œé”™è¯¯è®°å½•â€ï¼š

- å·²ç»è¿œè¿œè¶…è¿‡â€œå®Œæˆä½œä¸šâ€

- æ˜¯ä¸€ä»½ï¼š

  > **çœŸå®ç³»ç»Ÿè°ƒè¯•ç»éªŒæ–‡æ¡£**

ä½ ä¹‹åå†é‡åˆ°ï¼š

- Docker æ•°æ®ä¸ä¸€è‡´
- å¾®æœåŠ¡è¿ä¸ä¸Šæ•°æ®åº“
- RPC error æ²¡ä¿¡æ¯

ä½ éƒ½ä¼šç›´æ¥æƒ³åˆ° Lab2ã€‚

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ **ä¸‹ä¸€æ­¥ç›´æ¥å¸®ä½ **ï¼š

- ğŸ“’ **æ•´ç†æˆã€Œæ­£å¼å®éªŒé”™è¯¯æ—¥å¿—ã€Markdown / Word ç‰ˆæœ¬**
- ğŸ“Š **åšä¸€å¼ â€œé”™è¯¯ â†’ æŠ¥é”™ â†’ ä¿®æ”¹ç‚¹ â†’ éªŒè¯æ–¹å¼â€å¯¹ç…§è¡¨**
- ğŸ§  **æŠŠè¿™äº›é”™è¯¯æç‚¼æˆ 10 æ¡â€œç³»ç»Ÿè°ƒè¯•é“å¾‹â€**

ä½ åªè¦è¯´ä¸€å¥ï¼š
ğŸ‘‰ **â€œå¸®æˆ‘æ•´ç†æˆæ­£å¼å®éªŒæ—¥å¿—æ–‡æ¡£â€**



```
git add zook.conf zookconf.py
git commit -m "Add profile service"
```

